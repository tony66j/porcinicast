<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TrovaPorcini (v0.9)</title>
<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
<style>
  body{margin:0;background:#0b1020;color:#e6eaf5;font:16px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{display:flex;align-items:center;gap:.75rem;padding:14px 18px;border-bottom:1px solid #1a2238}
  .logo{font-weight:700;font-size:1.1rem}
  .tabs{display:flex;gap:.5rem;margin-left:auto}
  .tab{padding:8px 12px;border:1px solid #1a2238;border-radius:8px;cursor:pointer;opacity:.8}
  .tab.active{background:#16203a;opacity:1}
  main{max-width:1100px;margin:18px auto;padding:0 16px}
  .card{background:#111832;border:1px solid #1a2238;border-radius:12px;padding:16px;margin-bottom:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row > *{flex:1 1 280px}
  input,select,button{font:inherit}
  input,select{background:#0e1427;color:#e6eaf5;border:1px solid #27304b;border-radius:10px;padding:10px 12px;width:100%}
  button{background:#2eb881;color:#0b1020;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  button.alt{background:#223355;color:#c7d2fe}
  .meter{height:10px;background:#1e263e;border-radius:999px;overflow:hidden;margin-top:8px}
  .meter > div{height:100%}
  .s0{background:#ff6b6b}.s1{background:#f59e0b}.s2{background:#22c55e}
  #map{height:560px;border-radius:12px;border:1px solid #1a2238}
  small.muted{color:#9aa4c7}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
  .k{font-size:.92rem}
  .badge{display:inline-block;background:#1e293b;padding:4px 10px;border-radius:999px}
</style>
</head>
<body>
<header>
  <div>üçÑ</div><div class="logo">TrovaPorcini</div>
  <div class="tabs">
    <div class="tab active" data-tab="search">Ricerca</div>
    <div class="tab" data-tab="map">Mappa</div>
  </div>
</header>

<main>

<!-- Ricerca -->
<section id="tab-search">
  <div class="card">
    <div class="row">
      <div>
        <label>Localit√†</label>
        <input id="place" placeholder="es. Bocca della Selva">
      </div>
      <div>
        <label>Coordinate (lat,lon) ‚Äì incolla come da Google</label>
        <input id="coords" placeholder="41,4170010, 14,4707168">
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div><button id="btn">Calcola idoneit√†</button></div>
      <div><button class="alt" id="clear">Pulisci</button></div>
      <div style="flex:2 1 auto"><small class="muted">La barra coord. ha priorit√†; accetta virgola decimale e formati Google.</small></div>
    </div>
  </div>

  <div class="card" id="out" style="display:none">
    <div class="row">
      <div style="flex:2">
        <div style="font-size:2.4rem;font-weight:800" id="score">‚Äî</div>
        <div class="badge" id="badge">‚Äî</div>
        <div class="meter"><div id="meterbar" style="width:0%"></div></div>
        <div style="margin-top:8px" id="why"> </div>
      </div>
      <div style="flex:3">
        <div class="grid k">
          <div><b>Quota</b>: <span id="elev"></span></div>
          <div><b>Pendenza</b>: <span id="slope"></span></div>
          <div><b>Esposizione</b>: <span id="aspect"></span></div>
          <div><b>Bosco</b>: <span id="forest"></span></div>
          <div><b>P14</b>: <span id="p14"></span></div>
          <div><b>API*</b>: <span id="api"></span></div>
          <div><b>Tmed 7g</b>: <span id="tmean"></span></div>
          <div><b>ET0 7g</b>: <span id="et0"></span></div>
          <div><b>Umi ora</b>: <span id="hum"></span></div>
          <div><b>Pioggia 24h</b>: <span id="r24"></span></div>
          <div><b>Finestra</b>: <span id="window"></span></div>
          <div><b>Confidenza</b>: <span id="conf"></span></div>
        </div>
      </div>
    </div>
    <div style="margin-top:8px" id="whyf"><small class="muted"></small></div>
    <details style="margin-top:10px"><summary><b>Perch√©?</b></summary>
      <ul id="reasons"></ul>
    </details>
  </div>
</section>

<!-- Mappa -->
<section id="tab-map" style="display:none">
  <div class="card">
    <div class="row">
      <div style="max-width:260px">
        <label>Giorno</label>
        <select id="day">
          <option value="0">Oggi</option>
          <option value="1">D+1</option>
          <option value="2">D+2</option>
          <option value="3">D+3</option>
          <option value="4">D+4</option>
          <option value="5">D+5</option>
          <option value="6">D+6</option>
          <option value="7">D+7</option>
          <option value="8">D+8</option>
          <option value="9">D+9</option>
          <option value="10">D+10</option>
        </select>
      </div>
      <div><button id="reload">Aggiorna mappa</button></div>
      <div style="flex:2 1 auto"><small class="muted">La mappa mostra SOLO punti boschivi (OSM) in Italia, colorati per idoneit√†.</small></div>
    </div>
  </div>
  <div class="card">
    <div id="map"></div>
  </div>
</section>

</main>

<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<script>
const $ = s=>document.querySelector(s);

// API base (Netlify fa da proxy /api -> Render)
const API = {
  geocode: q => fetch('/api/geocode?q='+encodeURIComponent(q)).then(okjson),
  score  : (lat,lon)=>fetch('/api/score?lat='+lat+'&lon='+lon).then(okjson),
  forest : (bbox,day)=>fetch('/api/score_forest_points?bbox='+bbox+'&day='+day).then(okjson),
};

async function okjson(r){
  if(!r.ok){
    const t = await r.text();
    throw new Error(`API ${r.status}: ${t.substring(0,120)}`);
  }
  return r.json();
}

// Parser coordinate compatibile Google e virgola decimale
function parseCoords(raw){
  if(!raw) return null;
  let s = raw.trim();
  s = s.replace(/(\d),(\d)/g, '$1.$2');      // 41,417 -> 41.417
  const parts = s.split(/[;\s,]+/).filter(Boolean);
  const nums = [];
  for(const p of parts){
    const v = parseFloat(p);
    if(isFinite(v)) nums.push(v);
    if(nums.length===2) break;
  }
  if(nums.length!==2) return null;
  const [lat,lon]=nums;
  if(Math.abs(lat)>90||Math.abs(lon)>180) return null;
  return {lat,lon};
}

function labelScore(s){ if(s>=75) return ["Consigliato","s2"]; if(s>=60) return ["Moderato","s1"]; if(s>=50) return ["Incerto","s1"]; return ["Sconsigliato","s0"]; }

async function runSearch(){
  try{
    $("#out").style.display="none";
    let c = parseCoords($("#coords").value);
    if(!c){
      const q = $("#place").value.trim();
      if(!q){ alert("Inserisci localit√† o coordinate."); return; }
      const g = await API.geocode(q); c={lat:g.lat,lon:g.lon};
    }
    const d = await API.score(c.lat,c.lon);

    // KPI
    $("#elev").textContent = Math.round(d.elevation_m)+" m";
    $("#slope").textContent = d.slope_deg.toFixed(1)+"¬∞";
    $("#aspect").textContent = d.aspect_octant;
    $("#forest").textContent = d.forest;
    $("#p14").textContent = d.P14_mm.toFixed(1);
    $("#api").textContent = d.API_star_mm.toFixed(1);
    $("#tmean").textContent = d.Tmean7_c.toFixed(1);
    $("#et0").textContent = d.ET0_7d_mm? d.ET0_7d_mm.toFixed(1): "‚Äî";
    $("#hum").textContent = d.humidity_now ?? "‚Äî";
    $("#r24").textContent = d.rain24h_forecast_mm!=null? d.rain24h_forecast_mm.toFixed(1): "‚Äî";
    $("#conf").textContent = Math.round((d.confidence||0.8)*100)+"%";

    // score + barra
    $("#score").textContent = d.score_today;
    const [lbl,cls]=labelScore(d.score_today);
    $("#badge").textContent = lbl+" oggi";
    const mb=$("#meterbar"); mb.style.width=Math.min(100,Math.max(0,d.score_today))+"%"; mb.className=cls;

    // spiegazioni
    $("#why").textContent = d.explanation?.today || "";
    $("#reasons").innerHTML = (d.explanation?.reasons||[]).map(x=>`<li>${x}</li>`).join("");
    const bw=d.best_window; $("#window").textContent = bw? `D+${bw.start} ‚Üí D+${bw.end} (media ${bw.mean})`:"‚Äî";
    $("#whyf").textContent = d.explanation?.forecast || "";

    $("#out").style.display="block";
  }catch(e){ alert("Errore: "+e.message); }
}

$("#btn").addEventListener("click", runSearch);
$("#clear").addEventListener("click", ()=>{ $("#place").value=""; $("#coords").value=""; $("#out").style.display="none"; });

// Tabs
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const id=t.dataset.tab;
    $("#tab-search").style.display = id==="search" ? "block" : "none";
    $("#tab-map").style.display    = id==="map" ? "block" : "none";
    if(id==="map") initMapOnce();
  });
});

// MAPPA ITALIA ‚Äì punti boschivi colorati
let map, mapReady=false, srcId="forestScores";
const IT_BOUNDS = [[36.5,6.5],[47.5,19.0]];

function initMapOnce(){
  if(mapReady) return;
  map = new maplibregl.Map({
    container:'map',
    style:'https://demotiles.maplibre.org/style.json',
    center:[12.5,42.5], zoom:5.2,
    maxBounds: IT_BOUNDS
  });
  map.addControl(new maplibre-gl.NavigationControl(), 'top-right');
  map.on('load', ()=>{ mapReady=true; loadForestPoints(); });
  $("#reload").addEventListener("click", loadForestPoints);
}

async function loadForestPoints(){
  if(!mapReady) return;
  const b = map.getBounds();
  const south = Math.max(b.getSouth(), IT_BOUNDS[0][0]);
  const west  = Math.max(b.getWest(),  IT_BOUNDS[0][1]);
  const north = Math.min(b.getNorth(), IT_BOUNDS[1][0]);
  const east  = Math.min(b.getEast(),  IT_BOUNDS[1][1]);
  const bbox = [south, west, north, east].map(x=>x.toFixed(4)).join(",");
  const day = +$("#day").value;

  const geo = await API.forest(bbox, day);

  if(map.getSource(srcId)){
    try{ map.removeLayer("fs"); }catch(e){}
    try{ map.removeSource(srcId); }catch(e){}
  }
  map.addSource(srcId, {type:'geojson', data:geo});
  map.addLayer({
    id:"fs", type:"circle", source:srcId,
    paint:{
      "circle-radius": 6,
      "circle-color":[
        "case",
        [">=",["get","score"],75], "#22c55e",
        [">=",["get","score"],60], "#f59e0b",
                                  "#ff6b6b"
      ],
      "circle-opacity":0.9,
      "circle-stroke-width":0.3,
      "circle-stroke-color":"#0b1020"
    }
  });
}
</script>
</body>
</html>

