<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TrovaPorcini v4.2</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root{--bg:#0f1520;--card:#121a26;--muted:#8aa0b5;--acc:#1dd675;--warn:#ffd166;--bad:#ff5c5c;}
  body{margin:0;background:var(--bg);color:#e6edf5;font-family:system-ui,Segoe UI,Roboto,Ubuntu,sans-serif}
  .wrap{max-width:1150px;margin:24px auto;padding:0 14px}
  h1{display:flex;align-items:center;gap:.6rem;font-size:1.4rem;margin:0 0 18px}
  .ver{background:#243144;border:1px solid #314059;color:#b6c6d8;padding:.15rem .5rem;border-radius:.5rem}
  .by{font-size:.9rem;color:var(--muted)}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
  .card{background:var(--card);border:1px solid #1f2b3b;border-radius:12px;padding:14px}
  label{font-size:.9rem;color:var(--muted)}
  input{width:100%;padding:10px 12px;margin-top:6px;border-radius:10px;border:1px solid #2a3a50;background:#0c121b;color:#e6edf5}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{background:#1a2636;color:#e6edf5;border:1px solid #2a3a50;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn.acc{background:var(--acc);color:#00160b;border:none}
  .kpi{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
  .chip{background:#0e1621;border:1px solid #243144;border-radius:999px;padding:.35rem .7rem;font-size:.92rem}
  .chip.bad{background:#2b1010;border-color:#531919}
  .chip.warn{background:#2a240c;border-color:#534519}
  .chip.good{background:#0d2418;border-color:#1d5435}
  .slider{width:100%;margin:10px 0}
  .sec{margin-top:10px}
  details{margin:8px 0}
  small.mono{font-family:ui-monospace,Consolas,monospace;color:#a9bfd3}
  #map{height:420px;border-radius:12px;border:1px solid #1f2b3b}
  @media (max-width:900px){.grid{grid-template-columns:1fr} #map{height:360px}}
</style>
</head>
<body>
<div class="wrap">
  <h1>üçÑ TrovaPorcini <span class="ver">v4.2</span> <span class="by">by Antonio Pio D‚ÄôAloia</span></h1>

  <div class="card">
    <div class="row">
      <div style="flex:1">
        <label>Localit√†</label>
        <input id="q" placeholder="es. Bocca della Selva"/>
      </div>
      <div style="flex:1">
        <label>Coordinate (lat,lon)</label>
        <input id="coords" placeholder="es. 41,41948, 14,47275 (anche formato Google)"/>
      </div>
      <button id="go" class="btn acc">Calcola</button>
      <button id="clear" class="btn">Pulisci</button>
    </div>
  </div>

  <div class="grid">
    <div class="card" id="left">
      <div class="kpi">
        <span id="dateChip" class="chip">Indice: ‚Äî</span>
        <span id="idxChip"  class="chip">‚Äî</span>
        <span id="capsChip" class="chip">Stima 3h: ‚Äî cappelli</span>
        <span id="rainChip" class="chip">Pioggia: ‚Äî mm</span>
      </div>

      <div class="sec">
        <label>Previsione (prossimi 10 giorni)</label>
        <input id="day" class="slider" type="range" min="0" max="9" value="0">
      </div>

      <details open class="sec">
        <summary><b>Consigli pratici</b> (cambiano per il giorno selezionato)</summary>
        <div id="tips">‚Äî</div>
      </details>

      <details class="sec">
        <summary><b>Perch√© questa stima</b></summary>
        <div id="why">‚Äî</div>
      </details>

      <details class="sec">
        <summary><b>Specie di porcini probabili</b></summary>
        <div id="species">Pinus/Abies/Picea (stima)</div>
      </details>

      <details class="sec">
        <summary><b>Dati tecnici</b></summary>
        <small class="mono" id="tech">‚Äî</small>
      </details>
    </div>

    <div class="card">
      <div id="map"></div>
      <div style="margin-top:8px;color:var(--muted);font-size:.85rem">
        Legenda cerchio: colore = indice del giorno selezionato.
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const api = "/api"; // Netlify redirect -> Render
const $ = (id)=>document.getElementById(id);
const dayEl = $("day");
let state = null; // ultimo JSON

function parseLatLon(s){
  const s2 = s.replace(/,/g,"."); // virgole italiane -> punto
  const m = s2.match(/([-+]?\d+(?:\.\d+)?)[^\d-+]+([-+]?\d+(?:\.\d+)?)/);
  if(!m) return null;
  return {lat: parseFloat(m[1]), lon: parseFloat(m[2])};
}

function idxColor(idx){
  if(idx>=70) return "good";
  if(idx>=50) return "warn";
  return "bad";
}

let map, marker, circ;
function ensureMap(){
  if(map) return;
  map = L.map('map',{zoomControl:true, attributionControl:true});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom: 17, minZoom: 5
  }).addTo(map);
}
function updateMap(lat, lon, idx){
  ensureMap();
  map.setView([lat,lon], 12);
  if(!marker){ marker = L.marker([lat,lon]).addTo(map); }
  else marker.setLatLng([lat,lon]);
  if(circ) map.removeLayer(circ);
  const col = idx>=70 ? "#12d670" : idx>=50 ? "#ffd166" : "#ff6b6b";
  circ = L.circle([lat,lon], {radius:1200, color:col, fillColor:col, fillOpacity:0.25}).addTo(map);
}

function chip(el, text, cls){ el.className = `chip ${cls||""}`; el.textContent = text; }

function renderDay(d){
  if(!state) return;
  const idx = state.daily.idx[d];
  const [lo,hi] = state.daily.caps[d];
  const rain = state.daily.rain[d].p14_mm;
  const date = new Date(state.series.dates[13+d]).toLocaleDateString('it-IT');

  $("dateChip").textContent = `D+${d} ‚Äî ${date}`;
  chip($("idxChip"), `Indice: ${idx}`, idxColor(idx));
  $("capsChip").textContent = `Stima 3h: ${lo}‚Äì${hi} cappelli`;
  $("rainChip").textContent = `Pioggia (ult.14gg): ${rain} mm`;

  $("tips").textContent = state.daily.tips[d];
  $("why").textContent = state.daily.why[d];

  const t = state.terrain, m = state.meta;
  $("species").textContent = t.forest;
  $("tech").textContent = JSON.stringify({
    lat: state.coords.lat, lon: state.coords.lon,
    elev_m: t.elev_m, slope_deg: t.slope_deg, aspect: t.aspect_oct,
    P14_mm: m.p14_mm, Tmean7_c: m.tmean7_c,
    last_rain_days: m.last_rain_days,
    next_rain_in_days: m.next_rain_in_days,
    next_rain_10d_mm: m.next_rain_10d_mm,
    source: m.source
  }, null, 2);

  updateMap(state.coords.lat, state.coords.lon, idx);
}

async function fetchJSON(url, params){
  const r = await fetch(url + (params ? ("?" + new URLSearchParams(params)) : ""));
  if(!r.ok){
    const txt = await r.text();
    throw new Error(`API ${r.status}: ${txt||r.statusText}`);
  }
  return await r.json();
}

async function geocode(q){
  return await fetchJSON(`${api}/geocode`, {q});
}

async function score(params){
  return await fetchJSON(`${api}/score`, params);
}

$("go").onclick = async ()=>{
  try{
    const q = $("q").value.trim();
    const c = $("coords").value.trim();
    let params = {};
    if(c){
      const p = parseLatLon(c);
      if(!p) throw new Error("Coordinate non riconosciute");
      params = {lat:p.lat, lon:p.lon};
    }else if(q){
      const g = await geocode(q);
      params = {lat:g.lat, lon:g.lon};
    }else{
      alert("Errore: inserisci localit√† o coordinate"); return;
    }
    const data = await score(params);
    state = data;
    dayEl.value = 0;
    renderDay(0);
  }catch(e){
    alert(e.message.includes("API") ? e.message : ("Errore: " + e.message));
  }
};

$("clear").onclick = ()=>{
  $("q").value = ""; $("coords").value = ""; state=null;
  $("dateChip").textContent="Indice: ‚Äî";
  $("idxChip").textContent="‚Äî";
  $("capsChip").textContent="Stima 3h: ‚Äî cappelli";
  $("rainChip").textContent="Pioggia: ‚Äî mm";
  $("tips").textContent = $("why").textContent = $("tech").textContent = "‚Äî";
};

dayEl.oninput = ()=> renderDay(parseInt(dayEl.value,10));
</script>
</body>
</html>




