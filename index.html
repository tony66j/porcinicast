<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Trova Porcini — by Antonio Pio D’Aloia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{--bg:#0c1222;--panel:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--accent:#10b981;--accent2:#22d3ee;--border:#1f2937;--warn:#f9a825;--bad:#ef4444;}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0f172a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    header{padding:14px 16px;border-bottom:1px solid var(--border);background:rgba(15,23,42,.6);backdrop-filter:blur(8px)}
    h1{margin:0;font-size:1.35rem}
    main{max-width:1120px;margin:18px auto;padding:0 16px}
    .card{background:linear-gradient(180deg,#0b1220,#0f172a);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-bottom:14px}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    input,button{border-radius:10px;border:1px solid #334155;background:#0b1324;color:var(--text);padding:10px 12px;font-size:15px}
    button{background:linear-gradient(90deg,var(--accent2),var(--accent));border:none;cursor:pointer;color:#062f2a;font-weight:700}
    .muted{color:var(--muted);font-size:13px}
    .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .metric{background:#0b1324;border:1px solid #243244;border-radius:10px;padding:10px;text-align:center}
    .metric .val{font-size:1.6rem;font-weight:800}
    #map{height:460px;border-radius:12px;overflow:hidden}
    .calendar{display:grid;grid-template-columns:repeat(10,1fr);gap:4px;margin-top:8px}
    .bar{height:100px;position:relative;background:#1f2937;border-radius:6px}
    .bar>i{position:absolute;bottom:0;left:0;width:100%;border-radius:6px}
    .bar>span{position:absolute;top:-18px;left:0;width:100%;text-align:center;font-size:.7rem}
    details{background:#0b1324;border:1px solid #1f2937;border-radius:10px;padding:10px}
    summary{cursor:pointer;color:#a5b4fc}
  </style>
</head>
<body>
<header>
  <h1>Trova Porcini — by Antonio Pio D’Aloia</h1>
  <div class="muted">Modello previsionale avanzato con dati storici e forecast (Open-Meteo + opz. OpenWeather)</div>
</header>

<main>
  <div class="card">
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="place" placeholder="Località (es. Abbadia San Salvatore)" style="flex:1">
      <button id="btnPlace">Cerca</button>
      <input id="coords" placeholder="oppure coordinate: 41.127, 14.782" style="flex:1;min-width:260px">
      <button id="btnCoords" style="background:linear-gradient(90deg,#f59e0b,#22d3ee)">Usa coordinate</button>
    </div>
    <div class="muted" style="margin-top:6px">Suggerimento: click destro in Google Maps → copia coordinate → incolla qui.</div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <div class="metrics">
          <div class="metric"><div class="muted">Indice</div><div id="mIndex" class="val">—</div></div>
          <div class="metric"><div class="muted">Stima raccolto (2 h)</div><div id="mHarvest" class="val">—</div></div>
          <div class="metric"><div class="muted">Affidabilità</div><div id="mRel" class="val">—</div></div>
        </div>
        <div class="muted" style="margin-top:10px">Previsione indice (10 giorni)</div>
        <div id="fc" class="calendar"></div>
      </div>

      <div class="card">
        <details open>
          <summary>Specifiche tecniche (fattori usati)</summary>
          <ul class="muted" style="margin-left:18px">
            <li>Latitudine/longitudine, quota, pendenza, esposizione</li>
            <li>Piogge P7/P14, API* (decadimento ~8 gg) e ET₀ 7 gg</li>
            <li>Temperatura media/min/max (ultimi 7–15 giorni)</li>
            <li>Umidità relativa (ora, opzionale), probabilità pioggia 72 h</li>
            <li>Affidabilità da dispersione previsione vs storico</li>
          </ul>
        </details>
        <details open>
          <summary>Consigli utili del giorno</summary>
          <ul id="tips" style="margin-left:18px"></ul>
        </details>
        <details>
          <summary>Perché questa stima?</summary>
          <ul id="why" style="margin-left:18px"></ul>
        </details>
      </div>
    </div>

    <div class="card"><div id="map"></div></div>
  </div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API = "/api";
const $ = (s)=>document.querySelector(s);
let map, marker;

function initMap(){
  map = L.map('map').setView([42.5,12.5], 6);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);
  marker = L.marker([42.5,12.5]).addTo(map);
  setTimeout(()=>map.invalidateSize(), 200);
  map.on("click", e => runCoords(e.latlng.lat, e.latlng.lng));
}

function parseCoords(str){
  const m=/^\s*([+-]?\d+(?:[.,]\d+)?)\s*[,;\s]\s*([+-]?\d+(?:[.,]\d+)?)\s*$/.exec((str||"").trim());
  if(!m) return null;
  const lat=parseFloat(m[1].replace(",", ".")), lon=parseFloat(m[2].replace(",", "."));
  if(!isFinite(lat)||!isFinite(lon)||lat<-90||lat>90||lon<-180||lon>180) return null;
  return {lat,lon};
}

async function getJSON(u){
  const r = await fetch(u);
  if(!r.ok){
    let msg="errore di rete";
    try{ msg = (await r.text()) || msg; }catch{}
    throw new Error(msg);
  }
  return r.json();
}
async function geocode(q){ return getJSON(`${API}/geocode?q=${encodeURIComponent(q)}`); }
async function score(lat,lon){ return getJSON(`${API}/score?lat=${lat}&lon=${lon}`); }

function setMetrics(s){
  $("#mIndex").textContent = s.score_today ?? "—";
  $("#mHarvest").textContent = s.harvest_estimate ?? "—";
  $("#mRel").textContent = s.reliability!=null ? Math.round(s.reliability*100)+"%" : "—";
}
function setForecast(arr){
  const fc=$("#fc"); fc.innerHTML="";
  (arr||[]).forEach(v=>{
    const bar=document.createElement("div"); bar.className="bar";
    const fill=document.createElement("i");
    const h=Math.max(4, v); fill.style.height=h+"%";
    fill.style.background= v>=70 ? "#10b981" : v>=55 ? "#f59e0b" : "#ef4444";
    const lab=document.createElement("span"); lab.textContent=v;
    bar.appendChild(fill); bar.appendChild(lab); fc.appendChild(bar);
  });
}
function setLists(reasons, tips){
  const wl=$("#why"); wl.innerHTML=""; (reasons||[]).forEach(t=>{const li=document.createElement("li"); li.textContent=t; wl.appendChild(li);});
  const tl=$("#tips"); tl.innerHTML=""; (tips||[]).forEach(t=>{const li=document.createElement("li"); li.textContent=t; tl.appendChild(li);});
}

async function runPlace(){
  const q=$("#place").value.trim(); if(!q){alert("Inserisci una località"); return;}
  try{
    const g=await geocode(q);
    await runCoords(g.lat, g.lon);
  }catch(e){ console.error(e); alert("Errore durante il geocoding. Prova con le coordinate (lat, lon)."); }
}

async function runCoordsStr(){
  const c=parseCoords($("#coords").value); if(!c){alert("Coordinate non valide. Esempio: 41.127, 14.782"); return;}
  await runCoords(c.lat, c.lon);
}

async function runCoords(lat,lon){
  marker.setLatLng([lat,lon]); map.setView([lat,lon], 11);
  try{
    const s=await score(lat,lon);
    setMetrics(s); setForecast(s.scores_next10); setLists(s.explanation?.reasons, s.tips);
  }catch(e){ console.error(e); alert("Errore durante il calcolo. Riprova più tardi."); }
}

$("#btnPlace").addEventListener("click", runPlace);
$("#btnCoords").addEventListener("click", runCoordsStr);
document.addEventListener("keydown",(e)=>{ if(e.key==="Enter") runPlace(); });

initMap();
</script>
</body>
</html>

