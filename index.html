<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PorciniCast - Mappa e Previsioni Avanzate</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        :root { /* Stessa palette di colori di prima */
            --bg-color: #f4f7f6; --card-bg: #ffffff; --text-color: #333;
            --primary: #8a6d3b; --primary-light: #fcf8e3; --shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); }
        header { background-color: var(--primary); color: white; text-align: center; padding: 20px; box-shadow: var(--shadow); }
        header h1 { margin: 0; font-size: 2.5rem; }
        main { max-width: 1400px; margin: 30px auto; padding: 0 20px; display: flex; gap: 20px; flex-wrap: wrap-reverse; }
        .controls-container { flex: 1; min-width: 320px; display: flex; flex-direction: column; gap: 20px; }
        .map-container { flex: 2; min-width: 400px; min-height: 500px; background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); }
        #map { width: 100%; height: 100%; border-radius: 12px; z-index: 1; }
        .search-box { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); }
        .search-box h2 { margin-top: 0; color: var(--primary); font-size: 1.2rem; }
        form { display: flex; gap: 10px; }
        input[type="text"] { flex-grow: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        button { padding: 12px 20px; background-color: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.2s; }
        #loading { text-align: center; font-size: 1.2rem; color: var(--primary); display: none; margin: 20px; }
        #results-area { display: flex; flex-direction: column; gap: 20px; display: none; }
        .result-card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: var(--shadow); }
        .result-card h3 { margin-top: 0; color: var(--primary); }
        #score-display { text-align: center; }
        #score-value { font-size: 4rem; font-weight: bold; line-height: 1; }
        #location-name { font-weight: normal; font-size: 1rem; color: #777; margin-top: 10px; }
        #harvest-estimate { font-size: 1.2rem; color: var(--primary); font-weight: bold; text-align: center; margin-top: 15px; }
        /* Stili aggiuntivi per i consigli e i grafici */
        .chart-container { display: flex; align-items: flex-end; justify-content: space-between; height: 100px; padding: 10px 0; }
        .chart-bar { flex: 1; background-color: var(--primary-light); text-align: center; position: relative; border: 1px solid #eee; margin: 0 1px; }
        .chart-bar .value { font-size: 0.8rem; font-weight: bold; color: var(--primary); }
        #advice-list { list-style: none; padding-left: 0; }
    </style>
</head>
<body>
    <header>
        <h1>üçÑ PorciniCast</h1>
        <p>Mappa e Previsioni Scientifiche per la Ricerca dei Funghi Porcini</p>
    </header>

    <main>
        <div class="controls-container">
            <div class="search-box">
                <h2>1. Cerca un'area</h2>
                <form id="location-form">
                    <input type="text" id="location-input" placeholder="Es. Camaldoli, Vallombrosa..." required>
                    <button type="submit">Cerca</button>
                </form>
                <form id="coords-form" style="margin-top: 15px;">
                    <input type="text" id="coords-input" placeholder="O incolla coordinate: 43.76, 11.25" required>
                    <button type="submit">Cerca</button>
                </form>
            </div>
            <div id="loading">Analisi scientifica in corso...</div>
            <div id="results-area">
                <div class="result-card" id="score-display">
                    <div id="score-value">--</div>
                    <div id="location-name"></div>
                    <h3>Stima Raccolta (2h)</h3>
                    <p id="harvest-estimate">--</p>
                </div>
                <div class="result-card">
                    <h3>Consigli Pratici</h3>
                    <ul id="advice-list"></ul>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </main>

    <script>
        // L'URL relativo funziona con il proxy di Netlify e in locale se configurato
        const API_URL = '/api'; 

        const locationForm = document.getElementById('location-form');
        const coordsForm = document.getElementById('coords-form');
        const locationInput = document.getElementById('location-input');
        const coordsInput = document.getElementById('coords-input');
        const loadingDiv = document.getElementById('loading');
        const resultsArea = document.getElementById('results-area');
        const locationNameEl = document.getElementById('location-name');

        // --- Inizializzazione Mappa ---
        const map = L.map('map').setView([42.8, 12.5], 6); // Vista iniziale sull'Italia
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        let marker;

        // --- Gestione Eventi ---
        locationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            coordsInput.value = ''; // Pulisce l'altro campo
            const location = locationInput.value;
            setLoading(true, `Geocodifica di "${location}"...`);
            try {
                const geoReq = await fetch(`${API_URL}/geocode?q=${encodeURIComponent(location)}`);
                if (!geoReq.ok) {
                    const err = await geoReq.json();
                    throw new Error(err.detail || 'Localit√† non trovata.');
                }
                const geoData = await geoReq.json();
                locationNameEl.textContent = geoData.name;
                await fetchAndDisplayScore(geoData.lat, geoData.lon);
            } catch (error) {
                handleError(error.message);
            }
        });

        coordsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            locationInput.value = ''; // Pulisce l'altro campo
            const coordsText = coordsInput.value;
            try {
                const [lat, lon] = parseCoordinates(coordsText);
                locationNameEl.textContent = `Coordinate: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                await fetchAndDisplayScore(lat, lon);
            } catch (error) {
                handleError(error.message);
            }
        });
        
        function parseCoordinates(text) {
            const parts = text.replace(/,/g, ' ').split(' ').filter(p => p.trim() !== '');
            if (parts.length !== 2) throw new Error('Formato coordinate non valido. Usa "lat, lon".');
            const lat = parseFloat(parts[0]);
            const lon = parseFloat(parts[1]);
            if (isNaN(lat) || isNaN(lon)) throw new Error('Coordinate non numeriche.');
            if (lat < -90 || lat > 90 || lon < -180 || lon > 180) throw new Error('Valori di coordinate non validi.');
            return [lat, lon];
        }

        async function fetchAndDisplayScore(lat, lon) {
            setLoading(true, 'Analisi scientifica in corso...');
            try {
                const scoreReq = await fetch(`${API_URL}/score?lat=${lat}&lon=${lon}`);
                if (!scoreReq.ok) {
                    const err = await scoreReq.json();
                    throw new Error(err.detail || 'Errore nel calcolo del punteggio.');
                }
                const data = await scoreReq.json();
                displayResults(data);
                updateMap(data.coords.lat, data.coords.lon, data.overall_score);
                setLoading(false);
            } catch (error) {
                handleError(error.message);
            }
        }
        
        function setLoading(isLoading, message = '') {
            loadingDiv.style.display = isLoading ? 'block' : 'none';
            resultsArea.style.display = isLoading ? 'none' : 'flex';
            if(isLoading) {
                loadingDiv.textContent = message;
                resultsArea.style.display = 'none';
            }
        }
        
        function handleError(message) {
            alert(`Errore: ${message}`);
            setLoading(false);
        }

        function displayResults(data) {
            // Punteggio
            const scoreEl = document.getElementById('score-value');
            scoreEl.textContent = data.overall_score;
            scoreEl.style.color = getScoreColor(data.overall_score);
            // Stima Raccolta
            document.getElementById('harvest-estimate').textContent = data.estimated_harvest_per_2h;
            // Consigli
            const adviceList = document.getElementById('advice-list');
            adviceList.innerHTML = '';
            data.practical_advice.forEach(tip => {
                const li = document.createElement('li');
                li.textContent = tip;
                adviceList.appendChild(li);
            });
        }
        
        function updateMap(lat, lon, score) {
            map.setView([lat, lon], 13); // Zoom sulla localit√†
            if (marker) {
                map.removeLayer(marker); // Rimuove il vecchio marker
            }
            
            // Crea una icona personalizzata con colore dinamico
            const color = getScoreColor(score);
            const iconHtml = `<div style="background-color:${color}; width:24px; height:24px; border-radius:50%; border: 3px solid white; box-shadow: var(--shadow);"></div>`;
            const customIcon = L.divIcon({
                html: iconHtml,
                className: '' // Necessario per non avere stili di default
            });

            marker = L.marker([lat, lon], { icon: customIcon }).addTo(map);
        }

        function getScoreColor(score) {
            if (score < 45) return '#d9534f'; // Rosso
            if (score < 65) return '#f0ad4e'; // Arancione
            return '#5cb85c'; // Verde
        }
    </script>
</body>
</html>
