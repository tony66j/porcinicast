<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Trovapolcini by Antonio D‚ÄôAloia</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<style>
  :root{--bg:#0b1020;--panel:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--accent:#10b981;--accent2:#22d3ee;--border:#1f2937;}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1020,#0f172a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  header{display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border);background:rgba(15,23,42,.6)}
  .brand{font-weight:800}
  main{max-width:1180px;margin:22px auto;padding:0 16px}
  .card{background:linear-gradient(180deg,#0b1220,#0f172a);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);margin-bottom:14px}
  .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:14px}
  input,button{border-radius:10px;border:1px solid #334155;background:#0b1324;color:var(--text);padding:12px 14px;font-size:15px}
  button{background:linear-gradient(90deg,#22d3ee,#10b981);border:none;cursor:pointer;color:#062f2a;font-weight:700}
  .muted{color:var(--muted);font-size:13px}
  #map{height:460px;border-radius:12px;overflow:hidden}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .kpi{font-size:40px;font-weight:800}
  .pill{display:inline-block;padding:4px 12px;border-radius:999px;border:1px solid var(--border);background:#0b1324}
  .ok{color:#22c55e;border-color:#064e3b;background:rgba(16,185,129,.15)}
  .mid{color:#f59e0b;border-color:#7c2d12;background:rgba(245,158,11,.12)}
  .low{color:#ef4444;border-color:#7f1d1d;background:rgba(239,68,68,.12)}
  .table{border:1px solid var(--border);border-radius:10px;overflow:hidden}
  .tr{display:grid;grid-template-columns:1fr 1fr;padding:8px 10px;border-bottom:1px solid #1f2937}
  .tr.head{background:#0b1324;color:#cbd5e1;font-weight:700}
  .tr:last-child{border-bottom:none}
  .status{position:fixed;right:12px;top:10px;background:#1a2334;border:1px solid #2b3950;padding:6px 10px;border-radius:10px;font-size:12px}
  .status.err{background:#3a1111;border-color:#7d1f1f;color:#ffdede}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="status" class="status">Diagnostica: avvio‚Ä¶</div>
<header><div class="brand">Trovapolcini by Antonio D‚ÄôAloia</div></header>

<main>
  <div class="card">
    <div class="row">
      <input id="q" placeholder="Cerca localit√† (es. Benevento)">
      <button id="btnSearch">Cerca</button>
      <input id="coords" placeholder="Oppure incolla coordinate Google: 41.127, 14.782" style="min-width:320px">
      <button id="btnCoords">Usa coordinate</button>
      <button id="btnGeo" title="Usa la mia posizione">üìç</button>
    </div>
    <div class="muted" style="margin-top:6px">Suggerimento: tasto destro su Google Maps ‚Üí copia le coordinate, incolla qui.</div>
  </div>

  <div class="grid">
    <div>
      <div class="card"><div id="map"></div></div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">Indice oggi (0‚Äì100)</div>
            <div id="score" class="kpi">‚Äî</div>
          </div>
          <div id="harvest" class="pill">‚Äî</div>
        </div>
        <div class="muted" id="bestWin" style="margin-top:8px">‚Äî</div>
      </div>

      <div class="card" id="whyCard" style="display:none">
        <div style="font-weight:700">Perch√© questo giudizio?</div>
        <ul id="whyList" class="muted" style="margin-left:16px"></ul>
      </div>
    </div>

    <div>
      <div class="card">
        <div style="font-weight:700;margin-bottom:6px">Piogge future (prossimi 10 giorni)</div>
        <div class="table" id="rainFuture"><div class="tr head"><div>Data</div><div>mm</div></div></div>
      </div>
      <div class="card">
        <div style="font-weight:700;margin-bottom:6px">Piogge passate (ultimi 30 giorni)</div>
        <div class="table" id="rainPast"><div class="tr head"><div>Data</div><div>mm</div></div></div>
      </div>
      <div class="card">
        <div style="font-weight:700;margin-bottom:6px">Fattori analizzati</div>
        <div id="facts" class="muted"></div>
      </div>
    </div>
  </div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
const $=s=>document.querySelector(s);
const API=window.location.origin+"/api";
const COORD_RE=/^\s*([+-]?\d+(?:[.,]\d+)?)\s*[,;\s]\s*([+-]?\d+(?:[.,]\d+)?)\s*$/;

function setStatus(t,err=false){const el=$("#status");el.textContent="Diagnostica: "+t;el.className="status"+(err?" err":"");}
function parseCoords(x){const m=COORD_RE.exec((x||"").trim());if(!m)return null;const a=parseFloat(m[1].replace(",", "."));const b=parseFloat(m[2].replace(",", "."));if(!isFinite(a)||!isFinite(b)||a<-90||a>90||b<-180||b>180)return null;return {lat:a,lon:b};}
function cls(sc){if(sc>=70)return"ok";if(sc>=55)return"mid";return"low";}
function tableFill(el,dict){el.innerHTML='<div class="tr head"><div>Data</div><div>mm</div></div>';Object.keys(dict||{}).sort().forEach(d=>{const tr=document.createElement("div");tr.className="tr";tr.innerHTML=`<div>${d}</div><div>${Number(dict[d]).toFixed(1)}</div>`;el.appendChild(tr);});}

let map, marker;
function initMap(){
  map=L.map('map',{zoomControl:true}).setView([42.5,12.5],6);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'&copy; OpenStreetMap'}).addTo(map);
  marker=L.marker([42.5,12.5]).addTo(map);
  setTimeout(()=>map.invalidateSize(),150); // FIX: mappa invisibile
  map.on("click", e=> runWithCoords(e.latlng.lat, e.latlng.lng, "Punto sulla mappa"));
}

async function fetchJSON(u){const r=await fetch(u); if(!r.ok) throw new Error(await r.text()); return r.json();}
async function geocode(q){return fetchJSON(`${API}/geocode?q=${encodeURIComponent(q)}`);}
async function score(lat,lon){return fetchJSON(`${API}/score?lat=${lat}&lon=${lon}`);}

function render(label,lat,lon,s){
  $("#score").textContent=s.score_today ?? "‚Äî";
  const H=$("#harvest"); H.textContent=s.harvest_estimate||"‚Äî"; H.className=`pill ${cls(s.score_today||0)}`;
  const bw=s.best_window; $("#bestWin").textContent=bw?`Finestra migliore (3 giorni): D+${bw.start} ‚Üí D+${bw.end} (media ${bw.mean})`:"‚Äî";
  tableFill($("#rainFuture"), s.rain_future); tableFill($("#rainPast"), s.rain_past);
  const why=s.explanation?.reasons||[]; const ul=$("#whyList"); ul.innerHTML=""; if(why.length){$("#whyCard").style.display="block"; why.forEach(t=>{const li=document.createElement("li");li.textContent=t;ul.appendChild(li);});}else{$("#whyCard").style.display="none";}
  $("#facts").innerHTML=`Lat/Lon: ${lat.toFixed(5)}, ${lon.toFixed(5)}<br>
    Quota stimata: ${s.elevation_m} m ‚Äî Pendenza: ${s.slope_deg}¬∞ ‚Äî Esposizione: ${s.aspect_octant} (${s.aspect_deg}¬∞)<br>
    P7/P14: ${s.P7_mm}/${s.P14_mm} mm ‚Äî API*: ${s.API_star_mm} mm ‚Äî ET0 7g: ${s.ET0_7d_mm} mm<br>
    Tmed7: ${s.Tmean7_c} ¬∞C (Tmin7 ${s.Tmin7_c}‚ÄìTmax7 ${s.Tmax7_c}) ‚Äî UR7: ${s.RH7_mean_% ?? "‚Äî"} %`;
}

async function runWithCoords(lat,lon,label){
  try{
    setStatus("calcolo‚Ä¶");
    marker.setLatLng([lat,lon]); map.setView([lat,lon],11);
    const s=await score(lat,lon);
    render(label,lat,lon,s);
    setStatus("OK ‚úî");
  }catch(e){console.error(e);setStatus("errore backend",true);alert("Errore durante il calcolo. Riprova pi√π tardi.");}
}
async function runPlace(){
  const q=$("#q").value.trim(); if(!q){$("#q").focus();return;}
  try{setStatus("geocoding‚Ä¶"); const g=await geocode(q); await runWithCoords(g.lat,g.lon,g.display);}
  catch(e){console.error(e);setStatus("errore geocoding",true);alert("Localit√† non trovata o servizio non disponibile.");}
}
async function runCoords(){
  const c=parseCoords($("#coords").value); if(!c){alert("Formato coordinate non valido. Es: 41.127, 14.782");return;}
  await runWithCoords(c.lat,c.lon,`${c.lat.toFixed(5)}, ${c.lon.toFixed(5)}`);
}

document.getElementById("btnSearch").addEventListener("click", runPlace);
document.getElementById("btnCoords").addEventListener("click", runCoords);
document.getElementById("btnGeo").addEventListener("click", ()=>{
  if(!navigator.geolocation){alert("Geolocalizzazione non supportata");return;}
  navigator.geolocation.getCurrentPosition(
    pos=>runWithCoords(pos.coords.latitude,pos.coords.longitude,"La mia posizione"),
    ()=>alert("Impossibile ottenere la posizione")
  );
});
document.addEventListener("keydown", e=>{ if(e.key==="Enter") runPlace(); });

async function ping(){
  try{const r=await fetch(window.location.origin+"/api/health"); setStatus(r.ok?"backend OK ‚úî":"backend non risponde", !r.ok);}
  catch{setStatus("errore rete verso backend", true);}
}

initMap(); ping();
</script>
</body>
</html>
