<!-- index.html  (v0.96) -->
<!doctype html><html lang="it"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TrovaPorcini ‚Äì by Antonio Pio D‚ÄôAloia</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body{margin:0;background:#0e1420;color:#e9f2ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  header{display:flex;align-items:center;gap:.6rem;padding:16px;border-bottom:1px solid #1b2436}
  .logo{font-size:26px;font-weight:700} .by{opacity:.75;font-size:14px;margin-left:8px}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:#121a2a;border:1px solid #1c2740;border-radius:12px;padding:14px}
  .pill{display:inline-block;background:#16253d;border:1px solid #25406d;border-radius:999px;padding:4px 10px;margin-right:6px}
  .big{font-size:46px;font-weight:800}
  .ok{color:#03d47c}.warn{color:#ffc857}.bad{color:#ff6b6b}
  label{font-size:12px;opacity:.8}
  input,button{background:#0f1726;color:#e9f2ff;border:1px solid #2a3a5d;border-radius:8px;padding:10px}
  button{background:#0fb36b;border-color:#11c07a;cursor:pointer;font-weight:600}
  #map{height:520px;border-radius:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
  details{margin-top:6px}
</style>
</head><body>
<header>
  <div class="logo">üçÑ TrovaPorcini</div>
  <div class="by">by <strong>Antonio Pio D‚ÄôAloia</strong></div>
  <div style="flex:1"></div>
  <a class="pill" href="#">Ricerca</a>
  <a class="pill" href="#">Mappa</a>
</header>

<div class="wrap">
  <div class="card grid2">
    <div>
      <label>Localit√†</label>
      <input id="q" placeholder="es. Bocca della Selva" style="width:100%">
    </div>
    <div>
      <label>Coordinate (lat,lon ‚Äì accetta virgola o punto)</label>
      <input id="coord" placeholder="es. 41.4170010, 14.4707168" style="width:100%">
    </div>
    <div><button id="go">Calcola idoneit√†</button></div>
    <div><button id="clr" style="background:#24324e;border-color:#314469">Pulisci</button></div>
  </div>

  <div class="row mt16">
    <div class="card">
      <div id="scorebox">
        <div>Indice oggi</div>
        <div class="big" id="score">‚Äì</div>
        <div id="status" class="pill mt8">‚Äì</div>
        <div id="kg" class="pill mt8" title="Stima raccolto in 3 ore">Stima 3h: ‚Äì kg</div>
      </div>

      <div class="mt16">
        <div>Previsione (prossimi 10 giorni)</div>
        <input id="day" type="range" min="0" max="9" value="0" style="width:100%">
        <div class="mt8"><small>Giorno selezionato: <span id="selday">oggi</span></small></div>
        <div class="mt8"><small>Finestra migliore (3 gg): <span id="win">‚Äì</span></small></div>
        <div class="mt8"><small id="window_note"></small></div>
      </div>

      <details class="mt12" open>
        <summary>Consigli pratici (dipendono dalle condizioni)</summary>
        <div id="tips" class="mt8">‚Äì</div>
      </details>
      <details class="mt12" open>
        <summary>Specie di porcini probabili</summary>
        <div id="species" class="mt8">‚Äì</div>
      </details>
      <details class="mt12" open>
        <summary id="why_title">Perch√© questa stima</summary>
        <div id="why" class="mt8">‚Äì</div>
      </details>

      <details class="mt12">
        <summary>Dati tecnici</summary>
        <div id="tech" class="mt8">‚Äì</div>
      </details>
    </div>

    <div class="card"><div id="map"></div></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API = location.origin.includes("netlify") ? "/api" : "/api";
let map, mark, ring;

function initMap(){
  map = L.map('map',{zoomControl:true}).setView([42.5,12.5],6); // Italia
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom: 18, attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  mark = L.marker([42.5,12.5]).addTo(map);
  ring  = L.circle([42.5,12.5], {radius:700, color:'#ffcc33'}).addTo(map);
}
initMap();

function statusLabel(s){
  if(s>=70) return {txt:"Consigliato", cls:"ok"};
  if(s>=40) return {txt:"Possibile", cls:"warn"};
  return {txt:"Sconsigliato", cls:"bad"};
}
function dayLabel(d){ return d==0 ? "oggi" : `D+${d}` }

async function geocode(q){
  const url = "https://nominatim.openstreetmap.org/search";
  const r = await fetch(`${url}?format=json&q=${encodeURIComponent(q)}&limit=1&addressdetails=1`);
  const j = await r.json();
  if(!j.length) throw new Error("Localit√† non trovata");
  return {lat: parseFloat(j[0].lat), lon: parseFloat(j[0].lon), display: j[0].display_name};
}

function parseCoord(s){
  if(!s) return null;
  let t=s.replace(/[;|]/g,',').replace(/\s+/g,'').replace(/,/g,'.'); // accetta virgola
  const m=t.split(/[,/]/);
  if(m.length!=2) return null;
  return {lat:parseFloat(m[0]), lon:parseFloat(m[1])};
}

let lastData=null;

async function compute(){
  try{
    const cq = document.getElementById('coord').value.trim();
    const qq = document.getElementById('q').value.trim();
    let p = parseCoord(cq);
    if(!p){
      if(!qq) throw new Error("Inserisci localit√† o coordinate");
      p = await geocode(qq);
    }
    const day = +document.getElementById('day').value;
    const r = await fetch(`${API}/score?lat=${p.lat}&lon=${p.lon}&day=${day}`);
    if(!r.ok){ throw new Error(`API ${r.status}: ${await r.text()}`) }
    const j = await r.json();
    lastData=j;

    // UI
    const s = j.score_selected;
    document.getElementById('score').textContent = s;
    const st = statusLabel(s);
    const stDiv = document.getElementById('status');
    stDiv.textContent = st.txt;
    stDiv.className = `pill mt8 ${st.cls}`;
    document.getElementById('kg').textContent = `Stima 3h: ${j.kg3h_estimate} kg`;
    document.getElementById('selday').textContent = dayLabel(day);
    document.getElementById('win').textContent = `D+${j.best_window.start} ‚Üí D+${j.best_window.end} (media ${j.best_window.mean})`;
    document.getElementById('window_note').textContent = j.window_note? j.window_note : "";
    document.getElementById('tips').textContent = j.tips;
    document.getElementById('species').textContent = j.species_probable.join(", ");
    document.getElementById('why_title').textContent = "Perch√© questa stima";
    const b = j.breakdown;
    document.getElementById('why').textContent =
      `piogge P14=${j.P14_mm} mm; ET0_7=${j.ET0_7g_mm} mm; T7=${b.tmean7.toFixed(1)}¬∞C; `+
      `ultimo rain=${j.last_rain_days} gg fa; quota=${Math.round(j.elev_m)} m; `+
      `esposizione ${j.aspect_octant} (${j.aspect_deg}¬∞); bosco: ${j.forest}`;

    document.getElementById('tech').innerHTML =
      `<span class="pill">P14: ${j.P14_mm} mm</span>
       <span class="pill">ET0_7: ${j.ET0_7g_mm} mm</span>
       <span class="pill">Ultima pioggia: ${j.last_rain_days} gg</span>
       <span class="pill">Prossima pioggia: ${j.next_rain_mm} mm ${j.next_rain_in_days!=null?`in D+${j.next_rain_in_days}`:""}</span>
       <span class="pill">Quota: ${Math.round(j.elev_m)} m</span>
       <span class="pill">Pendenza: ${j.slope_deg}¬∞</span>`;

    mark.setLatLng([p.lat,p.lon]);
    ring.setLatLng([p.lat,p.lon]);
    map.setView([p.lat,p.lon], 12);
  }catch(e){
    alert("Errore: "+e.message);
    console.error(e);
  }
}

document.getElementById('go').onclick = compute;
document.getElementById('clr').onclick = ()=>{
  document.getElementById('q').value="";
  document.getElementById('coord').value="";
};
document.getElementById('day').oninput = ()=>{
  if(lastData) compute();
};
</script>
</body></html>

