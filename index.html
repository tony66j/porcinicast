<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trova Porcini by Antonio Pio D'aloia</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    
    <style>
        :root {
            --bg-color: #f4f7f6; --card-bg: #ffffff; --text-color: #333;
            --primary: #6d4c41; --primary-light: #efebe9; --shadow: 0 4px 15px rgba(0,0,0,0.08);
            --accent-green: #28a745; --accent-orange: #fd7e14; --accent-red: #dc3545; --accent-blue: #007bff;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); }
        .header { background-color: var(--primary); color: white; text-align: center; padding: 20px 10px; box-shadow: var(--shadow); }
        .header h1 { margin: 0; font-size: 2.2rem; }
        .header p { margin: 5px 0 0; font-style: italic; opacity: 0.9; }
        main { max-width: 1400px; margin: 20px auto; padding: 0 15px; display: flex; gap: 20px; flex-wrap: wrap-reverse; }
        .controls-container { flex: 1; min-width: 340px; }
        .map-container { flex: 1.5; min-width: 400px; min-height: 600px; background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); }
        #map { width: 100%; height: 100%; border-radius: 12px; z-index: 1; }
        .search-box { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 20px; }
        h2 { margin-top: 0; color: var(--primary); font-size: 1.2rem; }
        form { display: flex; gap: 10px; }
        input[type="text"] { flex-grow: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        button { padding: 12px 20px; background-color: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; }
        #loading { text-align: center; font-size: 1.2rem; color: var(--primary); display: none; margin: 20px; }
        #results-area { display: grid; grid-template-columns: 1fr; gap: 20px; display: none; }
        .result-card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); }
        .result-card h3 { margin-top: 0; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 8px; font-size: 1.1rem; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center; }
        .info-item h4 { margin: 0 0 5px; font-size: 0.8rem; color: #777; font-weight: normal; text-transform: uppercase; }
        .info-item p { margin: 0; font-size: 1.2rem; font-weight: bold; color: var(--primary); }
        #score-value { font-size: 4rem; font-weight: bold; line-height: 1; text-align: center; }
        #location-name { text-align: center; font-weight: normal; font-size: 1rem; color: #777; margin-top: 10px; word-break: break-word; }
        #harvest-estimate { font-size: 1.2rem; color: var(--primary); font-weight: bold; text-align: center; margin: 15px 0 5px; }
        .weather-forecast { display: flex; justify-content: space-between; text-align: center; }
        .weather-day { flex: 1; padding: 5px; border-radius: 8px; }
        .weather-day .day { font-weight: bold; font-size: 0.9rem; }
        .weather-day .temp { font-size: 1.1rem; }
        .weather-day .temp-min { font-size: 0.9rem; opacity: 0.7; }
        .weather-day .rain { font-size: 0.9rem; color: var(--accent-blue); font-weight: bold; }
    </style>
</head>
<body>
    <header class="header"><h1>Trova Porcini</h1><p>by Antonio Pio D'aloia</p></header>
    <main>
        <div class="controls-container">
            <div class="search-box">
                <h2>Cerca un'area</h2>
                <form id="location-form"><input type="text" id="location-input" placeholder="Es. Camaldoli, Vallombrosa..." required><button type="submit">Cerca</button></form>
                <form id="coords-form" style="margin-top: 15px;"><input type="text" id="coords-input" placeholder="O incolla coordinate: 43.76, 11.25" required><button type="submit">Cerca</button></form>
            </div>
            <div id="loading">Recupero dati meteo reali e analisi...</div>
            <div id="results-area">
                <div class="result-card" id="score-card">
                    <h3>Indice Idoneità Odierna</h3>
                    <div id="score-value">--</div>
                    <div id="location-name"></div>
                    <p id="harvest-estimate">--</p>
                </div>
                <div class="result-card" id="window-card">
                    <h3>Finestra di Uscita</h3>
                    <div class="info-item" style="text-align:center;"><h4>Stato Attuale</h4><p id="window-status" style="font-size: 1.1rem; font-style: italic;">--</p></div>
                    <div class="info-item" style="margin-top: 15px; text-align:center;"><h4>Picco Previsto</h4><p id="window-peak">--</p></div>
                </div>
                <div class="result-card" id="weather-card">
                    <h3>Meteo Prossimi 5 Giorni</h3>
                    <div id="weather-forecast-container" class="weather-forecast"></div>
                </div>
                <div class="result-card" id="advice-card">
                    <h3>Consigli Pratici</h3>
                    <ul id="advice-list" style="padding-left:0; list-style:none; font-size:0.9rem;"></ul>
                </div>
            </div>
        </div>
        <div class="map-container"><div id="map"></div></div>
    </main>

    <script>
        const API_URL = '/api'; 

        const locationForm = document.getElementById('location-form');
        const coordsForm = document.getElementById('coords-form');
        const loadingDiv = document.getElementById('loading');
        const resultsArea = document.getElementById('results-area');
        const locationNameEl = document.getElementById('location-name');

        const map = L.map('map').setView([42.8, 12.5], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
        let marker;

        locationForm.addEventListener('submit', e => { e.preventDefault(); handleLocationSearch(); });
        coordsForm.addEventListener('submit', e => { e.preventDefault(); handleCoordsSearch(); });
        
        async function handleLocationSearch() {
            document.getElementById('coords-input').value = '';
            const location = document.getElementById('location-input').value;
            setLoading(true, `Geocodifica di "${location}"...`);
            try {
                const geoReq = await fetch(`${API_URL}/geocode?q=${encodeURIComponent(location)}`);
                if (!geoReq.ok) throw new Error((await geoReq.json()).detail || 'Località non trovata.');
                const geoData = await geoReq.json();
                locationNameEl.textContent = geoData.name;
                await fetchAndDisplayScore(geoData.lat, geoData.lon);
            } catch (error) { handleError(error.message); }
        }

        async function handleCoordsSearch() {
            document.getElementById('location-input').value = '';
            try {
                const [lat, lon] = parseCoordinates(document.getElementById('coords-input').value);
                locationNameEl.textContent = `Coordinate: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                await fetchAndDisplayScore(lat, lon);
            } catch (error) { handleError(error.message); }
        }
        
        function parseCoordinates(text) {
            const parts = text.replace(/,/g, ' ').split(' ').filter(p => p.trim() !== '');
            if (parts.length !== 2) throw new Error('Formato coordinate non valido. Usa "lat, lon".');
            const [lat, lon] = [parseFloat(parts[0]), parseFloat(parts[1])];
            if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lat < -180 || lon > 180) throw new Error('Valori di coordinate non validi.');
            return [lat, lon];
        }

        async function fetchAndDisplayScore(lat, lon) {
            setLoading(true, 'Recupero dati meteo reali e analisi scientifica...');
            try {
                const scoreReq = await fetch(`${API_URL}/score?lat=${lat}&lon=${lon}`);
                if (!scoreReq.ok) {
                    const errData = await scoreReq.json();
                    throw new Error(errData.detail || 'Errore nel calcolo del punteggio.');
                }
                const data = await scoreReq.json();
                displayResults(data);
                updateMap(data.coords.lat, data.coords.lon, data.overall_score);
            } catch (error) { handleError(error.message); } finally { setLoading(false); }
        }
        
        function setLoading(isLoading, message = '') {
            loadingDiv.style.display = isLoading ? 'block' : 'none';
            resultsArea.style.display = isLoading ? 'none' : 'grid';
            if(isLoading) loadingDiv.textContent = message;
        }
        
        function handleError(message) {
            alert(`Errore: ${message}`);
            setLoading(false);
        }

        function displayResults(data) {
            const scoreEl = document.getElementById('score-value');
            scoreEl.textContent = data.overall_score;
            scoreEl.style.color = getScoreColor(data.overall_score);
            document.getElementById('harvest-estimate').textContent = data.estimated_harvest_per_2h;
            
            const win = data.fruiting_window;
            document.getElementById('window-peak').textContent = win.peak_date;
            document.getElementById('window-status').textContent = win.status;

            const adviceList = document.getElementById('advice-list');
            adviceList.innerHTML = '';
            data.practical_advice.forEach(tip => adviceList.insertAdjacentHTML('beforeend', `<li>${tip}</li>`));

            const weatherContainer = document.getElementById('weather-forecast-container');
            weatherContainer.innerHTML = '';
            for(let i=0; i<5; i++) {
                const dayName = new Date(data.weather_forecast.time[i]).toLocaleDateString('it-IT', { weekday: 'short' });
                const tempMax = data.weather_forecast.temp_max[i].toFixed(0);
                const tempMin = data.weather_forecast.temp_min[i].toFixed(0);
                const rain = data.weather_forecast.precipitation[i].toFixed(1);
                weatherContainer.innerHTML += `
                    <div class="weather-day" style="background-color: ${rain > 1 ? 'rgba(0,123,255,0.1)' : 'transparent'}">
                        <div class="day">${i === 0 ? "Oggi" : dayName}</div>
                        <div class="temp">${tempMax}°</div>
                        <div class="temp-min">${tempMin}°</div>
                        <div class="rain">${rain} mm</div>
                    </div>`;
            }
        }
        
        function updateMap(lat, lon, score) {
            map.setView([lat, lon], 13);
            if (marker) map.removeLayer(marker);
            const color = getScoreColor(score);
            const iconHtml = `<div style="background-color:${color}; width:24px; height:24px; border-radius:50%; border: 3px solid white; box-shadow: var(--shadow);"></div>`;
            marker = L.marker([lat, lon], { icon: L.divIcon({ html: iconHtml, className: '' }) }).addTo(map);
        }

        function getScoreColor(score) {
            if (score < 45) return 'var(--accent-red)';
            if (score < 65) return 'var(--accent-orange)';
            return 'var(--accent-green)';
        }
    </script>
</body>
</html>

