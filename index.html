<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Trova Porcini — by Antonio Pio D’Aloia</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{--bg:#0b1220;--panel:#111b2b;--text:#e9f1fa;--muted:#9fb0c2;--accent:#1ee59a;--warn:#ffd166;--danger:#ef476f;--border:#233144;}
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0a1020,#0f1930);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    header{padding:16px 20px;border-bottom:1px solid var(--border);backdrop-filter:blur(6px)}
    .wrap{max-width:1280px;margin:0 auto;padding:20px;display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    @media(max-width:960px){.wrap{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,#0e1728,#0f192c);padding:16px;border-radius:14px;border:1px solid var(--border);box-shadow:0 12px 28px rgba(0,0,0,.35);margin-bottom:16px}
    input,button,select,label{color:var(--text)}
    input,button,select{padding:10px;border-radius:10px;border:1px solid #2b3b52;font-size:15px;background:#0b1526}
    button{cursor:pointer;font-weight:700}
    button.ok{background:linear-gradient(90deg,#22d3ee,#1ee59a);border:none;color:#062f2a}
    button.warn{background:linear-gradient(90deg,#ffd166,#22d3ee);border:none;color:#062f2a}
    .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .metric{background:#0b1526;padding:10px;border-radius:12px;text-align:center;border:1px solid #223249}
    .metric .val{font-size:1.6rem;font-weight:800}
    .right-panel{display:flex;flex-direction:column;gap:16px}
    #map{height:480px;border-radius:12px;overflow:hidden}
    .calendar{display:grid;grid-template-columns:repeat(10,1fr);gap:4px;margin-top:8px}
    .bar{height:110px;position:relative;background:#1f2937;border-radius:8px}
    .bar>i{position:absolute;bottom:0;left:0;width:100%;border-radius:8px}
    .bar>span{position:absolute;top:-18px;left:0;width:100%;text-align:center;font-size:.7rem}
    .table{border:1px solid #223249;border-radius:12px;overflow:hidden}
    .tr{display:grid;grid-template-columns:1fr 80px;padding:8px 10px;border-bottom:1px solid #223249}
    .tr.head{background:#0b1526;font-weight:bold}
    .tr:last-child{border-bottom:none}
    details summary{cursor:pointer;font-weight:700;margin-top:10px;color:#b9c7ff}
    .muted{color:var(--muted);font-size:.9rem}
    #explanationPanel h3{margin-top:0;color:#b9c7ff} #explanationPanel p, #explanationPanel li{line-height:1.6;color:var(--muted)}
    #loading{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);z-index:999}
    #loading .ball{width:12px;height:12px;border-radius:50%;margin:6px;background:#22d3ee;display:inline-block;animation:bounce 0.8s infinite alternate}
    #loading .ball:nth-child(2){animation-delay:.15s;background:#1ee59a}
    #loading .ball:nth-child(3){animation-delay:.3s;background:#ffd166}
    @keyframes bounce{to{transform:translateY(-10px)}}
    .row{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .badge{display:inline-block;padding:4px 8px;border:1px solid #223249;border-radius:999px;font-size:.8rem; margin-right:6px}
    .switch{display:flex;align-items:center;gap:8px}
    .switch input{transform:scale(1.1)}
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0;font-size:1.4rem;">Trova Porcini — by Antonio Pio D’Aloia</h1>
    <div class="muted" style="font-size:.85rem;">Le barre ora mostrano la <strong>previsione di uscita dei porcini</strong> (flush) nei prossimi 10 giorni: eventi di pioggia → lag biologico 5–15 gg → probabilità.</div>
  </header>

  <div id="loading"><div><span class="ball"></span><span class="ball"></span><span class="ball"></span></div></div>

  <div class="wrap">
    <div class="left-panel">
      <div class="card">
        <div class="row">
          <input id="place" type="text" placeholder="Località (es. Abbadia San Salvatore)" style="flex:1"/>
          <button id="btnSearch" class="ok">Cerca</button>
        </div>
        <div class="row">
          <input id="coords" type="text" placeholder="lat, lon (Google)" style="flex:1;min-width:220px"/>
          <button id="btnCoords" class="warn">Usa coordinate</button>
          <select id="habitat" title="Habitat">
            <option value="">Habitat: auto (OSM)</option>
            <option>Castagno</option><option>Faggio</option><option>Quercia</option>
            <option>Conifere</option><option>Misto</option><option>Altro</option>
          </select>
          <label class="switch" title="Se attivo, uso l'habitat automatico da OSM">
            <input id="autoHab" type="checkbox" checked/> Auto
          </label>
          <select id="hours">
            <option value="2">Durata uscita: 2 h</option>
            <option value="4">Durata uscita: 4 h</option>
          </select>
        </div>
        <div class="muted" style="font-size:0.8rem;margin-bottom:12px;">Tip: lascia “Auto” per usare l’habitat rilevato (OSM). Se non ti convince, disattiva “Auto” e seleziona tu l’habitat.</div>

        <div class="metrics">
          <div class="metric"><div class="muted">Indice (oggi)</div><div id="metricIndex" class="val">—</div></div>
          <div class="metric"><div class="muted">Raccolto atteso</div><div id="metricHarvest" class="val">—</div></div>
          <div class="metric"><div class="muted">Affidabilità</div><div id="metricReliability" class="val">—</div></div>
        </div>
        <div id="metricSite" class="muted" style="text-align:center; margin-top:8px;"></div>
      </div>

      <div class="card">
        <div class="muted" style="margin-bottom:6px;">Previsione uscita porcini (10 giorni)</div>
        <div id="forecast" class="calendar"></div>
        <div class="muted" style="margin-top:6px;font-size:.8rem;">Le barre rappresentano la <em>probabilità/forza</em> del flush. Il calcolo usa gli eventi di pioggia (passati+previsti) e un lag biologico dinamico.</div>
      </div>

      <div class="card">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div>
            <div class="muted" style="margin-bottom:6px;">Piogge passate (15 gg)</div>
            <div id="rainPast" class="table"><div class="tr head"><div>Data</div><div>mm</div></div></div>
          </div>
          <div>
            <div class="muted" style="margin-bottom:6px;">Piogge future (10 gg)</div>
            <div id="rainFuture" class="table"><div class="tr head"><div>Data</div><div>mm</div></div></div>
          </div>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <div class="card"><div id="map"></div></div>
      <div class="card" id="explanationPanel" style="display:none;">
          <h3>Analisi del Modello</h3>
          <div id="explanationText"></div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const API = "/api";
    const $ = s => document.querySelector(s);
    const showLoad = (v)=>{ $("#loading").style.display = v ? "grid" : "none"; };

    let map, marker;
    function initMap(){
      map = L.map('map').setView([42.5,12.5], 6);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);
      marker = L.marker([42.5,12.5]).addTo(map);
      setTimeout(()=>map.invalidateSize(), 250);
      map.on("click", e => handleCoords(e.latlng.lat, e.latlng.lng));
    }

    function parseCoords(str){
      const m = /^\s*([+-]?\d+(?:[.,]\d+)?)\s*[,;\s]\s*([+-]?\d+(?:[.,]\d+)?)\s*$/.exec((str||"").trim());
      if(!m) return null;
      const lat = parseFloat(m[1].replace(",", ".")), lon = parseFloat(m[2].replace(",", "."));
      if(!isFinite(lat)||!isFinite(lon)||lat<-90||lat>90||lon<-180||lon>180) return null;
      return {lat,lon};
    }
    async function apiGet(u){
      const r = await fetch(u);
      if(!r.ok){ const t = await r.text().catch(()=>""); throw new Error(t||"errore rete"); }
      return r.json();
    }

    function renderUI(s){
        $("#metricIndex").textContent = s.index ?? "—";
        $("#metricHarvest").textContent = s.harvest_estimate ?? "—";
        $("#metricReliability").textContent = s.reliability != null ? Math.round(s.reliability * 100) + "%" : "—";
        const a = s.aspect_octant && s.aspect_octant !== "NA" ? s.aspect_octant : "NA";
        const habUsed = (s.habitat_used || "").charAt(0).toUpperCase() + (s.habitat_used || "").slice(1);
        const source = s.habitat_source || "—";
        let autoConf = s.auto_habitat_confidence!=null ? ` (auto conf ${Math.round(s.auto_habitat_confidence*100)}%)` : "";
        $("#metricSite").innerHTML = `
          <span class="badge">Quota: ${s.elevation_m ?? "—"} m</span>
          <span class="badge">Pendenza: ${s.slope_deg ?? "—"}°</span>
          <span class="badge">Esposizione: ${a}</span>
          <span class="badge">Habitat: ${habUsed} — ${source}${autoConf}</span>
        `;

        const forecastCont = $("#forecast"); forecastCont.innerHTML="";
        (s.forecast || []).forEach((v, i) => {
            const box = document.createElement("div"); box.className="bar";
            const fill = document.createElement("i");
            fill.title = `Giorno ${i+1} • Probabilità/forza flush ${v}`;
            fill.style.height = Math.max(4, v) + "%";
            fill.style.background = v >= 70 ? "var(--accent)" : v >= 55 ? "var(--warn)" : "var(--danger)";
            const lab = document.createElement("span"); lab.textContent = v;
            box.appendChild(fill); box.appendChild(lab); forecastCont.appendChild(box);
        });

        const fillTable = (el, d) => {
            el.innerHTML = '<div class="tr head"><div>Data</div><div>mm</div></div>';
            const keys = Object.keys(d || {});
            keys.sort((a,b)=>{
              const pa = a.startsWith("+") ? 1 : 0, pb = b.startsWith("+") ? 1 : 0;
              if (pa!==pb) return pa-pb;
              if (pa) return parseInt(a.slice(1)) - parseInt(b.slice(1));
              return a.localeCompare(b);
            });
            for (const k of keys) {
              const tr = document.createElement("div"); tr.className = "tr";
              tr.innerHTML = `<div>${k}</div><div>${Number(d[k]).toFixed(1)}</div>`;
              el.appendChild(tr);
            }
        };
        fillTable($("#rainPast"), s.rain_past || {});
        fillTable($("#rainFuture"), s.rain_future || {});

        const expPanel = $("#explanationPanel");
        const expText = $("#explanationText");
        if (s.dynamic_explanation) {
            expText.innerHTML = s.dynamic_explanation;
            expPanel.style.display = "block";
        } else {
            expPanel.style.display = "none";
        }
    }

    async function fetchScore(lat, lon){
        const hours = parseInt($("#hours").value, 10) || 2;
        const autoHab = $("#autoHab").checked ? 1 : 0;
        let habitat = $("#habitat").value || "";
        if (autoHab === 1) habitat = "";
        const params = new URLSearchParams({lat,lon,hours,autohabitat:String(autoHab)});
        if (habitat) params.append("habitat", habitat);
        return apiGet(`${API}/score?${params.toString()}`);
    }

    async function handleCoords(lat, lon) {
        showLoad(true);
        try {
            marker.setLatLng([lat, lon]);
            map.setView([lat, lon], 11);
            const s = await fetchScore(lat, lon);
            renderUI(s);
            localStorage.setItem("lastQuery", JSON.stringify({
              lat,lon,
              habitat:$("#habitat").value,
              autoHab:$("#autoHab").checked,
              hours:$("#hours").value
            }));
        } catch(e) {
            console.error(e);
            alert("Errore durante il calcolo. Dettagli in console.");
        } finally {
            showLoad(false);
        }
    }
    async function handlePlace() {
        const q = $("#place").value.trim();
        if (!q) { alert("Inserisci una località"); return; }
        showLoad(true);
        try {
            const g = await apiGet(`${API}/geocode?q=${encodeURIComponent(q)}`);
            $("#place").value = g.display;
            await handleCoords(g.lat, g.lon);
        } catch (e) {
            console.error(e);
            alert("Errore geocoding. Prova con le coordinate.");
        } finally {
            showLoad(false);
        }
    }
    async function handleCoordsStr(){
        const c = parseCoords($("#coords").value.trim());
        if (!c) { alert("Coordinate non valide. Esempio: 41.127, 14.782"); return; }
        showLoad(true);
        try { await handleCoords(c.lat, c.lon); }
        catch(e){ console.error(e); alert("Errore durante il calcolo."); }
        finally{ showLoad(false); }
    }

    $("#btnSearch").addEventListener("click", handlePlace);
    $("#btnCoords").addEventListener("click", handleCoordsStr);
    $("#place").addEventListener("keydown", (e)=>{ if(e.key==="Enter") handlePlace(); });
    $("#coords").addEventListener("keydown", (e)=>{ if(e.key==="Enter") handleCoordsStr(); });
    $("#habitat").addEventListener("change", ()=>{
      if(!$("#autoHab").checked){
        const last = localStorage.getItem("lastQuery");
        const j = last ? JSON.parse(last) : {};
        if(j.lat && j.lon){ handleCoords(j.lat,j.lon); }
      }
    });
    $("#hours").addEventListener("change", ()=>{
      const last = localStorage.getItem("lastQuery");
      const j = last ? JSON.parse(last) : {};
      if(j.lat && j.lon){ handleCoords(j.lat,j.lon); }
    });
    $("#autoHab").addEventListener("change", ()=>{
      const last = localStorage.getItem("lastQuery");
      const j = last ? JSON.parse(last) : {};
      if(j.lat && j.lon){ handleCoords(j.lat,j.lon); }
    });

    (function restore(){
      const last = localStorage.getItem("lastQuery");
      if(last){
        try{ const j=JSON.parse(last);
          if(j.habitat) $("#habitat").value=j.habitat;
          if(typeof j.autoHab==="boolean") $("#autoHab").checked=j.autoHab;
          if(j.hours) $("#hours").value=j.hours;
          if(j.lat && j.lon){ initMap(); handleCoords(j.lat,j.lon); return; }
        }catch{}
      }
      initMap();
    })();
  </script>
</body>
</html>
