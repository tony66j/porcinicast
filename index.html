<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trova Porcini ‚Äì Analisi</title>
  <style>
    :root{
      --bg:#0b0d10; --panel:#12161b; --muted:#8aa0b6; --text:#e6eef6;
      --accent:#62d5b4; --accent-2:#8bb7ff; --danger:#ff6b6b; --warn:#ffc857; --ok:#66e28a;
      --shadow:0 8px 24px rgba(0,0,0,.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:linear-gradient(180deg,#0a0c0f 0%,#0d1218 100%);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:var(--accent-2)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
    header h1{font-size:22px;margin:0}
    header .badge{padding:4px 10px;border-radius:999px;background:linear-gradient(90deg,#1b2230,#17202b);color:#cfe6ff;border:1px solid #283343}
    .panel{background:linear-gradient(180deg,#12161b,#0f141a);border:1px solid #1e2937;border-radius:var(--radius);box-shadow:var(--shadow)}
    .panel h3{margin:0 0 8px 0;font-size:18px}
    .controls{display:grid;grid-template-columns:1.1fr .8fr .8fr .8fr .8fr auto;gap:10px;align-items:end;padding:16px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type=text],input[type=number],select{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid #243142;background:#0d141b;color:var(--text)
    }
    .btn{padding:10px 14px;border-radius:12px;border:1px solid #2a384b;background:linear-gradient(180deg,#1b2430,#151c26);color:#e9f5ff;font-weight:600;cursor:pointer}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.28)}
    .grid{display:grid;gap:14px;padding:16px}
    .grid.g2{grid-template-columns:1fr 1fr}
    .grid.g3{grid-template-columns:1.1fr .9fr .9fr}
    .metric{display:flex;gap:12px;align-items:center}
    .metric .k{font-size:12px;color:var(--muted)}
    .metric .v{font-size:22px;font-weight:700}
    .chip{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #273244;background:#0f1520;color:#cfe6ff}
    .chip.ok{border-color:#224733;background:#0f1a14;color:#b9f3cf}
    .chip.warn{border-color:#4a3b1a;background:#1a160f;color:#ffe0a3}
    .chip.bad{border-color:#4a1a1a;background:#1a0f10;color:#ffb9b9}
    .section{padding:16px}
    .hr{height:1px;background:linear-gradient(90deg,transparent,#253244,transparent);margin:12px 0}
    #chart{width:100%;height:160px;border-radius:12px;background:linear-gradient(180deg,#0c1015,#0b0f14);border:1px solid #1e2937}
    table{width:100%;border-collapse:collapse;border:1px solid #232f40;border-radius:12px;overflow:hidden}
    th,td{padding:8px 10px;border-bottom:1px solid #232f40;font-size:13px}
    th{background:#131922;color:#b7c9dd;text-align:left}
    tr:hover td{background:#0f141b}
    .events ul{margin:6px 0 0 18px}
    .events li{margin:2px 0}
    details{background:#0e141b;border:1px solid #203045;border-radius:12px;padding:10px}
    summary{cursor:pointer}
    .muted{color:#93a7bd}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    footer{margin:24px 0 40px;color:#8aa0b6;font-size:12px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üçÑ Trova Porcini ‚Äî Analisi sito</h1>
      <span class="badge">v2.2 UI</span>
    </header>

    <!-- Controls -->
    <div class="panel">
      <div class="controls">
        <div>
          <label>Localit√† (geocoding)</label>
          <input id="q" type="text" placeholder="Es. Abbadia San Salvatore" />
        </div>
        <div>
          <label>Latitudine</label>
          <input id="lat" type="number" step="0.0001" placeholder="42.88" />
        </div>
        <div>
          <label>Longitudine</label>
          <input id="lon" type="number" step="0.0001" placeholder="11.63" />
        </div>
        <div>
          <label>Habitat</label>
          <select id="habitat">
            <option value="">(auto da OSM)</option>
            <option>castagno</option><option>faggio</option><option>quercia</option>
            <option>conifere</option><option>misto</option><option>altro</option>
          </select>
        </div>
        <div>
          <label>Ore sul campo</label>
          <select id="hours">
            <option>2</option><option selected>4</option><option>6</option><option>8</option>
          </select>
        </div>
        <div style="display:flex;gap:8px;">
          <button id="btnGeo" class="btn" title="Cerca">üîé Cerca</button>
          <button id="btnRun" class="btn" title="Analizza">üìà Analizza</button>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid g3">
      <div class="panel section">
        <h3>Indice oggi</h3>
        <div class="metric"><div class="k">Forza flush</div><div id="k-index" class="v">‚Äî</div></div>
        <div class="hr"></div>
        <div class="metric"><div class="k">Finestra migliore</div><div id="k-window" class="v">‚Äî</div></div>
      </div>
      <div class="panel section">
        <h3>Affidabilit√†</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <span id="k-reliab" class="chip">reliability: ‚Äî</span>
          <span id="k-conf" class="chip">model confidence: ‚Äî</span>
          <span id="k-vpd" class="chip">VPD: ‚Äî</span>
        </div>
        <div class="hr"></div>
        <div class="muted" id="k-diag">SMI: ‚Äî ‚Ä¢ TWI: ‚Äî ‚Ä¢ Energy: ‚Äî</div>
      </div>
      <div class="panel section">
        <h3>Dimensioni & Raccolto</h3>
        <div class="metric"><div class="k">Taglia media</div><div id="k-size" class="v">‚Äî</div></div>
        <div class="metric"><div class="k">Range</div><div id="k-size-range" class="v">‚Äî</div></div>
        <div class="metric"><div class="k">Raccolto atteso</div><div id="k-harvest" class="v">‚Äî</div></div>
        <div class="muted" id="k-harvest-note"></div>
      </div>
    </div>

    <!-- Forecast chart -->
    <div class="panel section">
      <h3>Previsione prossimi 10 giorni</h3>
      <canvas id="chart"></canvas>
    </div>

    <!-- Events + Rains -->
    <div class="grid g2">
      <div class="panel section events">
        <h3>Eventi piovosi & lag</h3>
        <div id="events">‚Äî</div>
      </div>
      <div class="panel section">
        <h3>Piogge</h3>
        <div class="grid g2">
          <div>
            <div class="muted">Ultimi 15 giorni</div>
            <table id="tblPast"><thead><tr><th>Giorno</th><th>mm</th></tr></thead><tbody></tbody></table>
          </div>
          <div>
            <div class="muted">Prossimi 10 giorni</div>
            <table id="tblFuture"><thead><tr><th>Giorno</th><th>mm</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </div>

    <!-- Long dynamic analysis -->
    <div class="panel section">
      <h3>Analisi modello (estesa)</h3>
      <div id="analysis" class="muted">‚Äî</div>
    </div>

    <!-- Raw JSON -->
    <details class="panel section">
      <summary>JSON di diagnostica</summary>
      <pre id="raw" class="mono" style="white-space:pre-wrap;word-break:break-word"></pre>
    </details>

    <footer>¬© Trova Porcini ‚Äî UI estesa. Suggerimenti benvenuti.</footer>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const fmt = n => (n===null||n===undefined||isNaN(n)) ? "‚Äî" : (Math.round(n*10)/10).toString().replace('.',',');

    $('#btnGeo').addEventListener('click', async () => {
      const q = $('#q').value.trim();
      if (!q) return;
      try{
        const r = await fetch(`/api/geocode?q=${encodeURIComponent(q)}`);
        if(!r.ok) throw new Error('geocode');
        const j = await r.json();
        $('#lat').value = (j.lat || j.latitude || '').toFixed(4);
        $('#lon').value = (j.lon || j.longitude || '').toFixed(4);
      }catch(e){ alert('Geocoding non riuscito.'); }
    });

    $('#btnRun').addEventListener('click', async () => {
      const lat = parseFloat($('#lat').value);
      const lon = parseFloat($('#lon').value);
      const hours = parseInt($('#hours').value,10);
      const habitat = ($('#habitat').value||'').trim();
      const autohabitat = habitat ? 0 : 1;

      if (isNaN(lat) || isNaN(lon)) { alert('Inserisci latitudine e longitudine.'); return; }

      const url = new URL('/api/score', window.location.origin);
      url.searchParams.set('lat',lat);
      url.searchParams.set('lon',lon);
      url.searchParams.set('hours',hours);
      url.searchParams.set('autohabitat',autohabitat);
      if(habitat) url.searchParams.set('habitat', habitat);

      try{
        const r = await fetch(url.toString());
        if(!r.ok){ throw new Error('fetch'); }
        const j = await r.json();
        renderAll(j);
      }catch(e){
        console.error(e);
        alert('Errore durante l‚Äôanalisi.');
      }
    });

    function setChip(el, label, value, mode='neutral'){
      el.textContent = `${label}: ${value}`;
      el.classList.remove('ok','warn','bad');
      if(mode==='ok') el.classList.add('ok');
      else if(mode==='warn') el.classList.add('warn');
      else if(mode==='bad') el.classList.add('bad');
    }

    function renderAll(j){
      // KPIs
      $('#k-index').textContent = j.index ?? '‚Äî';
      if (j.best_window){
        $('#k-window').textContent = `giorni ${j.best_window.start+1}‚Äì${j.best_window.end+1} (media‚âà${j.best_window.mean})`;
      } else { $('#k-window').textContent = '‚Äî'; }

      const rel = Number(j.reliability ?? 0);
      const conf = Number(j.model_confidence ?? 0);
      const vpd = (j.vpd_today_hpa==null) ? null : Number(j.vpd_today_hpa);

      setChip($('#k-reliab'), 'reliability', rel.toFixed(2),
        rel>=0.75 ? 'ok' : rel>=0.55 ? 'warn' : 'bad');
      setChip($('#k-conf'), 'model confidence', conf,
        conf>=75 ? 'ok' : conf>=55 ? 'warn' : 'bad');
      if(vpd==null) setChip($('#k-vpd'),'VPD','‚Äî','warn');
      else setChip($('#k-vpd'),'VPD', `${vpd.toFixed(1)} hPa`,
        vpd<=6? 'ok' : vpd<10? 'warn' : 'bad');

      const diag = j.diagnostics || {};
      $('#k-diag').textContent = `SMI: ${diag.smi_source || '‚Äî'} (thr ${fmt(diag.smi_threshold)}) ‚Ä¢ `
        + `TWI ${fmt(diag.twi_proxy)} ‚Ä¢ Energy ${fmt(diag.energy_index)} ‚Ä¢ Habitat: ${String(j.habitat_used||'‚Äî')}`;

      // Size / Harvest
      $('#k-size').textContent = `${fmt(j.size_cm)} cm (${j.size_class || '‚Äî'})`;
      $('#k-size-range').textContent = `${fmt(j.size_range_cm?.[0])}‚Äì${fmt(j.size_range_cm?.[1])} cm`;
      $('#k-harvest').textContent = j.harvest_estimate || '‚Äî';
      $('#k-harvest-note').textContent = j.harvest_note || '';

      // Events
      const evs = j.flush_events || [];
      if(!evs.length){ $('#events').innerHTML = '<span class="muted">Nessun evento utile</span>'; }
      else{
        const ul = document.createElement('ul');
        evs.forEach(e=>{
          const li = document.createElement('li');
          const obs = e.observed ? 'osservato' : 'previsto';
          li.textContent = `${e.event_when}: ${e.event_mm} mm ‚Üí flush ~${e.lag_days} gg (${obs})`;
          ul.appendChild(li);
        });
        $('#events').innerHTML = ''; $('#events').appendChild(ul);
      }

      // Rains tables
      fillTable($('#tblPast tbody'), j.rain_past);
      fillTable($('#tblFuture tbody'), j.rain_future);

      // Chart
      drawChart($('#chart'), j.forecast || []);

      // Analysis (extended HTML from backend)
      $('#analysis').innerHTML = j.dynamic_explanation || '<span class="muted">‚Äî</span>';

      // Raw JSON
      $('#raw').textContent = JSON.stringify(j, null, 2);
    }

    function fillTable(tbody, obj){
      tbody.innerHTML = '';
      if(!obj){ return; }
      const rows = Object.entries(obj);
      rows.forEach(([d, v])=>{
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = d;
        const td2 = document.createElement('td'); td2.textContent = v;
        tr.appendChild(td1); tr.appendChild(td2);
        tbody.appendChild(tr);
      });
    }

    function drawChart(canvas, arr){
      const W = canvas.clientWidth || 800;
      const H = canvas.clientHeight || 160;
      const dpr = window.devicePixelRatio || 1;
      canvas.width = W*dpr; canvas.height = H*dpr;
      const ctx = canvas.getContext('2d');
      ctx.scale(dpr, dpr);
      ctx.clearRect(0,0,W,H);

      // axes
      ctx.strokeStyle = '#233245'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(30, H-24); ctx.lineTo(W-10, H-24); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(30, 10); ctx.lineTo(30, H-24); ctx.stroke();

      const n = Math.max(1, arr.length);
      const maxV = Math.max(100, ...arr);
      const x0 = 34, x1 = W - 16;
      const y0 = H - 26, y1 = 14;
      const sx = (x1 - x0) / Math.max(1, n-1);
      const sy = (y0 - y1) / maxV;

      // grid
      ctx.strokeStyle = 'rgba(255,255,255,.06)';
      [20,40,60,80,100].forEach(v=>{
        const y = y0 - v*sy;
        ctx.beginPath(); ctx.moveTo(x0, y); ctx.lineTo(x1, y); ctx.stroke();
        ctx.fillStyle = '#6f859b'; ctx.font = '11px system-ui';
        ctx.fillText(String(v), 4, y+4);
      });

      // line
      ctx.beginPath();
      ctx.lineWidth = 2;
      ctx.strokeStyle = '#8bb7ff';
      arr.forEach((v,i)=>{
        const x = x0 + i*sx;
        const y = y0 - v*sy;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      // points
      ctx.fillStyle = '#62d5b4';
      arr.forEach((v,i)=>{
        const x = x0 + i*sx;
        const y = y0 - v*sy;
        ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
      });

      // x labels
      ctx.fillStyle = '#8aa0b6'; ctx.font = '11px system-ui';
      for(let i=0;i<n;i++){
        const x = x0 + i*sx;
        ctx.fillText(String(i+1), x-3, H-8);
      }
    }
  </script>
</body>
</html>

