<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trova Porcini ‚Äì Analisi v2.4</title>
  <style>
    :root{
      --bg:#0b0d10; --panel:#12161b; --muted:#8aa0b6; --text:#e6eef6;
      --accent:#62d5b4; --accent-2:#8bb7ff; --danger:#ff6b6b; --warn:#ffc857; --ok:#66e28a;
      --shadow:0 8px 24px rgba(0,0,0,.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:linear-gradient(180deg,#0a0c0f 0%,#0d1218 100%);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:var(--accent-2)}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;margin-bottom:18px;flex-wrap:wrap}
    header h1{font-size:22px;margin:0}
    header .badge{padding:4px 10px;border-radius:999px;background:linear-gradient(90deg,#1b2230,#17202b);color:#cfe6ff;border:1px solid #283343}
    .panel{background:linear-gradient(180deg,#12161b,#0f141a);border:1px solid #1e2937;border-radius:var(--radius);box-shadow:var(--shadow)}
    .panel h3{margin:0 0 8px 0;font-size:18px}
    .controls{display:grid;grid-template-columns:1.1fr .8fr .8fr .8fr .8fr auto;gap:10px;align-items:end;padding:16px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type=text],input[type=number],select{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid #243142;background:#0d141b;color:var(--text)
    }
    .btn{padding:10px 14px;border-radius:12px;border:1px solid #2a384b;background:linear-gradient(180deg,#1b2430,#151c26);color:#e9f5ff;font-weight:600;cursor:pointer;transition:all 0.2s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.28)}
    .btn.success{background:linear-gradient(180deg,#28a745,#1e7e34);border-color:#1e7e34}
    .btn.secondary{background:linear-gradient(180deg,#6c757d,#545b62);border-color:#545b62}
    .grid{display:grid;gap:14px;padding:16px}
    .grid.g2{grid-template-columns:1fr 1fr}
    .grid.g3{grid-template-columns:1.1fr .9fr .9fr}
    .grid.g4{grid-template-columns:repeat(4,1fr)}
    .metric{display:flex;gap:12px;align-items:center}
    .metric .k{font-size:12px;color:var(--muted)}
    .metric .v{font-size:22px;font-weight:700}
    .chip{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #273244;background:#0f1520;color:#cfe6ff;font-size:12px}
    .chip.ok{border-color:#224733;background:#0f1a14;color:#b9f3cf}
    .chip.warn{border-color:#4a3b1a;background:#1a160f;color:#ffe0a3}
    .chip.bad{border-color:#4a1a1a;background:#1a0f10;color:#ffb9b9}
    .section{padding:16px}
    .hr{height:1px;background:linear-gradient(90deg,transparent,#253244,transparent);margin:12px 0}
    #chart{width:100%;height:160px;border-radius:12px;background:linear-gradient(180deg,#0c1015,#0b0f14);border:1px solid #1e2937}
    table{width:100%;border-collapse:collapse;border:1px solid #232f40;border-radius:12px;overflow:hidden}
    th,td{padding:8px 10px;border-bottom:1px solid #232f40;font-size:13px}
    th{background:#131922;color:#b7c9dd;text-align:left}
    tr:hover td{background:#0f141b}
    .events ul{margin:6px 0 0 18px}
    .events li{margin:2px 0}
    details{background:#0e141b;border:1px solid #203045;border-radius:12px;padding:10px}
    summary{cursor:pointer;font-weight:600}
    .muted{color:#93a7bd}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    footer{margin:24px 0 40px;color:#8aa0b6;font-size:12px;text-align:center}
    .confidence-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-top:8px}
    .confidence-item{text-align:center;padding:8px;background:#0a0f14;border-radius:8px;border:1px solid #1e2937}
    .confidence-label{font-size:10px;color:var(--muted);margin-bottom:4px}
    .confidence-value{font-size:14px;font-weight:600}
    .crowdsource{background:linear-gradient(135deg,#1a2332,#0f1419);border:2px solid #2a4a3d}
    .crowdsource h3{color:#66e28a;margin-bottom:12px}
    .input-group{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    .input-group input, .input-group select{flex:1;min-width:120px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px}
    .stat-item{text-align:center;padding:12px;background:#0a0f14;border-radius:10px;border:1px solid #1e2937}
    .stat-value{font-size:20px;font-weight:700;color:var(--accent)}
    .stat-label{font-size:11px;color:var(--muted);margin-top:4px}
    .notification{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:8px;color:white;font-weight:600;z-index:1000;transform:translateX(400px);transition:transform 0.3s ease}
    .notification.show{transform:translateX(0)}
    .notification.success{background:#28a745}
    .notification.error{background:#dc3545}
    .version-badge{background:linear-gradient(45deg,#667eea,#764ba2);padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600}
    @media (max-width: 768px) {
      .controls{grid-template-columns:1fr;gap:8px}
      .grid.g3{grid-template-columns:1fr}
      .grid.g4{grid-template-columns:1fr 1fr}
      .input-group{flex-direction:column;align-items:stretch}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üçÑ Trova Porcini ‚Äî Analisi Avanzata</h1>
      <span class="badge version-badge">v2.4.0</span>
      <span class="badge">AI Enhanced</span>
    </header>

    <!-- Controls -->
    <div class="panel">
      <div class="controls">
        <div>
          <label>Localit√† (geocoding)</label>
          <input id="q" type="text" placeholder="Es. Abbadia San Salvatore" />
        </div>
        <div>
          <label>Latitudine</label>
          <input id="lat" type="number" step="0.0001" placeholder="42.88" />
        </div>
        <div>
          <label>Longitudine</label>
          <input id="lon" type="number" step="0.0001" placeholder="11.63" />
        </div>
        <div>
          <label>Habitat</label>
          <select id="habitat">
            <option value="">(auto da OSM)</option>
            <option>castagno</option><option>faggio</option><option>quercia</option>
            <option>conifere</option><option>misto</option><option>altro</option>
          </select>
        </div>
        <div>
          <label>Ore sul campo</label>
          <select id="hours">
            <option>2</option><option selected>4</option><option>6</option><option>8</option>
          </select>
        </div>
        <div style="display:flex;gap:8px;">
          <button id="btnGeo" class="btn" title="Cerca">üîé Cerca</button>
          <button id="btnRun" class="btn" title="Analizza">üìà Analizza</button>
        </div>
      </div>
    </div>

    <!-- KPIs Principali -->
    <div class="grid g3">
      <div class="panel section">
        <h3>üéØ Indice Oggi</h3>
        <div class="metric"><div class="k">Forza flush</div><div id="k-index" class="v">‚Äî</div></div>
        <div class="hr"></div>
        <div class="metric"><div class="k">Finestra migliore</div><div id="k-window" class="v">‚Äî</div></div>
        <div style="margin-top:8px;">
          <span id="k-model-version" class="chip">v2.4.0</span>
          <span id="k-has-validations" class="chip">validazioni: ‚Äî</span>
        </div>
      </div>
      
      <div class="panel section">
        <h3>üî¨ Affidabilit√† Dettagliata</h3>
        <div class="confidence-grid">
          <div class="confidence-item">
            <div class="confidence-label">Meteo</div>
            <div id="conf-met" class="confidence-value">‚Äî</div>
          </div>
          <div class="confidence-item">
            <div class="confidence-label">Eco</div>
            <div id="conf-eco" class="confidence-value">‚Äî</div>
          </div>
          <div class="confidence-item">
            <div class="confidence-label">Hydro</div>
            <div id="conf-hydro" class="confidence-value">‚Äî</div>
          </div>
          <div class="confidence-item">
            <div class="confidence-label">Atmo</div>
            <div id="conf-atmo" class="confidence-value">‚Äî</div>
          </div>
          <div class="confidence-item">
            <div class="confidence-label">Emp</div>
            <div id="conf-emp" class="confidence-value">‚Äî</div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="metric">
          <div class="k">Overall</div>
          <div id="conf-overall" class="v" style="color:var(--accent)">‚Äî</div>
        </div>
      </div>
      
      <div class="panel section">
        <h3>üçÑ Dimensioni & Raccolto</h3>
        <div class="metric"><div class="k">Taglia media</div><div id="k-size" class="v">‚Äî</div></div>
        <div class="metric"><div class="k">Range</div><div id="k-size-range" class="v">‚Äî</div></div>
        <div class="hr"></div>
        <div class="metric"><div class="k">Raccolto atteso</div><div id="k-harvest" class="v" style="font-size:18px">‚Äî</div></div>
        <div class="muted" id="k-harvest-note" style="font-size:11px;margin-top:4px"></div>
      </div>
    </div>

    <!-- Forecast chart -->
    <div class="panel section">
      <h3>üìà Previsione Prossimi 10 Giorni</h3>
      <div style="margin-bottom:8px;color:var(--muted);font-size:12px;">
        ‚ú® <strong>Miglioramenti v2.4:</strong> Soglie dinamiche ‚Ä¢ Smoothing avanzato ‚Ä¢ Confidence multi-dimensionale
      </div>
      <canvas id="chart"></canvas>
    </div>

    <!-- Crowd-sourcing sezione -->
    <div class="panel section crowdsource">
      <h3>ü§ù Contribuisci al Miglioramento del Modello</h3>
      <div class="grid g2">
        <div>
          <h4 style="color:var(--accent);margin-bottom:8px;">‚úÖ Hai trovato porcini qui?</h4>
          <div class="input-group">
            <select id="foundSpecies">
              <option value="aereus">B. aereus (porcino nero)</option>
              <option value="reticulatus">B. reticulatus (porcino estivo)</option>
              <option value="edulis">B. edulis (porcino d'autunno)</option>
              <option value="pinophilus">B. pinophilus (porcino dei pini)</option>
            </select>
            <input type="number" id="foundQuantity" placeholder="Quantit√†" min="1" max="50" value="3">
          </div>
          <div class="input-group">
            <input type="text" id="foundNotes" placeholder="Note opzionali (dimensioni, qualit√†...)" maxlength="200">
            <button id="btnReportFound" class="btn success">üìç Segnala Ritrovamento</button>
          </div>
        </div>
        <div>
          <h4 style="color:var(--muted);margin-bottom:8px;">‚ùå Hai cercato senza trovare?</h4>
          <div class="input-group">
            <select id="searchedHours">
              <option value="1">1 ora</option>
              <option value="2">2 ore</option>
              <option value="3">3 ore</option>
              <option value="4">4+ ore</option>
            </select>
            <input type="text" id="searchNotes" placeholder="Habitat, condizioni..." maxlength="200">
          </div>
          <div class="input-group">
            <button id="btnReportSearch" class="btn secondary">üîç Segnala Ricerca Vuota</button>
          </div>
        </div>
      </div>
      <div style="margin-top:12px;padding:8px 12px;background:#0a0f14;border-radius:8px;border:1px solid #1e2937;">
        <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">üí° Perch√© √® importante segnalare anche le ricerche vuote?</div>
        <div style="font-size:12px;">I dati negativi sono cruciali per addestrare il modello ML. Aiutano a identificare condizioni che <em>sembrano</em> favorevoli ma non producono funghi.</div>
      </div>
    </div>

    <!-- Eventi + Rains -->
    <div class="grid g2">
      <div class="panel section events">
        <h3>üåßÔ∏è Eventi Piovosi & Lag</h3>
        <div id="events">‚Äî</div>
        <div style="margin-top:8px;font-size:11px;color:var(--muted);">
          üîÑ <strong>Novit√†:</strong> Soglie dinamiche adattate a SMI, stagione e quota
        </div>
      </div>
      <div class="panel section">
        <h3>üíß Piogge</h3>
        <div class="grid g2">
          <div>
            <div class="muted">Ultimi 15 giorni</div>
            <table id="tblPast"><thead><tr><th>Giorno</th><th>mm</th></tr></thead><tbody></tbody></table>
          </div>
          <div>
            <div class="muted">Prossimi 10 giorni</div>
            <table id="tblFuture"><thead><tr><th>Giorno</th><th>mm</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </div>

    <!-- Statistiche validazione -->
    <div class="panel section">
      <h3>üìä Statistiche Crowd-Sourcing</h3>
      <div class="stats-grid" id="validationStatsGrid">
        <div class="stat-item">
          <div class="stat-value" id="stat-positive">‚Äî</div>
          <div class="stat-label">Ritrovamenti</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-negative">‚Äî</div>
          <div class="stat-label">Ricerche vuote</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-total">‚Äî</div>
          <div class="stat-label">Totale dati</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-ml-ready">‚Äî</div>
          <div class="stat-label">Ready per ML</div>
        </div>
      </div>
      <div id="topSpecies" style="margin-top:12px;font-size:12px;color:var(--muted)"></div>
    </div>

    <!-- Analisi estesa -->
    <div class="panel section">
      <h3>üß† Analisi Modello (Estesa)</h3>
      <div id="analysis" class="muted">‚Äî</div>
    </div>

    <!-- Diagnostica tecnica -->
    <details class="panel section">
      <summary>üîß Diagnostica Tecnica & JSON</summary>
      <div style="margin-top:12px;">
        <h4>Parametri diagnostici</h4>
        <div id="diagnostics" class="muted mono" style="background:#0a0f14;padding:10px;border-radius:6px;font-size:11px;white-space:pre-wrap;"></div>
        <h4 style="margin-top:16px;">JSON completo</h4>
        <pre id="raw" class="mono" style="white-space:pre-wrap;word-break:break-word;background:#0a0f14;padding:10px;border-radius:6px;font-size:10px;"></pre>
      </div>
    </details>

    <footer>
      ¬© 2025 Trova Porcini v2.4 ‚Äî Modello scientifico con IA ‚Ä¢ Crowd-sourcing ‚Ä¢ Auto-miglioramento
    </footer>
  </div>

  <!-- Notification container -->
  <div id="notification" class="notification"></div>

  <script>
    const $ = sel => document.querySelector(sel);
    const fmt = n => (n===null||n===undefined||isNaN(n)) ? "‚Äî" : (Math.round(n*10)/10).toString().replace('.',',');

    // Notification system
    function showNotification(message, type = 'success') {
      const notif = $('#notification');
      notif.textContent = message;
      notif.className = `notification ${type}`;
      notif.classList.add('show');
      setTimeout(() => notif.classList.remove('show'), 3000);
    }

    // Load validation stats on startup
    loadValidationStats();

    $('#btnGeo').addEventListener('click', async () => {
      const q = $('#q').value.trim();
      if (!q) return;
      try{
        const r = await fetch(`/api/geocode?q=${encodeURIComponent(q)}`);
        if(!r.ok) throw new Error('geocode');
        const j = await r.json();
        $('#lat').value = (j.lat || j.latitude || '').toFixed(4);
        $('#lon').value = (j.lon || j.longitude || '').toFixed(4);
        showNotification('Localit√† trovata!');
      }catch(e){ 
        showNotification('Geocoding non riuscito', 'error');
      }
    });

    $('#btnRun').addEventListener('click', async () => {
      const lat = parseFloat($('#lat').value);
      const lon = parseFloat($('#lon').value);
      const hours = parseInt($('#hours').value,10);
      const habitat = ($('#habitat').value||'').trim();
      const autohabitat = habitat ? 0 : 1;

      if (isNaN(lat) || isNaN(lon)) { 
        showNotification('Inserisci latitudine e longitudine', 'error');
        return; 
      }

      const url = new URL('/api/score', window.location.origin);
      url.searchParams.set('lat',lat);
      url.searchParams.set('lon',lon);
      url.searchParams.set('hours',hours);
      url.searchParams.set('autohabitat',autohabitat);
      if(habitat) url.searchParams.set('habitat', habitat);

      try{
        $('#btnRun').textContent = '‚è≥ Analizzando...';
        $('#btnRun').disabled = true;
        
        const r = await fetch(url.toString());
        if(!r.ok){ throw new Error('fetch'); }
        const j = await r.json();
        renderAll(j);
        showNotification('Analisi completata!');
      }catch(e){
        console.error(e);
        showNotification('Errore durante l\'analisi', 'error');
      } finally {
        $('#btnRun').textContent = 'üìà Analizza';
        $('#btnRun').disabled = false;
      }
    });

    // Report sighting
    $('#btnReportFound').addEventListener('click', async () => {
      const lat = parseFloat($('#lat').value);
      const lon = parseFloat($('#lon').value);
      if (isNaN(lat) || isNaN(lon)) {
        showNotification('Inserisci prima latitudine e longitudine', 'error');
        return;
      }
      
      const species = $('#foundSpecies').value;
      const quantity = parseInt($('#foundQuantity').value) || 1;
      const notes = $('#foundNotes').value;
      
      try {
        const response = await fetch('/api/report-sighting', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lat, lon, species, quantity, notes })
        });
        
        if (response.ok) {
          showNotification('üçÑ Segnalazione registrata! Grazie per il contributo.');
          $('#foundNotes').value = '';
          loadValidationStats();
        } else {
          throw new Error('Errore server');
        }
      } catch (e) {
        showNotification('Errore durante la segnalazione', 'error');
      }
    });

    // Report no findings
    $('#btnReportSearch').addEventListener('click', async () => {
      const lat = parseFloat($('#lat').value);
      const lon = parseFloat($('#lon').value);
      if (isNaN(lat) || isNaN(lon)) {
        showNotification('Inserisci prima latitudine e longitudine', 'error');
        return;
      }
      
      const searched_hours = parseInt($('#searchedHours').value);
      const notes = $('#searchNotes').value;
      
      try {
        const response = await fetch('/api/report-no-findings', {
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lat, lon, searched_hours, notes })
        });
        
        if (response.ok) {
          showNotification('üìä Feedback registrato! I dati negativi sono preziosi.');
          $('#searchNotes').value = '';
          loadValidationStats();
        } else {
          throw new Error('Errore server');
        }
      } catch (e) {
        showNotification('Errore durante la segnalazione', 'error');
      }
    });

    // Load validation statistics
    async function loadValidationStats() {
      try {
        const response = await fetch('/api/validation-stats');
        const stats = await response.json();
        
        if (stats.error) {
          $('#stat-positive').textContent = '?';
          $('#stat-negative').textContent = '?';
          $('#stat-total').textContent = '?';
          $('#stat-ml-ready').textContent = '?';
          return;
        }
        
        $('#stat-positive').textContent = stats.positive_sightings || 0;
        $('#stat-negative').textContent = stats.negative_reports || 0;
        $('#stat-total').textContent = stats.total_validations || 0;
        $('#stat-ml-ready').textContent = stats.ready_for_ml ? 'S√å' : 'NO';
        $('#stat-ml-ready').style.color = stats.ready_for_ml ? 'var(--ok)' : 'var(--warn)';
        
        if (stats.top_species && Object.keys(stats.top_species).length > 0) {
          const speciesText = Object.entries(stats.top_species)
            .map(([sp, count]) => `${sp} (${count})`)
            .join(', ');
          $('#topSpecies').innerHTML = `<strong>Specie pi√π segnalate:</strong> ${speciesText}`;
        } else {
          $('#topSpecies').textContent = 'Nessuna segnalazione ancora';
        }
        
      } catch (e) {
        console.error('Error loading stats:', e);
      }
    }

    function setChip(el, label, value, mode='neutral'){
      el.textContent = `${label}: ${value}`;
      el.classList.remove('ok','warn','bad');
      if(mode==='ok') el.classList.add('ok');
      else if(mode==='warn') el.classList.add('warn');
      else if(mode==='bad') el.classList.add('bad');
    }

    function renderAll(j){
      // Main KPIs
      $('#k-index').textContent = j.index ?? '‚Äî';
      if (j.best_window){
        $('#k-window').textContent = `giorni ${j.best_window.start+1}‚Äì${j.best_window.end+1} (media‚âà${j.best_window.mean})`;
      } else { 
        $('#k-window').textContent = '‚Äî'; 
      }

      // Version and validations indicators
      $('#k-model-version').textContent = `v${j.model_version || '2.4.0'}`;
      $('#k-has-validations').textContent = `validazioni: ${j.has_local_validations ? 'S√å' : 'NO'}`;
      $('#k-has-validations').className = j.has_local_validations ? 'chip ok' : 'chip warn';

      // Detailed confidence (NEW in v2.4)
      if (j.confidence_detailed) {
        const conf = j.confidence_detailed;
        $('#conf-met').textContent = conf.meteorological?.toFixed(2) || '‚Äî';
        $('#conf-eco').textContent = conf.ecological?.toFixed(2) || '‚Äî';
        $('#conf-hydro').textContent = conf.hydrological?.toFixed(2) || '‚Äî';
        $('#conf-atmo').textContent = conf.atmospheric?.toFixed(2) || '‚Äî';
        $('#conf-emp').textContent = conf.empirical?.toFixed(2) || '‚Äî';
        $('#conf-overall').textContent = conf.overall?.toFixed(2) || '‚Äî';
        
        // Color-code overall confidence
        const overall = parseFloat(conf.overall || 0);
        if (overall >= 0.7) $('#conf-overall').style.color = 'var(--ok)';
        else if (overall >= 0.5) $('#conf-overall').style.color = 'var(--warn)';
        else $('#conf-overall').style.color = 'var(--danger)';
      }

      // Size / Harvest
      $('#k-size').textContent = `${fmt(j.size_cm)} cm (${j.size_class || '‚Äî'})`;
      $('#k-size-range').textContent = `${fmt(j.size_range_cm?.[0])}‚Äì${fmt(j.size_range_cm?.[1])} cm`;
      $('#k-harvest').textContent = j.harvest_estimate || '‚Äî';
      $('#k-harvest-note').textContent = j.harvest_note || '';

      // Events
      const evs = j.flush_events || [];
      if(!evs.length){ 
        $('#events').innerHTML = '<span class="muted">Nessun evento utile</span>'; 
      } else {
        const ul = document.createElement('ul');
        evs.forEach(e=>{
          const li = document.createElement('li');
          const obs = e.observed ? 'osservato' : 'previsto';
          li.textContent = `${e.event_when}: ${e.event_mm} mm ‚Üí flush ~${e.lag_days} gg (${obs})`;
          ul.appendChild(li);
        });
        $('#events').innerHTML = ''; 
        $('#events').appendChild(ul);
      }

      // Rains tables
      fillTable($('#tblPast tbody'), j.rain_past);
      fillTable($('#tblFuture tbody'), j.rain_future);

      // Chart
      drawChart($('#chart'), j.forecast || []);

      // Extended analysis
      $('#analysis').innerHTML = j.dynamic_explanation || '<span class="muted">‚Äî

