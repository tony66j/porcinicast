<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PorciniCast v0.6</title>
  <style>
    :root{--bg:#0c1222;--panel:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--accent:#10b981;--accent2:#22d3ee;--danger:#ef4444;}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0f172a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{display:flex;align-items:center;gap:.7rem;padding:14px 16px;border-bottom:1px solid #1f2937;background:rgba(15,23,42,.6);backdrop-filter:blur(8px);position:sticky;top:0;z-index:10}
    .logo{display:flex;align-items:center;gap:.5rem}
    .logo svg{width:26px;height:26px}
    .brand{font-weight:800;letter-spacing:.3px}
    main{max-width:1040px;margin:22px auto;padding:0 16px}
    .card{background:linear-gradient(180deg,#0b1220,#0f172a);border:1px solid #1f2937;border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-bottom:14px}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:14px}
    input,button{border-radius:10px;border:1px solid #334155;background:#0b1324;color:var(--text);padding:12px 14px;font-size:15px}
    button{background:linear-gradient(90deg,var(--accent2),var(--accent));border:none;cursor:pointer;color:#062f2a;font-weight:700}
    button:disabled{opacity:.5;cursor:default}
    .muted{color:var(--muted);font-size:13px}
    .score{font-size:40px;font-weight:800}
    .pill{display:inline-block;padding:2px 10px;border-radius:999px;font-size:12px;border:1px solid #1f2937;background:#0b1324}
    .ok{background:rgba(16,185,129,.15);color:#22c55e;border-color:#064e3b}
    .warn{background:rgba(245,158,11,.12);color:#f59e0b;border-color:#7c2d12}
    .bad{background:rgba(239,68,68,.12);color:#ef4444;border-color:#7f1d1d}
    .calendar{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;margin-top:8px}
    .day{height:12px;border-radius:4px;background:#1f2937}
    .day[data-v="low"]{background:#ef4444}
    .day[data-v="mid"]{background:#f59e0b}
    .day[data-v="hi"]{background:#10b981}
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px}
    details{background:#0b1324;border:1px solid #1f2937;border-radius:10px;padding:10px}
    summary{cursor:pointer;color:#a5b4fc}
    footer{margin:18px auto 36px;max-width:1040px;padding:0 16px;color:#9ca3af}
    .attribution{font-size:12px}
    .list{margin:6px 0 0 18px;line-height:1.6}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chip{font-size:12px;padding:4px 8px;border-radius:999px;background:#0b1324;border:1px solid #243244}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs><linearGradient id="g" x1="0" x2="1"><stop stop-color="#22d3ee"/><stop offset="1" stop-color="#10b981"/></linearGradient></defs>
        <path d="M12 26c0-9 10-16 20-16s20 7 20 16c0 3-6 6-16 7v7h6a2 2 0 110 4H22a2 2 0 110-4h6v-7c-10-1-16-4-16-7z" fill="url(#g)"/>
        <circle cx="32" cy="48" r="5" fill="#22d3ee"/>
      </svg>
      <div class="brand">PorciniCast</div>
    </div>
  </header>

  <main>
    <div class="card">
      <div style="display:flex;gap:8px">
        <input id="q" placeholder="Cerca una località (es. Bocca della Selva)">
        <button id="btn">Calcola idoneità</button>
      </div>
      <div class="muted" style="margin-top:6px">Indice basato su pioggia antecedente (emivita ~8 gg), bilancio idrico, finestra termica e fattori topografici. Ora include spiegazione del giudizio.</div>
    </div>

    <div class="grid">
      <div>
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div class="muted">Indice oggi (0–100)</div>
              <div class="score" id="score">—</div>
            </div>
            <div id="advice" class="pill">—</div>
          </div>
          <div id="calendar" class="calendar" title="Prossimi 10 giorni"></div>
          <div id="best" class="muted" style="margin-top:8px">Finestra migliore: —</div>
        </div>

        <div class="card" id="whyCard" style="display:none">
          <div style="font-weight:700">Perché questo giudizio?</div>
          <ul id="whyList" class="list"></ul>
        </div>

        <div class="card" id="adviceCard" style="display:none">
          <div style="font-weight:700">Consigli sul campo</div>
          <div id="adviceToday" style="margin-top:6px"></div>
          <div id="adviceNext" class="muted" style="margin-top:4px"></div>
          <ul id="adviceTips" class="list"></ul>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="kv" id="kv"></div>
        </div>

        <div class="card" id="otherCard" style="display:none">
          <div style="font-weight:700">Altri funghi possibili</div>
          <div id="otherList" class="chips"></div>
          <div class="muted" style="margin-top:6px;font-size:12px">Nota sicurezza: raccogli solo specie che riconosci con certezza.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <details>
        <summary>Metodi & note (clicca per aprire)</summary>
        <div style="font-size:14px;line-height:1.6;margin-top:6px">
          Modello v0.6: <b>pioggia antecedente a decadimento</b> (emivita ~8 giorni) → indice API*; 
          corretto con <b>ET0 FAO (7g)</b> per un proxy di umidità del suolo; <b>finestra termica</b> 10–18 °C; 
          modulatori per <b>quota/esposizione/pendenza</b>. Vengono calcolati anche <b>P7</b>, <b>P14</b>, <b>giorni dall’ultima pioggia</b>, 
          e <b>probabilità di pioggia prossime 72h</b> per spiegare il giudizio. Bosco da OSM è informativo.
          Dati: <b>Open‑Meteo</b>, <b>OpenWeather</b> (umidità/nowcast), <b>Open‑Elevation</b>, <b>Overpass/OSM</b>.
          Questo sito fornisce <i>probabilità</i>, non certezze. Creato da <b>Antonio Pio d'Aloia</b>.
        </div>
      </details>
    </div>
  </main>

  <footer>
    <div class="attribution">
      PorciniCast © <span id="y"></span> · Dati di terze parti con licenze proprie.
    </div>
  </footer>

<script>
const API_BASE = window.location.origin + "/api"; // Netlify rewrite → backend Render
const $ = (s)=>document.querySelector(s);

function cls(score){ if(score>=70) return "ok"; if(score>=60) return "warn"; return "bad"; }
function dayClass(v){ if(v>=70) return "hi"; if(v>=55) return "mid"; return "low"; }

function narrative(s){
  const msgs = { today:"", next:"", tips:[] };
  const sc = s.score_today||0;
  if (sc>=70) msgs.today = "Oggi è favorevole: buone probabilità di ritrovamento.";
  else if (sc>=60) msgs.today = "Oggi discreto: prova zone conosciute o esposizioni fresche.";
  else if (sc>=50) msgs.today = "Oggi incerto: meglio attendere 1–2 giorni o nuove piogge.";
  else msgs.today = "Oggi sconsigliato: condizioni poco favorevoli.";

  if (s.best_window && s.best_window.mean>=60){
    msgs.next = `Periodo migliore: D+${s.best_window.start} → D+${s.best_window.end} (media ${s.best_window.mean}).`;
  } else {
    const mx = Math.max(...(s.scores_next10||[0]));
    if (mx>=60){
      const i = (s.scores_next10||[]).indexOf(mx);
      msgs.next = `Giorno più promettente: D+${i} (indice ${mx}).`;
    } else {
      msgs.next = "Nei prossimi 10 giorni non emergono finestre davvero favorevoli.";
    }
  }

  if (s.humidity_now!=null && s.humidity_now<45) msgs.tips.push("Umidità bassa: privilegia conche ombreggiate e suoli profondi.");
  if ((s.rain24h_forecast_mm||0) > 5) msgs.tips.push("Pioggia in arrivo: spesso conviene andare 1–2 giorni dopo l’evento.");
  if (s.elevation_m){
    if (s.elevation_m<500) msgs.tips.push("Quota bassa: con caldo prolungato cerca esposizioni N/NE o sali di quota.");
    if (s.elevation_m>1400) msgs.tips.push("Quota alta: stagione più tardiva; osserva finestre più avanti.");
  }
  if (s.forest && /Castanea|Quercus/i.test(s.forest)) msgs.tips.push("In castagno/quercia controlla margini e radure dopo piogge regolari.");
  if (msgs.tips.length===0) msgs.tips.push("Controlla i margini di bosco e i versanti freschi; evita suoli compattati e troppo secchi.");
  return msgs;
}

async function geocode(q){
  const r = await fetch(`${API_BASE}/geocode?q=${encodeURIComponent(q)}`);
  if(!r.ok) throw new Error("geocode"); return r.json();
}
async function score(lat,lon,half=8){
  const r = await fetch(`${API_BASE}/score?lat=${lat}&lon=${lon}&half=${half}`);
  if(!r.ok) throw new Error("score"); return r.json();
}
function fillKV(container, rows){
  container.innerHTML="";
  rows.forEach(([k,v])=>{
    const div=document.createElement("div");
    div.innerHTML=`<div class="muted">${k}</div><div>${v??"—"}</div>`;
    container.appendChild(div);
  });
}

async function run(){
  const q = $("#q").value.trim(); if(!q){$("#q").focus();return;}
  $("#btn").disabled=true;
  try{
    const g = await geocode(q);
    const s = await score(g.lat,g.lon,8);
    $("#score").textContent = s.score_today;
    const pill = $("#advice"); pill.textContent = s.advice || "—"; pill.className = `pill ${cls(s.score_today)}`;

    const cal=$("#calendar"); cal.innerHTML="";
    (s.scores_next10||[]).forEach(v=>{const d=document.createElement("div");d.className="day";d.dataset.v=(v>=70?'hi':(v>=55?'mid':'low'));d.title=v;cal.appendChild(d);});
    $("#best").textContent = s.best_window? `Finestra migliore (3 giorni): D+${s.best_window.start} → D+${s.best_window.end} (media ${s.best_window.mean})` : "—";

    $("#whyCard").style.display="block";
    const ul=$("#whyList"); ul.innerHTML="";
    (s.explanation?.reasons||[]).forEach(t=>{const li=document.createElement("li");li.textContent=t;ul.appendChild(li);});

    const adv = narrative(s);
    $("#adviceCard").style.display = "block";
    $("#adviceToday").textContent = adv.today;
    $("#adviceNext").textContent  = adv.next;
    const ul2 = $("#adviceTips"); ul2.innerHTML = "";
    adv.tips.forEach(t => { const li = document.createElement("li"); li.textContent = t; ul2.appendChild(li); });

    const other = $("#otherList"); other.innerHTML="";
    if (s.other_species && s.other_species.length){
      $("#otherCard").style.display="block";
      s.other_species.forEach(name => {
        const span=document.createElement("div"); span.className="chip"; span.textContent=name; other.appendChild(span);
      });
    } else {
      $("#otherCard").style.display="none";
    }

    fillKV($("#kv"), [
      ["Località", g.display],
      ["Quota", `${Math.round(s.elevation_m)} m`],
      ["Pendenza", `${s.slope_deg.toFixed(1)}°`],
      ["Esposizione", `${s.aspect_octant} (${s.aspect_deg.toFixed(0)}°)`],
      ["Bosco (indic.)", s.forest],
      ["API* (30g, half=8)", `${s.API_star_mm} mm`],
      ["P7 / P14", `${s.P7_mm} / ${s.P14_mm} mm`],
      ["ET0 7g", `${s.ET0_7d_mm} mm`],
      ["Ultima pioggia utile", s.last_rain_days>=0 ? `${s.last_rain_days} g` : "n/d"],
      ["Prob. pioggia 72h (OM)", s.prob_rain_next3d!=null ? `${s.prob_rain_next3d}%` : "—"],
      ["Tmed 7g (Tmin–Tmax)", `${s.Tmean7_c.toFixed(1)} °C (${s.Tmin7_c.toFixed(1)}–${s.Tmax7_c.toFixed(1)})`],
      ["Umidità (ora, OWM)", s.humidity_now!=null? `${s.humidity_now}%` : "—"],
      ["Pioggia prossime 24h (OWM)", s.rain24h_forecast_mm!=null? `${s.rain24h_forecast_mm} mm` : "—"],
      ["Affidabilità stimata", s.confidence!=null ? s.confidence : "—"]
    ]);
  }catch(e){ alert("Errore durante il calcolo. Riprova tra poco."); console.error(e); }
  finally{ $("#btn").disabled=false; }
}
$("#btn").addEventListener("click", run);
document.addEventListener("keydown", e=>{ if(e.key==="Enter") run(); });
document.querySelector("#y").textContent = new Date().getFullYear();
</script>
</body>
</html>
