<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Trova Porcini — by Antonio Pio D’Aloia</title>
  <style>
    :root{--bg:#0f1b26;--panel:#15212e;--text:#eef5fb;--muted:#8fa7b8;--accent:#4caf50;--warn:#f9a825;--danger:#e53935;--border:#253548;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    header{padding:16px 20px;border-bottom:1px solid var(--border)}
    .wrap{max-width:1280px;margin:0 auto;padding:20px;display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    @media(max-width:960px){.wrap{grid-template-columns:1fr}}
    .card{background:var(--panel);padding:16px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.3);margin-bottom:16px}
    input,button{padding:10px;border-radius:10px;border:1px solid #2c3e50;font-size:15px;color:var(--text);background:#102335}
    button{cursor:pointer;font-weight:bold}
    button.ok{background:var(--accent)}
    button.warn{background:var(--warn);color:#101f26}
    .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .metric{background:#102335;padding:10px;border-radius:10px;text-align:center}
    .metric .val{font-size:1.6rem;font-weight:bold}
    #map{height:460px;border-radius:10px;overflow:hidden}
    .badge{padding:4px 8px;border-radius:8px;font-size:.8rem;margin-left:6px}
    .badge.good{background:#4caf5022;border:1px solid var(--accent);color:var(--accent)}
    .badge.warn{background:#f9a82522;border:1px solid var(--warn);color:var(--warn)}
    .badge.bad{background:#e5393522;border:1px solid var(--danger);color:var(--danger)}
    details summary{cursor:pointer;font-weight:bold;margin-top:10px}
    details p{margin:6px 0}
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>
  <header>
    <h1 style="margin:0;font-size:1.4rem;">Trova Porcini — by Antonio Pio D’Aloia</h1>
    <div class="muted" style="font-size:.85rem;">Stime basate su dati meteorologici, orografici e ambientali</div>
  </header>

  <div class="wrap">
    <div class="card">
      <!-- Input località + coordinate -->
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px">
        <input id="place" type="text" placeholder="Località (es. Abbadia San Salvatore)" style="flex:1"/>
        <button id="btnSearch" class="ok">Cerca</button>
        <input id="coords" type="text" placeholder="lat, lon (Google)" style="flex:1;min-width:220px"/>
        <button id="btnCoords" class="warn">Usa coordinate</button>
      </div>
      <div class="muted" style="font-size:0.8rem;margin-bottom:12px;">Puoi incollare le coordinate direttamente da Google Maps, ad esempio “44.12345, 11.23456”.</div>

      <div class="metrics">
        <div class="metric">
          <div class="muted">Indice</div>
          <div id="metricIndex" class="val">—</div>
        </div>
        <div class="metric">
          <div class="muted">Stima raccolto</div>
          <div id="metricHarvest" class="val">—</div>
        </div>
        <div class="metric">
          <div class="muted">Affidabilità</div>
          <div id="metricReliability" class="val">—</div>
        </div>
      </div>

      <!-- Previsione 10 giorni -->
      <div style="margin-top:14px;">
        <div class="muted" style="margin-bottom:6px;">Previsione indice 10 giorni</div>
        <div id="forecast" style="display:flex;gap:4px;align-items:flex-end;height:120px;">
          <!-- colonne generate in JS -->
        </div>
      </div>

      <!-- Specifiche (stesso elenco come richiesto) -->
      <details open>
        <summary>Specifiche (fattori considerati)</summary>
        <ul style="margin-left:18px;font-size:.9rem;">
          <li>Latitudine e longitudine</li>
          <li>Altitudine (m s.l.m.)</li>
          <li>Pendenza e esposizione del versante</li>
          <li>Piogge accumulate (P7 / P14)</li>
          <li>Bilancio idrico (API*, ET0)</li>
          <li>Temperature media/min/max</li>
          <li>Umidità relativa media</li>
          <li>Irraggiamento solare</li>
          <li>Tipo di vegetazione</li>
          <li>Finestra migliore (3 giorni)</li>
        </ul>
      </details>

      <!-- Consigli utili -->
      <details open>
        <summary>Consigli utili alla raccolta</summary>
        <ul id="tipsList" style="margin-left:18px;font-size:.9rem;"></ul>
      </details>

      <!-- Perché questa stima -->
      <details open>
        <summary>Perché questa stima?</summary>
        <ul id="whyList" style="margin-left:18px;font-size:.9rem;"></ul>
      </details>
    </div>

    <div class="card">
      <div id="map"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Utility parse coordinate string
    function parseCoords(str){
      const m = /^\s*([+-]?\\d+(?:[.,]\\d+)?)\\s*[,;\\s]\\s*([+-]?\\d+(?:[.,]\\d+)?)\\s*$/.exec((str||"").trim());
      if(!m) return null;
      const lat = parseFloat(m[1].replace(",", "."));
      const lon = parseFloat(m[2].replace(",", "."));
      if(isNaN(lat) || isNaN(lon) || lat<-90 || lat>90 || lon<-180 || lon>180) return null;
      return {lat,lon};
    }

    // Mappa
    let map, marker;
    function initMap(){
      map = L.map('map').setView([42.5,12.5], 6);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:18}).addTo(map);
      marker = L.marker([42.5,12.5]).addTo(map);
      setTimeout(()=>map.invalidateSize(), 200);
      map.on("click", e => handleCoords(e.latlng.lat, e.latlng.lng, "Punto selezionato"));
    }

    // Aggiorna previsione 10 colonne
    function updateForecast(arr){
      const cont = document.getElementById("forecast");
      cont.innerHTML = "";
      arr.forEach((val,i)=>{
        const bar = document.createElement("div");
        bar.style.flex="1";
        bar.style.background= val>=70? "#4caf50" : val>=55? "#f9a825" : "#e53935";
        bar.style.height = Math.max(4,(val/100)*100) + "px";
        const label = document.createElement("div");
        label.style.fontSize=".7rem"; label.style.position="relative"; label.style.top="-18px"; label.style.textAlign="center";
        label.textContent = val;
        bar.appendChild(label);
        cont.appendChild(bar);
      });
    }

    // Aggiorna metriche
    function updateMetrics(idx, harvest, rel){
      document.getElementById("metricIndex").textContent = idx ?? "—";
      document.getElementById("metricHarvest").textContent = harvest ?? "—";
      document.getElementById("metricReliability").textContent = rel!=null ? Math.round(rel*100)+"%" : "—";
    }

    function updateLists(reasons, tips){
      const why = document.getElementById("whyList");
      why.innerHTML=""; (reasons||[]).forEach(r=>{ const li=document.createElement("li"); li.textContent=r; why.appendChild(li); });
      const tipsList = document.getElementById("tipsList");
      tipsList.innerHTML=""; (tips||[]).forEach(t=>{ const li=document.createElement("li"); li.textContent=t; tipsList.appendChild(li); });
    }

    // Chiamate API
    async function apiGet(url){
      const r = await fetch(url);
      if(!r.ok){ const t=await r.text(); throw new Error(t||"errore richiesta"); }
      return r.json();
    }

    async function geocode(q){
      return apiGet("/api/geocode?q=" + encodeURIComponent(q));
    }

    async function getScore(lat,lon){
      return apiGet(`/api/score?lat=${lat}&lon=${lon}`);
    }

    async function handlePlace(){
      const q = document.getElementById("place").value.trim();
      if(!q){ alert("Inserisci una località valida"); return; }
      try{
        const g = await geocode(q);
        handleCoords(g.lat, g.lon, g.display);
      }catch(err){
        console.error(err);
        alert("Errore geocoding: " + err.message);
      }
    }

    async function handleCoordsStr(){
      const c = parseCoords(document.getElementById("coords").value.trim());
      if(!c){ alert("Formato coordinate non valido"); return; }
      handleCoords(c.lat, c.lon, `${c.lat.toFixed(5)}, ${c.lon.toFixed(5)}`);
    }

    async function handleCoords(lat, lon, label){
      try{
        marker.setLatLng([lat,lon]); map.setView([lat,lon], 11);
        const data = await getScore(lat, lon);
        updateForecast(data.forecast);
        updateMetrics(data.index, data.harvest_estimate, data.reliability);
        updateLists(data.explanation.reasons, data.tips);
      }catch(err){
        console.error(err);
        alert("Errore durante la ricerca: " + err.message);
      }
    }

    document.getElementById("btnSearch").addEventListener("click", handlePlace);
    document.getElementById("btnCoords").addEventListener("click", handleCoordsStr);
    document.getElementById("place").addEventListener("keydown", (e)=>{ if(e.key==="Enter") handlePlace(); });
    document.getElementById("coords").addEventListener("keydown", (e)=>{ if(e.key==="Enter") handleCoordsStr(); });

    // Avvio
    initMap();
  </script>
</body>
</html>
