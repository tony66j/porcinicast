<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TrovaPorcini v4.0</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body{background:#0f1620;color:#e8eef6;font:16px/1.4 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1150px;margin:24px auto;padding:0 14px}
  h1{font-size:24px;margin:0 0 12px}
  .by{opacity:.7;font-size:14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  .card{background:#141c27;border:1px solid #1e2a3a;border-radius:10px;padding:14px}
  label{display:block;margin:10px 0 6px;font-weight:600}
  input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid #26405b;background:#0f1a24;color:#e8eef6}
  button{padding:10px 14px;border:0;border-radius:8px;background:#1db954;color:#08121b;font-weight:700;cursor:pointer}
  button.sec{background:#2a394d;color:#e8eef6}
  .grid2{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center}
  #map{height:420px;border-radius:10px;border:1px solid #1e2a3a}
  .pill{display:inline-block;background:#1e2a3a;border-radius:18px;padding:6px 10px;margin:2px 6px 6px 0}
  details{margin-top:10px}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:13px;background:#101826;padding:10px;border-radius:8px;overflow:auto}
  @media (max-width:900px){ .row{grid-template-columns:1fr} #map{height:360px} }
</style>
</head>
<body>
<div class="wrap">
  <h1>üçÑ TrovaPorcini <span class="pill">v4.0</span> <span class="by">by Antonio Pio D‚ÄôAloia</span></h1>

  <div class="card">
    <div class="grid2">
      <input id="q" type="text" placeholder="Localit√† o coordinate (lat,lon) ‚Äî es. 41,41948, 14,47275"/>
      <button id="go">Calcola</button>
      <button id="clr" class="sec">Pulisci</button>
    </div>
  </div>

  <div class="row" style="margin-top:14px">
    <div class="card">
      <div id="head">
        <span class="pill" id="idx">Indice: ‚Äì</span>
        <span class="pill" id="caps">Stima 3h: ‚Äì cappelli</span>
        <span class="pill" id="rain">Pioggia: ‚Äì</span>
      </div>

      <label>Previsione (prossimi 10 giorni)</label>
      <input id="day" type="range" min="0" max="9" value="0" style="width:100%"/>

      <details open>
        <summary><b>Consigli pratici</b> (cambiano per il giorno selezionato)</summary>
        <div id="adv">‚Äî</div>
      </details>

      <details open>
        <summary><b>Perch√© questa stima</b></summary>
        <div id="why">‚Äî</div>
      </details>

      <details>
        <summary><b>Specie di porcini probabili</b></summary>
        <div id="species">‚Äî</div>
      </details>

      <details>
        <summary><b>Dati tecnici</b></summary>
        <div class="mono" id="tech">‚Äî</div>
      </details>
    </div>

    <div class="card">
      <div id="map"></div>
      <div style="opacity:.8;margin-top:6px">Legenda cerchio: colore = indice del giorno selezionato.</div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API = location.origin.replace(/\/$/,'')  // Netlify -> stesso dominio (proxy/redirect)

function parseCoords(s){
  if(!s) return null;
  s = s.trim();
  // accetta: "41,41948, 14,47275" | "41.41948 14.47275" | "41.41948;14.47275"
  // sostituisco ‚Äú;‚Äù con ‚Äú,‚Äù e spazi multipli con ‚Äú,‚Äù
  s = s.replace(/;/g,',').replace(/\s+/g,',');
  // ora splitto e converto le virgole decimali (italiano) in punti
  const parts = s.split(',').filter(Boolean);
  if(parts.length < 2) return null;
  // se ci sono pi√π di 2 pezzi, provo a ricomporre (es. "41,41948,14,47275")
  function toFloat(x){ return parseFloat(x.replace(',', '.')); }
  let lat=null, lon=null;
  if(parts.length===2){ lat=toFloat(parts[0]); lon=toFloat(parts[1]); }
  else {
    // prendo i primi due pezzi ‚Äúdecimali ragionevoli‚Äù
    let nums = parts.map(toFloat).filter(x => !isNaN(x));
    if(nums.length>=2){ lat=nums[0]; lon=nums[1]; }
  }
  if(isNaN(lat)||isNaN(lon) || Math.abs(lat)>90 || Math.abs(lon)>180) return null;
  return {lat, lon};
}

function $(id){ return document.getElementById(id); }

let state = { lat:null, lon:null, data:null, marker:null, circle:null, map:null };

async function geocodeOrCoords(){
  const raw = $("q").value;
  const c = parseCoords(raw);
  if(c) return c; // usa direttamente le coordinate
  // altrimenti geocoding
  const r = await fetch(`/api/geocode?q=${encodeURIComponent(raw)}`);
  const j = await r.json();
  if(j.error){ alert("Errore: Localit√† non trovata"); return null; }
  $("q").value = j.display || `${j.lat},${j.lon}`;
  return {lat:j.lat, lon:j.lon};
}

function circleColor(score){
  if(score>=75) return "#2ecc71";
  if(score>=55) return "#f1c40f";
  if(score>=35) return "#e67e22";
  return "#e74c3c";
}

function updateUI(day){
  if(!state.data) return;
  const d = state.data;
  const idx = d.scores_next10[day];
  $("idx").textContent = `Indice: ${idx}`;
  if(day===0 && d.caps3h_est){
    $("caps").textContent = `Stima 3h: ${d.caps3h_est.low}‚Äì${d.caps3h_est.high} cappelli`;
  }else{
    $("caps").textContent = `Stima 3h: ‚Äì cappelli`;
  }
  $("rain").textContent = `Pioggia: ultimi 14 gg ${d.P14_mm} mm; prossimi 10 gg ${d.tech.sum_next10mm} mm`;

  $("adv").textContent = (d.advice_all && d.advice_all[day]) || d.advice_today || "‚Äî";
  $("why").textContent = (d.why_all && d.why_all[day]) || d.why_today || "‚Äî";

  const species = (d.forest||"").includes("Castanea") ? "Boletus pinophilus, Boletus edulis"
                  : (d.forest||"").includes("Fagus") ? "Boletus edulis"
                  : "Boletus reticulatus (estivo)";
  $("species").textContent = species;

  $("tech").textContent = JSON.stringify({
    lat:d.lat, lon:d.lon, elev_m:d.elev_m, slope_deg:d.slope_deg,
    aspect_deg:d.aspect_deg, aspect_octant:d.aspect_octant,
    forest:d.forest, P14_mm:d.P14_mm, Tmean7_c:d.Tmean7_c,
    humidity_mean:d.humidity_mean, radiation_MJm2:d.radiation_MJm2,
    last_rain_days:d.tech.last_rain_days, next_rain_in_days:d.tech.next_rain_in_days
  }, null, 2);

  // mappa: colore del giorno selezionato
  if(state.circle){
    state.circle.setStyle({color:circleColor(idx), fillColor:circleColor(idx)});
  }
}

async function run(){
  const c = await geocodeOrCoords();
  if(!c) return;
  state.lat = c.lat; state.lon = c.lon;

  const url = `/api/score?lat=${c.lat}&lon=${c.lon}`;
  let j;
  try{
    const r = await fetch(url);
    j = await r.json();
  }catch(e){
    alert("Errore: API non raggiungibile"); return;
  }
  if(j.error){ alert("Errore API"); return; }
  state.data = j;
  $("day").value = 0;
  updateUI(0);

  // mappa
  if(!state.map){
    state.map = L.map('map',{scrollWheelZoom:true}).setView([c.lat,c.lon], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19, attribution:'¬© OpenStreetMap'
    }).addTo(state.map);
  }else{
    state.map.setView([c.lat,c.lon], state.map.getZoom());
  }
  if(state.marker){ state.map.removeLayer(state.marker); }
  if(state.circle){ state.map.removeLayer(state.circle); }
  state.marker = L.marker([c.lat,c.lon]).addTo(state.map);
  state.circle = L.circle([c.lat,c.lon], {
    radius: 1200, color: circleColor(j.scores_next10[0]),
    fillColor: circleColor(j.scores_next10[0]), fillOpacity: 0.15, weight:2
  }).addTo(state.map);
}

$("go").onclick = run;
$("clr").onclick = ()=>{ $("q").value=""; };
$("day").oninput = e => updateUI(parseInt(e.target.value,10));
</script>
</body>
</html>






