<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Trova Porcini</title>
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://tile.openstreetmap.org">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <style>
    :root{--bg:#0c1222;--panel:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--accent:#10b981;--accent2:#22d3ee;--danger:#ef4444;}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0f172a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{display:flex;align-items:center;gap:.7rem;padding:14px 16px;border-bottom:1px solid #1f2937;background:rgba(15,23,42,.6);backdrop-filter:blur(8px);position:sticky;top:0;z-index:10}
    .logo{display:flex;align-items:center;gap:.5rem}
    .logo svg{width:26px;height:26px}
    .brand{font-weight:800;letter-spacing:.3px}
    main{max-width:1180px;margin:22px auto;padding:0 16px}
    .card{background:linear-gradient(180deg,#0b1220,#0f172a);border:1px solid #1f2937;border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-bottom:14px}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:14px}
    input,button{border-radius:10px;border:1px solid #334155;background:#0b1324;color:var(--text);padding:12px 14px;font-size:15px}
    button{background:linear-gradient(90deg,var(--accent2),var(--accent));border:none;cursor:pointer;color:#062f2a;font-weight:700}
    button:disabled{opacity:.5;cursor:default}
    .muted{color:var(--muted);font-size:13px}
    .score{font-size:40px;font-weight:800}
    .pill{display:inline-block;padding:2px 10px;border-radius:999px;font-size:12px;border:1px solid #1f2937;background:#0b1324}
    .ok{background:rgba(16,185,129,.15);color:#22c55e;border-color:#064e3b}
    .warn{background:rgba(245,158,11,.12);color:#f59e0b;border-color:#7c2d12}
    .bad{background:rgba(239,68,68,.12);color:#ef4444;border-color:#7f1d1d}
    .calendar{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;margin-top:8px}
    .day{height:12px;border-radius:4px;background:#1f2937}
    .day[data-v="low"]{background:#ef4444}
    .day[data-v="mid"]{background:#f59e0b}
    .day[data-v="hi"]{background:#10b981}
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px}
    details{background:#0b1324;border:1px solid #1f2937;border-radius:10px;padding:10px}
    summary{cursor:pointer;color:#a5b4fc}
    footer{margin:18px auto 36px;max-width:1180px;padding:0 16px;color:#9ca3af}
    .attribution{font-size:12px}
    .list{margin:6px 0 0 18px;line-height:1.6}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chip{font-size:12px;padding:4px 8px;border-radius:999px;background:#0b1324;border:1px solid #243244}
    #map{height:420px;border-radius:12px;overflow:hidden}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .status{position:fixed;right:12px;top:10px;background:#1a2334;border:1px solid #2b3950;padding:6px 10px;border-radius:10px;font-size:12px}
    .status.err{background:#3a1111;border-color:#7d1f1f;color:#ffdede}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div id="status" class="status">Diagnostica: avvio‚Ä¶</div>
  <header>
    <div class="logo">
      <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs><linearGradient id="g" x1="0" x2="1"><stop stop-color="#22d3ee"/><stop offset="1" stop-color="#10b981"/></linearGradient></defs>
        <path d="M12 26c0-9 10-16 20-16s20 7 20 16c0 3-6 6-16 7v7h6a2 2 0 110 4H22a2 2 0 110-4h6v-7c-10-1-16-4-16-7z" fill="url(#g)"/>
        <circle cx="32" cy="48" r="5" fill="#22d3ee"/>
      </svg>
      <div class="brand">Trova Porcini</div>
    </div>
  </header>

  <main>
    <div class="card">
      <div class="row">
        <input id="q" placeholder="Cerca una localit√† (es. Benevento) o clicca sulla mappa">
        <button id="btn">Calcola idoneit√†</button>
        <button id="geo" title="Usa la mia posizione">üìç</button>
      </div>
      <div class="muted" style="margin-top:6px">
        Indice basato su pioggia antecedente a decadimento (emivita ~8 gg), bilancio idrico (ET0), finestra termica, fattori topografici
        e contesto forestale. Include spiegazione e consigli.
      </div>
    </div>

    <div class="grid">
      <div>
        <div class="card" id="map"></div>

        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div class="muted">Indice oggi (0‚Äì100)</div>
              <div class="score" id="score">‚Äî</div>
            </div>
            <div id="advice" class="pill">‚Äî</div>
          </div>
          <div id="calendar" class="calendar" title="Prossimi 10 giorni"></div>
          <div id="best" class="muted" style="margin-top:8px">Finestra migliore: ‚Äî</div>
        </div>

        <div class="card" id="whyCard" style="display:none">
          <div style="font-weight:700">Perch√© questo giudizio?</div>
          <ul id="whyList" class="list"></ul>
        </div>

        <div class="card" id="adviceCard" style="display:none">
          <div style="font-weight:700">Consigli sul campo</div>
          <div id="adviceToday" style="margin-top:6px"></div>
          <div id="adviceNext" class="muted" style="margin-top:4px"></div>
          <ul id="adviceTips" class="list"></ul>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="kv" id="kv"></div>
        </div>

        <div class="card" id="otherCard" style="display:none">
          <div style="font-weight:700">Altri funghi possibili</div>
          <div id="otherList" class="chips"></div>
          <div class="muted" style="margin-top:6px;font-size:12px">Nota sicurezza: raccogli solo specie che riconosci con certezza.</div>
        </div>

        <div class="card">
          <details>
            <summary>Metodi & note (clicca per aprire)</summary>
            <div style="font-size:14px;line-height:1.6;margin-top:6px">
              Modello v0.6: <b>API*</b> (precipitazione con decadimento, emivita ~8 giorni) corretta con <b>ET0 FAO</b> (7g),
              <b>finestra termica</b> 10‚Äì18 ¬∞C, modulatori topografici (quota, pendenza, esposizione), contesto forestale OSM.
              Simulazione dei prossimi 10 giorni con aggiornamento dell‚ÄôAPI* e finestra migliore 3gg. 
              Dati: Open-Meteo, Open-Elevation, Overpass/OSM e (facoltativo) OpenWeather.
            </div>
          </details>
        </div>
      </div>
    </div>

    <footer>
      <div class="attribution">By Antonio Pio D‚Äôaloia ‚Äî Dati di terze parti con licenze proprie.</div>
    </footer>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // Usa il proxy Netlify: /api ‚Üí backend Render
    const API_BASE = window.location.origin + "/api";
    const $ = (s)=>document.querySelector(s);
    function cls(score){ if(score>=70) return "ok"; if(score>=60) return "warn"; return "bad"; }
    function dayClass(v){ if(v>=70) return "hi"; if(v>=55) return "mid"; return "low"; }
    function setStatus(t,err=false){ const el=$("#status"); el.textContent="Diagnostica: "+t; el.className="status"+(err?" err":""); }

    // ---- mappa ----
    let map, marker;
    function initMap(){
      map = L.map('map', {zoomControl:true}).setView([42.5,12.5], 6);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:18, attribution:'&copy; OpenStreetMap'}).addTo(map);
      marker = L.marker([42.5,12.5]).addTo(map);
      setTimeout(()=>map.invalidateSize(),150);
      map.on("click", async (e)=>{
        await runWithCoords(e.latlng.lat, e.latlng.lng, "Punto sulla mappa");
      });
    }

    async function ping(){
      try{
        const r = await fetch(API_BASE + "/health");
        if(r.ok){ setStatus("backend OK ‚úî"); } else { setStatus("backend non risponde", true); }
      }catch{ setStatus("errore rete verso backend", true); }
    }

    async function geocode(q){
      const r = await fetch(`${API_BASE}/geocode?q=${encodeURIComponent(q)}`);
      if(!r.ok) throw new Error("geocode"); return r.json();
    }
    async function score(lat,lon,half=8){
      const r = await fetch(`${API_BASE}/score?lat=${lat}&lon=${lon}&half=${half}`);
      if(!r.ok) throw new Error("score"); return r.json();
    }

    function narrative(s){
      const msgs = { today:"", next:"", tips:[] };
      const sc = s.score_today||0;
      if (sc>=70) msgs.today = "Oggi √® favorevole: buone probabilit√† di ritrovamento.";
      else if (sc>=60) msgs.today = "Oggi discreto: prova zone conosciute o esposizioni fresche.";
      else if (sc>=50) msgs.today = "Oggi incerto: meglio attendere 1‚Äì2 giorni o nuove piogge.";
      else msgs.today = "Oggi sconsigliato: condizioni poco favorevoli.";
      if (s.best_window && s.best_window.mean>=60){
        msgs.next = `Periodo migliore: D+${s.best_window.start} ‚Üí D+${s.best_window.end} (media ${s.best_window.mean}).`;
      } else {
        const mx = Math.max(...(s.scores_next10||[0]));
        if (mx>=60){
          const i = (s.scores_next10||[]).indexOf(mx);
          msgs.next = `Giorno pi√π promettente: D+${i} (indice ${mx}).`;
        } else {
          msgs.next = "Nei prossimi 10 giorni non emergono finestre davvero favorevoli.";
        }
      }
      if (s.humidity_now!=null && s.humidity_now<45) msgs.tips.push("Umidit√† bassa: privilegia conche ombreggiate e suoli profondi.");
      if ((s.rain24h_forecast_mm||0) > 5) msgs.tips.push("Pioggia in arrivo: spesso conviene andare 1‚Äì2 giorni dopo l‚Äôevento.");
      if (s.elevation_m){
        if (s.elevation_m<500) msgs.tips.push("Quota bassa: con caldo prolungato cerca esposizioni N/NE o sali di quota.");
        if (s.elevation_m>1400) msgs.tips.push("Quota alta: stagione pi√π tardiva; osserva finestre pi√π avanti.");
      }
      if (s.forest && /Castanea|Quercus/i.test(s.forest)) msgs.tips.push("In castagno/quercia controlla margini e radure dopo piogge regolari.");
      if (msgs.tips.length===0) msgs.tips.push("Controlla i margini di bosco e i versanti freschi; evita suoli compattati e troppo secchi.");
      return msgs;
    }

    function fillKV(container, rows){
      container.innerHTML="";
      rows.forEach(([k,v])=>{
        const div=document.createElement("div");
        div.innerHTML=`<div class="muted">${k}</div><div>${v??"‚Äî"}</div>`;
        container.appendChild(div);
      });
    }

    async function run(){
      const q = $("#q").value.trim(); if(!q){$("#q").focus();return;}
      $("#btn").disabled=true;
      try{
        const g = await geocode(q);
        await runWithCoords(g.lat, g.lon, g.display);
      }catch(e){ alert("Errore durante il calcolo. Riprova tra poco."); console.error(e); }
      finally{ $("#btn").disabled=false; }
    }

    async function runWithCoords(lat, lon, displayName){
      try{
        $("#btn").disabled=true;
        marker.setLatLng([lat,lon]); map.setView([lat,lon], 11);
        const s = await score(lat, lon, 8);

        $("#score").textContent = s.score_today;
        const pill = $("#advice"); pill.textContent = s.advice || "‚Äî"; pill.className = `pill ${cls(s.score_today)}`;

        const cal=$("#calendar"); cal.innerHTML="";
        (s.scores_next10||[]).forEach(v=>{
          const d=document.createElement("div"); d.className="day"; d.dataset.v=(v>=70?'hi':(v>=55?'mid':'low')); d.title=v; cal.appendChild(d);
        });
        $("#best").textContent = s.best_window? `Finestra migliore (3 giorni): D+${s.best_window.start} ‚Üí D+${s.best_window.end} (media ${s.best_window.mean})` : "‚Äî";

        $("#whyCard").style.display="block";
        const ul=$("#whyList"); ul.innerHTML="";
        (s.explanation?.reasons||[]).forEach(t=>{const li=document.createElement("li");li.textContent=t;ul.appendChild(li);});

        const adv = narrative(s);
        $("#adviceCard").style.display = "block";
        $("#adviceToday").textContent = adv.today;
        $("#adviceNext").textContent  = adv.next;
        const ul2 = $("#adviceTips"); ul2.innerHTML = "";
        adv.tips.forEach(t => { const li = document.createElement("li"); li.textContent = t; ul2.appendChild(li); });

        const other = $("#otherList"); other.innerHTML="";
        if (s.other_species && s.other_species.length){
          $("#otherCard").style.display="block";
          s.other_species.forEach(name => {
            const span=document.createElement("div"); span.className="chip"; span.textContent=name; other.appendChild(span);
          });
        } else { $("#otherCard").style.display="none"; }

        fillKV($("#kv"), [
          ["Localit√†", displayName],
          ["Quota", `${Math.round(s.elevation_m)} m`],
          ["Pendenza", `${s.slope_deg.toFixed(1)}¬∞`],
          ["Esposizione", `${s.aspect_octant} (${s.aspect_deg.toFixed(0)}¬∞)`],
          ["Bosco (indic.)", s.forest],
          ["API* (30g, half=8)", `${s.API_star_mm} mm`],
          ["P7 / P14", `${s.P7_mm} / ${s.P14_mm} mm`],
          ["ET0 7g", `${s.ET0_7d_mm} mm`],
          ["Ultima pioggia utile", s.last_rain_days>=0 ? `${s.last_rain_days} giorni fa` : "n/d"],
          ["Prob. pioggia 72h (OM)", s.prob_rain_next3d!=null ? `${s.prob_rain_next3d}%` : "‚Äî"],
          ["Tmed 7g (Tmin‚ÄìTmax)", `${s.Tmean7_c.toFixed(1)} ¬∞C (${s.Tmin7_c.toFixed(1)}‚Äì${s.Tmax7_c.toFixed(1)})`],
          ["Umidit√† (ora, OWM)", s.humidity_now!=null? `${s.humidity_now}%` : "‚Äî"],
          ["Pioggia prossime 24h (OWM)", s.rain24h_forecast_mm!=null? `${s.rain24h_forecast_mm} mm` : "‚Äî"],
          ["Affidabilit√† stimata", s.confidence!=null ? s.confidence : "‚Äî"]
        ]);
      }catch(e){ alert("Errore durante il calcolo. Riprova tra poco."); console.error(e); }
      finally{ $("#btn").disabled=false; }
    }

    document.addEventListener("keydown", e=>{ if(e.key==="Enter") run(); });
    $("#btn").addEventListener("click", run);
    $("#geo").addEventListener("click", ()=>{
      if(!navigator.geolocation){ alert("Geolocalizzazione non supportata"); return; }
      navigator.geolocation.getCurrentPosition(
        (pos)=> runWithCoords(pos.coords.latitude, pos.coords.longitude, "La mia posizione"),
        ()=> alert("Impossibile ottenere la posizione")
      );
    });

    initMap(); ping();
  </script>
</body>
</html>




