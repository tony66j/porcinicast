<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Trovapolcini by Antonio D‚ÄôAloia</title>
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://tile.openstreetmap.org">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    :root{
      --bg:#0c1222; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#10b981; --accent2:#22d3ee; --danger:#ef4444;
      --border:#1f2937; --chip:#0b1324;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0f172a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{display:flex;align-items:center;gap:.7rem;padding:14px 16px;border-bottom:1px solid var(--border);background:rgba(15,23,42,.6);backdrop-filter:blur(8px);position:sticky;top:0;z-index:10}
    .logo{display:flex;align-items:center;gap:.5rem}
    .logo svg{width:26px;height:26px}
    .brand{font-weight:800;letter-spacing:.3px}
    main{max-width:1180px;margin:22px auto;padding:0 16px}
    .card{background:linear-gradient(180deg,#0b1220,#0f172a);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-bottom:14px}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:14px}
    input,button{border-radius:10px;border:1px solid #334155;background:#0b1324;color:var(--text);padding:12px 14px;font-size:15px}
    button{background:linear-gradient(90deg,var(--accent2),var(--accent));border:none;cursor:pointer;color:#062f2a;font-weight:700}
    button:disabled{opacity:.5;cursor:default}
    .muted{color:var(--muted);font-size:13px}
    .score{font-size:40px;font-weight:800}
    .pill{display:inline-block;padding:4px 12px;border-radius:999px;font-size:13px;border:1px solid var(--border);background:#0b1324}
    .ok{background:rgba(16,185,129,.15);color:#22c55e;border-color:#064e3b}
    .warn{background:rgba(245,158,11,.12);color:#f59e0b;border-color:#7c2d12}
    .bad{background:rgba(239,68,68,.12);color:#ef4444;border-color:#7f1d1d}
    .calendar{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;margin-top:8px}
    .day{height:12px;border-radius:4px;background:#1f2937}
    .day[data-v="low"]{background:#ef4444}
    .day[data-v="mid"]{background:#f59e0b}
    .day[data-v="hi"]{background:#10b981}
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px}
    details{background:#0b1324;border:1px solid var(--border);border-radius:10px;padding:10px}
    summary{cursor:pointer;color:#a5b4fc}
    footer{margin:18px auto 36px;max-width:1180px;padding:0 16px;color:#9ca3af}
    .attribution{font-size:12px}
    .list{margin:6px 0 0 18px;line-height:1.6}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chip{font-size:12px;padding:4px 8px;border-radius:999px;background:var(--chip);border:1px solid #243244}
    #map{height:420px;border-radius:12px;overflow:hidden}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .status{position:fixed;right:12px;top:10px;background:#1a2334;border:1px solid #2b3950;padding:6px 10px;border-radius:10px;font-size:12px}
    .status.err{background:#3a1111;border-color:#7d1f1f;color:#ffdede}
    .hstack{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .twocol{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .table{border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .tr{display:grid;grid-template-columns:1fr 1fr;padding:8px 10px;border-bottom:1px solid #1f2937}
    .tr.head{background:#0b1324;color:#cbd5e1;font-weight:700}
    .tr:last-child{border-bottom:none}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div id="status" class="status">Diagnostica: avvio‚Ä¶</div>
  <header>
    <div class="logo">
      <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs><linearGradient id="g" x1="0" x2="1"><stop stop-color="#22d3ee"/><stop offset="1" stop-color="#10b981"/></linearGradient></defs>
        <path d="M12 26c0-9 10-16 20-16s20 7 20 16c0 3-6 6-16 7v7h6a2 2 0 110 4H22a2 2 0 110-4h6v-7c-10-1-16-4-16-7z" fill="url(#g)"/>
        <circle cx="32" cy="48" r="5" fill="#22d3ee"/>
      </svg>
      <div class="brand">Trovapolcini by Antonio D‚ÄôAloia</div>
    </div>
  </header>

  <main>
    <div class="card">
      <div class="hstack">
        <input id="qPlace" placeholder="Localit√† (es. Benevento)">
        <button id="btnPlace">Cerca localit√†</button>
        <input id="qCoords" placeholder="Coordinate (incolla da Google: 41.12345, 14.67890)" style="min-width:320px">
        <button id="btnCoords">Usa coordinate</button>
        <button id="btnGeo" title="Usa la mia posizione">üìç</button>
      </div>
      <div class="muted" style="margin-top:6px">
        Suggerimento: su Google Maps fai click destro su un punto ‚Üí copia le coordinate (es. ‚Äú41.127, 14.782‚Äù) e incollale qui.
      </div>
    </div>

    <div class="grid">
      <div>
        <div class="card" id="map"></div>

        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div class="muted">Indice oggi (0‚Äì10)</div>
              <div class="score" id="score">‚Äî</div>
            </div>
            <div id="advice" class="pill">‚Äî</div>
          </div>
          <div id="best" class="muted" style="margin-top:8px">Indicazioni basate su piogge, temperatura e umidit√† (OpenWeather).</div>
        </div>

        <div class="card twocol">
          <div>
            <div style="font-weight:700;margin-bottom:6px">Piogge future (prossimi giorni)</div>
            <div class="table" id="rainFuture">
              <div class="tr head"><div>Data</div><div>mm</div></div>
            </div>
          </div>
          <div>
            <div style="font-weight:700;margin-bottom:6px">Piogge passate (ultimi giorni)</div>
            <div class="table" id="rainPast">
              <div class="tr head"><div>Data</div><div>mm</div></div>
            </div>
          </div>
        </div>

        <div class="card" id="adviceCard" style="display:none">
          <div style="font-weight:700">Consigli sul campo</div>
          <ul id="adviceTips" class="list"></ul>
        </div>
      </div>

      <div>
        <div class="card">
          <div style="font-weight:700;margin-bottom:6px">Stima raccolto (2 ore)</div>
          <div id="harvest" class="pill">‚Äî</div>
        </div>

        <div class="card">
          <div class="kv" id="kv"></div>
        </div>

        <div class="card">
          <details>
            <summary>Metodi & note (clicca per aprire)</summary>
            <div style="font-size:14px;line-height:1.6;margin-top:6px">
              Modello ‚Äúavanzato‚Äù: piogge passate/future (OpenWeather), temperatura media e umidit√† previste (5 giorni),
              altitudine da Open-Elevation, normalizzazione in indice 0‚Äì10 e stima **porcini/2h**.  
              Dati: OpenWeather (richiede chiave, gi√† impostata), Open-Elevation (gratuito), Nominatim (geocoding).
            </div>
          </details>
        </div>
      </div>
    </div>

    <footer>
      <div class="attribution">¬© Trovapolcini ‚Äî By Antonio D‚ÄôAloia. Dati di terze parti con licenze proprie.</div>
    </footer>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // ========= Helpers =========
    const $ = (s)=>document.querySelector(s);
    function setStatus(t,err=false){ const el=$("#status"); el.textContent="Diagnostica: "+t; el.className="status"+(err?" err":""); }
    const COORD_RE=/^\s*([+-]?\d+(?:[.,]\d+)?)\s*[,;\s]\s*([+-]?\d+(?:[.,]\d+)?)\s*$/;
    function parseCoords(txt){
      const m=COORD_RE.exec((txt||"").trim()); if(!m) return null;
      const lat=parseFloat(m[1].replace(",", ".")); const lon=parseFloat(m[2].replace(",", "."));
      if(!(isFinite(lat)&&isFinite(lon))) return null; if(lat<-90||lat>90||lon<-180||lon>180) return null; return {lat,lon};
    }
    function clsIdx(idx){ if(idx>=8) return "ok"; if(idx>=5) return "warn"; return "bad"; }

    // ========= Map =========
    let map, marker;
    function initMap(){
      map = L.map('map', {zoomControl:true}).setView([42.5,12.5], 6);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:18, attribution:'&copy; OpenStreetMap'}).addTo(map);
      marker = L.marker([42.5,12.5]).addTo(map);
      setTimeout(()=>map.invalidateSize(),150);
      map.on("click", async (e)=> runWithCoords(e.latlng.lat, e.latlng.lng, "Punto sulla mappa"));
    }

    // ========= Geocoding / Elevation =========
    async function geocodePlace(q){
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1&addressdetails=1`;
      const r = await fetch(url, {headers:{"Accept":"application/json"}});
      if(!r.ok) throw new Error("Geocoder non disponibile");
      const j = await r.json(); if(!j || !j.length) throw new Error("Localit√† non trovata");
      return {lat: parseFloat(j[0].lat), lon: parseFloat(j[0].lon), display: j[0].display_name};
    }
    async function getElevation(lat,lon){
      try{
        const r = await fetch("https://api.open-elevation.com/api/v1/lookup", {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({locations:[{latitude:lat, longitude:lon}]})
        });
        if(!r.ok) return null;
        const j = await r.json();
        return j?.results?.[0]?.elevation ?? null;
      }catch{ return null; }
    }

    // ========= Backend call =========
    const API_BASE = window.location.origin + "/api"; // usa proxy Netlify
    async function callScore(lat, lon, alt){
      const url = new URL(API_BASE + "/score");
      url.searchParams.set("lat", lat); url.searchParams.set("lon", lon);
      if(alt!=null) url.searchParams.set("alt", alt);
      const r = await fetch(url.toString(), {headers:{"Accept":"application/json"}});
      if(!r.ok){ const t=await r.text(); throw new Error("Backend: "+t); }
      return r.json();
    }

    // ========= Render UI =========
    function renderTables(past, future){
      const pastEl = $("#rainPast"); const futEl = $("#rainFuture");
      pastEl.innerHTML = '<div class="tr head"><div>Data</div><div>mm</div></div>';
      futEl.innerHTML  = '<div class="tr head"><div>Data</div><div>mm</div></div>';
      // ordina per data
      const pkeys = Object.keys(past||{}).sort();
      const fkeys = Object.keys(future||{}).sort();
      pkeys.forEach(d=>{
        const tr=document.createElement("div"); tr.className="tr";
        tr.innerHTML = `<div>${d}</div><div>${Number(past[d]).toFixed(1)}</div>`;
        pastEl.appendChild(tr);
      });
      fkeys.forEach(d=>{
        const tr=document.createElement("div"); tr.className="tr";
        tr.innerHTML = `<div>${d}</div><div>${Number(future[d]).toFixed(1)}</div>`;
        futEl.appendChild(tr);
      });
    }
    function fillKV(rows){
      const container=$("#kv"); container.innerHTML="";
      rows.forEach(([k,v])=>{
        const div=document.createElement("div");
        div.innerHTML=`<div class="muted">${k}</div><div>${v??"‚Äî"}</div>`;
        container.appendChild(div);
      });
    }
    function renderAll(displayName, lat, lon, data){
      // indice e stima
      $("#score").textContent = data.indice_attuale ?? "‚Äî";
      const pill=$("#advice");
      const cls = clsIdx(data.indice_attuale||0);
      pill.className = `pill ${cls}`;
      pill.textContent = data.stima_raccolto || "‚Äî";
      // piogge
      renderTables(data.piogge_passate, data.piogge_future);
      // consigli
      const tipsEl=$("#adviceCard"); const ul=$("#adviceTips");
      ul.innerHTML=""; (data.consigli||[]).forEach(t=>{ const li=document.createElement("li"); li.textContent=t; ul.appendChild(li); });
      tipsEl.style.display = (data.consigli && data.consigli.length) ? "block" : "none";
      // fattori
      const f = data.fattori||{};
      fillKV([
        ["Localit√†", displayName],
        ["Lat/Lon", `${lat.toFixed(5)}, ${lon.toFixed(5)}`],
        ["Altitudine usata", (f.altitudine!=null? `${Math.round(f.altitudine)} m` : "‚Äî")],
        ["Temp media 5gg", (f.temperatura_media!=null? `${f.temperatura_media} ¬∞C`:"‚Äî")],
        ["Umidit√† media 5gg", (f.umidita_media!=null? `${f.umidita_media}%`:"‚Äî")],
        ["Pioggia tot passata", (f.pioggia_tot_passata_mm!=null? `${f.pioggia_tot_passata_mm.toFixed?f.pioggia_tot_passata_mm.toFixed(1):f.pioggia_tot_passata_mm} mm`:"‚Äî")],
        ["Pioggia tot futura", (f.pioggia_tot_futura_mm!=null? `${f.pioggia_tot_futura_mm.toFixed?f.pioggia_tot_futura_mm.toFixed(1):f.pioggia_tot_futura_mm} mm`:"‚Äî")]
      ]);
    }

    // ========= Actions =========
    async function runWithCoords(lat, lon, displayName){
      try{
        setStatus("calcolo in corso‚Ä¶");
        marker.setLatLng([lat,lon]); map.setView([lat,lon], 11);
        let alt = await getElevation(lat,lon);
        const data = await callScore(lat, lon, alt);
        renderAll(displayName, lat, lon, data);
        setStatus("OK ‚úî");
      }catch(e){
        console.error(e); setStatus(e.message || "Errore", true);
        alert("Errore durante il calcolo. Riprova tra poco.");
      }
    }
    async function runPlace(){
      const q = $("#qPlace").value.trim(); if(!q){ $("#qPlace").focus(); return; }
      try{
        setStatus("geocoding‚Ä¶");
        const g = await geocodePlace(q);
        await runWithCoords(g.lat, g.lon, g.display);
      }catch(e){
        console.error(e); setStatus("geocoding fallito", true); alert("Localit√† non trovata o servizio non disponibile.");
      }
    }
    async function runCoords(){
      const txt = $("#qCoords").value.trim(); const c=parseCoords(txt);
      if(!c){ $("#qCoords").focus(); alert("Formato coordinate non valido. Es: 41.12345, 14.67890"); return; }
      await runWithCoords(c.lat, c.lon, `${c.lat.toFixed(5)}, ${c.lon.toFixed(5)}`);
    }

    // ========= Init =========
    document.addEventListener("keydown", e=>{ if(e.key==="Enter") runPlace(); });
    $("#btnPlace").addEventListener("click", runPlace);
    $("#btnCoords").addEventListener("click", runCoords);
    $("#btnGeo").addEventListener("click", ()=>{
      if(!navigator.geolocation){ alert("Geolocalizzazione non supportata"); return; }
      navigator.geolocation.getCurrentPosition(
        (pos)=> runWithCoords(pos.coords.latitude, pos.coords.longitude, "La mia posizione"),
        ()=> alert("Impossibile ottenere la posizione")
      );
    });

    async function ping(){
      try{
        const r = await fetch(window.location.origin + "/api/health");
        if(r.ok) setStatus("backend OK ‚úî"); else setStatus("backend non risponde", true);
      }catch{ setStatus("errore rete verso backend", true); }
    }

    initMap(); ping();
  </script>
</body>
</html>
