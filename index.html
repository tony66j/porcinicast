<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TrovaPorcini vPRO+ 5.0</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --bg:#0f1620; --panel:#121b27; --accent:#2dd4bf; --text:#e6edf3; --muted:#92a2b5; --bad:#ef4444; --ok:#f59e0b; --good:#22c55e;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Arial}
    header{display:flex;align-items:center;gap:.6rem;padding:16px 20px;border-bottom:1px solid #172233}
    .logo{font-weight:800;font-size:22px}
    .badge{background:#1f2a3a;color:#9fd3ff;border:1px solid #243247;padding:2px 8px;border-radius:8px}
    .by{margin-left:auto;color:#9bb3c9}
    main{max-width:1200px;margin:18px auto;padding:0 14px;display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    .card{background:var(--panel);border:1px solid #1b2738;border-radius:12px;padding:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type=text]{background:#0c131d;border:1px solid #23344b;color:var(--text);padding:10px 12px;border-radius:10px;flex:1;min-width:220px}
    button{background:var(--accent);color:#05252a;border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    button.secondary{background:#203045;color:#cfe7ff}
    .big{font-size:46px;font-weight:800}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:#162235;border:1px solid #223146;margin-right:6px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:var(--muted)}
    details{margin-top:6px}
    summary{cursor:pointer;color:#cfe7ff}
    #map{height:520px;border-radius:12px;border:1px solid #1b2738}
    .kpi{display:flex;align-items:center;gap:12px}
    .kpi .label{color:#9bb3c9}
    .index-badge{display:inline-block;min-width:90px;text-align:center;padding:8px 10px;border-radius:10px;background:#0d1520;border:1px solid #203049}
    .row .small{font-size:13px;color:#a8c0d6}
    @media (max-width: 980px){ main{grid-template-columns:1fr} #map{height:420px} .big{font-size:38px}}
  </style>
</head>
<body>
<header>
  <div class="logo">üçÑ TrovaPorcini</div>
  <div class="badge">vPRO+ 5.0</div>
  <div class="by">by <strong>Antonio Pio D‚ÄôAloia</strong></div>
</header>

<main>
  <section class="card">
    <div class="row">
      <input id="q" type="text" placeholder="Localit√† (es. Bocca della Selva)" />
      <input id="coords" type="text" placeholder="Coordinate lat,lon (es. 41,4170010, 14,4707168)" />
      <button id="go">Calcola</button>
      <button id="clear" class="secondary">Pulisci</button>
    </div>

    <div id="where" class="muted" style="margin-top:6px;"></div>

    <div class="grid2" style="margin-top:12px">
      <div>
        <div class="kpi">
          <span class="label">Indice:</span>
          <span id="index" class="big index-badge">‚Äî</span>
          <span class="chip" id="caps">Stima 3h: ‚Äî cappelli</span>
          <span class="chip" id="nextrain">Pioggia prossima: ‚Äî</span>
        </div>

        <div style="margin-top:14px">
          <div class="small">Previsione (prossimi 10 giorni)</div>
          <input id="day" type="range" min="0" max="9" value="0" style="width:100%">
          <div class="muted small" id="daylabel">Giorno selezionato: oggi</div>
        </div>

        <details open style="margin-top:10px">
          <summary>Consigli pratici (cambiano col giorno)</summary>
          <div id="advice" style="margin-top:6px">‚Äî</div>
        </details>

        <details open>
          <summary>Perch√© questa stima</summary>
          <div id="because" style="margin-top:6px">‚Äî</div>
        </details>

        <details>
          <summary>Specie di porcini probabili</summary>
          <div id="species" style="margin-top:6px">‚Äî</div>
        </details>

        <details>
          <summary>Dati tecnici</summary>
          <pre id="tech" style="background:#0b111a;border:1px solid #1d2b40;padding:8px;border-radius:8px;overflow:auto;max-height:220px"></pre>
        </details>

        <details>
          <summary>Piogge (ultimi 14 gg e prossimi 10 gg)</summary>
          <div class="small muted" style="margin-top:6px">Storico</div>
          <div id="rainpast" class="small"></div>
          <div class="small muted" style="margin-top:6px">Previsione</div>
          <div id="rainnext" class="small"></div>
        </details>
      </div>

      <div><div id="map"></div>
        <div class="small muted" style="margin-top:6px">Il cerchio cambia colore = indice del giorno selezionato.</div>
      </div>
    </div>
  </section>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API = "/api/score"; // Netlify redirect -> Render

const qEl = document.getElementById("q");
const cEl = document.getElementById("coords");
const goEl = document.getElementById("go");
const clrEl = document.getElementById("clear");
const idxEl = document.getElementById("index");
const capsEl = document.getElementById("caps");
const nrEl = document.getElementById("nextrain");
const whereEl = document.getElementById("where");
const dayEl = document.getElementById("day");
const dayLbl = document.getElementById("daylabel");
const advEl = document.getElementById("advice");
const becEl = document.getElementById("because");
const spcEl = document.getElementById("species");
const techEl = document.getElementById("tech");
const rainPastEl = document.getElementById("rainpast");
const rainNextEl = document.getElementById("rainnext");

let lastData = null;

function fmtDate(s){ return s; }
function colorForScore(s){ if(s>=70) return "#22c55e"; if(s>=40) return "#f59e0b"; return "#ef4444"; }

const map = L.map('map').setView([41.9, 12.5], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18, attribution: '&copy; OpenStreetMap'
}).addTo(map);
const marker = L.marker([41.9,12.5]).addTo(map);
const circle = L.circle([41.9,12.5], {radius:1500,color:"#ef4444"}).addTo(map);

function setMap(lat, lon, score){
  marker.setLatLng([lat,lon]);
  circle.setLatLng([lat,lon]);
  circle.setStyle({color: colorForScore(score)});
  map.setView([lat,lon], 12);
}

function showRains(past, next){
  rainPastEl.innerHTML = past.map(p=>`${p.date}: ${p.mm} mm`).join(" ¬∑ ") || "‚Äî";
  rainNextEl.innerHTML = next.map(p=>`${p.date}: ${p.mm} mm`).join(" ¬∑ ") || "‚Äî";
}

function setDayLabel(v, data){
  const dd = v===0 ? "oggi" : `D+${v}`;
  dayLbl.textContent = `Giorno selezionato: ${dd}`;
  const sc = data.scores_next10?.[v] ?? data.index;
  circle.setStyle({color: colorForScore(sc)});
}

async function callAPI(day=0){
  const params = new URLSearchParams();
  params.set("day", String(day));
  const coords = cEl.value.trim();
  const q = qEl.value.trim();
  if(coords) params.set("coords", coords);
  else if(q) params.set("q", q);
  else { alert("Errore: inserisci localit√† o coordinate"); return; }

  const url = API + "?" + params.toString();
  let r;
  try{
    r = await fetch(url);
  }catch(e){
    alert("Errore di rete: " + e.message); return;
  }
  if(!r.ok){
    let msg="API " + r.status;
    try{ const j=await r.json(); if(j.detail) msg += `: ${j.detail}` }catch{}
    alert(msg); return;
  }
  const data = await r.json();
  lastData = data;
  renderAll(0);
}

function renderAll(day){
  const d = lastData; if(!d) return;
  const sc = d.scores_next10?.[day] ?? d.index;
  idxEl.textContent = sc;
  idxEl.style.borderColor = colorForScore(sc);
  whereEl.textContent = `(${d.lat.toFixed(6)}, ${d.lon.toFixed(6)}) ‚Äî quota ${Math.round(d.elev_m)} m ‚Äî esposizione ${d.aspect_octant}`;
  // stima cappelli 3h
  if(d.caps_3h) capsEl.textContent = `Stima 3h: ${d.caps_3h.low}‚Äì${d.caps_3h.high} cappelli`;
  // prossima pioggia
  if(d.next_rain){ nrEl.textContent = `Pioggia prossima: ${d.next_rain.mm} mm (D+${d.next_rain.d} ‚Äî ${d.next_rain.date})`; }
  else nrEl.textContent = "Pioggia prossima: ‚Äî";
  // testi
  advEl.textContent = d.advice || "‚Äî";
  becEl.textContent = d.because || "‚Äî";
  spcEl.textContent = (d.species_prob || []).join(", ") || "‚Äî";
  techEl.textContent = JSON.stringify({
    lat:d.lat, lon:d.lon, elev_m:d.elev_m, slope_deg:d.slope_deg, aspect_deg:d.aspect_deg,
    p14_mm:d.p14_mm, tmean7_c:d.tmean7_c, et0_7g:d.et0_7g
  }, null, 2);
  // piogge
  showRains(d.rain_past14_mm?.map((mm,i)=>({date:d.dates_past14[i], mm}))||[], d.rain_next10_mm?.map((mm,i)=>({date:d.dates_next10[i], mm}))||[]);
  // mappa
  setMap(d.lat, d.lon, sc);
  setDayLabel(day, d);
}

goEl.onclick = ()=>callAPI( Number(dayEl.value) || 0 );
clrEl.onclick = ()=>{
  qEl.value=""; cEl.value="";
  idxEl.textContent="‚Äî"; capsEl.textContent="Stima 3h: ‚Äî cappelli"; nrEl.textContent="Pioggia prossima: ‚Äî";
  advEl.textContent=becEl.textContent=spcEl.textContent="‚Äî"; techEl.textContent=""; rainPastEl.textContent=rainNextEl.textContent="";
};
dayEl.oninput = ()=>{ renderAll( Number(dayEl.value)||0 ); };

</script>
</body>
</html>

