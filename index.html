<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Trova Porcini — by Antonio Pio D’Aloia</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{--bg:#0b1220;--panel:#111b2b;--text:#e9f1fa;--muted:#9fb0c2;--accent:#1ee59a;--warn:#ffd166;--danger:#ef476f;--border:#233144;}
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0a1020,#0f1930);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    header{padding:16px 20px;border-bottom:1px solid var(--border);backdrop-filter:blur(6px)}
    .wrap{max-width:1280px;margin:0 auto;padding:20px;display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    @media(max-width:960px){.wrap{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,#0e1728,#0f192c);padding:16px;border-radius:14px;border:1px solid var(--border);box-shadow:0 12px 28px rgba(0,0,0,.35);margin-bottom:16px}
    input,button{padding:10px;border-radius:10px;border:1px solid #2b3b52;font-size:15px;color:var(--text);background:#0b1526}
    button{cursor:pointer;font-weight:700}
    button.ok{background:linear-gradient(90deg,#22d3ee,#1ee59a);border:none;color:#062f2a}
    button.warn{background:linear-gradient(90deg,#ffd166,#22d3ee);border:none;color:#062f2a}
    .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .metric{background:#0b1526;padding:10px;border-radius:12px;text-align:center;border:1px solid #223249}
    .metric .val{font-size:1.6rem;font-weight:800}
    .right-panel{display:flex;flex-direction:column;gap:16px}
    #map{height:460px;border-radius:12px;overflow:hidden}
    .calendar{display:grid;grid-template-columns:repeat(10,1fr);gap:4px;margin-top:8px}
    .bar{height:100px;position:relative;background:#1f2937;border-radius:8px}
    .bar>i{position:absolute;bottom:0;left:0;width:100%;border-radius:8px}
    .bar>span{position:absolute;top:-18px;left:0;width:100%;text-align:center;font-size:.7rem}
    .muted{color:var(--muted);font-size:.9rem}
    #explanationPanel h3{margin-top:0;color:#b9c7ff} #explanationPanel p{line-height:1.6;color:var(--muted)}
    #loading{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);z-index:999}
    #loading .ball{width:12px;height:12px;border-radius:50%;margin:6px;background:#22d3ee;display:inline-block;animation:bounce 0.8s infinite alternate}
    #loading .ball:nth-child(2){animation-delay:.15s;background:#1ee59a}
    #loading .ball:nth-child(3){animation-delay:.3s;background:#ffd166}
    @keyframes bounce{to{transform:translateY(-10px)}}
    .field-guide h4{color:#b9c7ff;border-top:1px solid var(--border);padding-top:12px;margin-top:12px;font-size:1rem}
    .species-list{display:flex;flex-direction:column;gap:12px}
    .species-item{display:flex;gap:12px;align-items:center}
    .species-item img{width:60px;height:60px;border-radius:10px;object-fit:cover;border:1px solid var(--border)}
    .species-item .desc{font-size:.85rem;color:var(--muted)}
    .where-to-look-list li{margin-bottom:8px;line-height:1.5}
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0;font-size:1.4rem;">Trova Porcini — by Antonio Pio D’Aloia</h1>
    <div class="muted" style="font-size:.85rem;">Modello avanzato: storico 15 gg + forecast 10 gg (OW 60% • OM 40%). Fallback automatici.</div>
  </header>

  <div id="loading"><div><span class="ball"></span><span class="ball"></span><span class="ball"></span></div></div>

  <div class="wrap">
    <div class="left-panel">
      <div class="card">
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px">
          <input id="place" type="text" placeholder="Località (es. Abbadia San Salvatore)" style="flex:1"/>
          <button id="btnSearch" class="ok">Cerca</button>
          <input id="coords" type="text" placeholder="lat, lon (Google)" style="flex:1;min-width:220px"/>
          <button id="btnCoords" class="warn">Usa coordinate</button>
        </div>
        <div class="muted" style="font-size:0.8rem;margin-bottom:12px;">Suggerimento: incolla le coordinate da Google Maps o clicca sulla mappa.</div>
        <div class="metrics">
          <div class="metric"><div class="muted">Indice</div><div id="metricIndex" class="val">—</div></div>
          <div class="metric"><div class="muted">Stima raccolto (4 h)</div><div id="metricHarvest" class="val">—</div></div>
          <div class="metric"><div class="muted">Affidabilità</div><div id="metricReliability" class="val">—</div></div>
        </div>
        <div id="metricAltitude" class="muted" style="text-align:center; margin-top:8px;"></div>
      </div>
      <div class="card">
        <div class="muted" style="margin-bottom:6px;">Previsione indice (10 giorni)</div>
        <div id="forecast" class="calendar"></div>
      </div>
      <div class="card field-guide" id="fieldGuidePanel" style="display:none;">
        <h4>Dove Cercare nel Dettaglio</h4>
        <ul id="whereToLookList" class="where-to-look-list" style="padding-left:18px"></ul>
        <h4>Altri Porcini Comuni in Zona</h4>
        <div id="otherPorciniList" class="species-list"></div>
        <h4>Attenzione a Possibili Sòsia</h4>
        <div id="toAvoidList" class="species-list"></div>
      </div>
    </div>

    <div class="right-panel">
      <div class="card"><div id="map"></div></div>
      <div class="card" id="explanationPanel" style="display:none;">
          <h3>Analisi del Modello</h3>
          <p id="explanationText"></p>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const API = "/api";
    const $ = s => document.querySelector(s);
    const showLoad = (v)=>{ $("#loading").style.display = v ? "grid" : "none"; };

    let map, marker;
    function initMap(){
      map = L.map('map').setView([42.5,12.5], 6);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);
      marker = L.marker([42.5,12.5]).addTo(map);
      setTimeout(()=>map.invalidateSize(), 250);
      map.on("click", e => handleCoords(e.latlng.lat, e.latlng.lng));
    }

    function parseCoords(str){
      const m = /^\s*([+-]?\d+(?:[.,]\d+)?)\s*[,;\s]\s*([+-]?\d+(?:[.,]\d+)?)\s*$/.exec((str||"").trim());
      if(!m) return null;
      const lat = parseFloat(m[1].replace(",", ".")), lon = parseFloat(m[2].replace(",", "."));
      if(!isFinite(lat)||!isFinite(lon)||lat<-90||lat>90||lon<-180||lon>180) return null;
      return {lat,lon};
    }
    async function apiGet(u){
      const r = await fetch(u);
      if(!r.ok){ const t = await r.text().catch(()=>""); throw new Error(t||"errore rete"); }
      return r.json();
    }

    function renderUI(s){
        $("#metricIndex").textContent = s.index ?? "—";
        $("#metricHarvest").textContent = s.harvest_estimate ?? "—";
        $("#metricReliability").textContent = s.reliability != null ? Math.round(s.reliability * 100) + "%" : "—";
        $("#metricAltitude").textContent = s.elevation_m != null ? `Altitudine: ${s.elevation_m} m s.l.m.` : "";

        const forecastCont = $("#forecast"); forecastCont.innerHTML="";
        (s.forecast || []).forEach(v => {
            const box = document.createElement("div"); box.className="bar";
            const fill = document.createElement("i");
            fill.style.height = Math.max(4, v) + "%";
            fill.style.background = v >= 70 ? "var(--accent)" : v >= 55 ? "var(--warn)" : "var(--danger)";
            const lab = document.createElement("span"); lab.textContent = v;
            box.appendChild(fill); box.appendChild(lab); forecastCont.appendChild(box);
        });
        
        const expPanel = $("#explanationPanel");
        const expText = $("#explanationText");
        if (s.dynamic_explanation) {
            expText.innerHTML = s.dynamic_explanation.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            expPanel.style.display = "block";
        } else {
            expPanel.style.display = "none";
        }

        const fieldGuidePanel = $("#fieldGuidePanel");
        if (s.field_guide) {
            const { where_to_look_tips, other_porcini, to_avoid } = s.field_guide;
            const renderSpecies = (list, containerId) => {
                const container = $(containerId);
                container.innerHTML = "";
                (list || []).forEach(item => {
                    container.innerHTML += `<div class="species-item"><img src="${item.img}" alt="${item.name}" loading="lazy"><div><strong>${item.name}</strong><div class="desc">${item.desc}</div></div></div>`;
                });
            };
            $("#whereToLookList").innerHTML = (where_to_look_tips || []).map(tip => `<li>${tip.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</li>`).join('');
            renderSpecies(other_porcini, "#otherPorciniList");
            renderSpecies(to_avoid, "#toAvoidList");
            fieldGuidePanel.style.display = "block";
        } else {
            fieldGuidePanel.style.display = "none";
        }
    }
    
    async function handleCoords(lat, lon) {
        showLoad(true);
        try {
            marker.setLatLng([lat, lon]);
            map.setView([lat, lon], 11);
            const s = await apiGet(`${API}/score?lat=${lat}&lon=${lon}`);
            renderUI(s);
        } catch(e) { console.error(e); alert("Errore durante il calcolo. Dettagli in console.");
        } finally { showLoad(false); }
    }
    async function handlePlace() {
        const q = $("#place").value.trim();
        if (!q) { alert("Inserisci una località"); return; }
        showLoad(true);
        try {
            const g = await apiGet(`${API}/geocode?q=${encodeURIComponent(q)}`);
            $("#place").value = g.display;
            await handleCoords(g.lat, g.lon);
        } catch (e) { console.error(e); alert("Errore geocoding. Prova con le coordinate.");
        } finally { showLoad(false); }
    }
    async function handleCoordsStr(){
        const c = parseCoords($("#coords").value.trim());
        if(!c){ alert("Coordinate non valide. Esempio: 41.127, 14.782"); return; }
        showLoad(true);
        try{ await handleCoords(c.lat, c.lon); }
        catch(e){ console.error(e); alert("Errore durante il calcolo."); }
        finally{ showLoad(false); }
    }

    $("#btnSearch").addEventListener("click", handlePlace);
    $("#btnCoords").addEventListener("click", handleCoordsStr);
    $("#place").addEventListener("keydown", (e)=>{ if(e.key==="Enter") handlePlace(); });
    $("#coords").addEventListener("keydown", (e)=>{ if(e.key==="Enter") handleCoordsStr(); });

    initMap();
  </script>
</body>
</html>
