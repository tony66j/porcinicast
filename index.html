<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TrovaPorcini v1.0 ‚Äì by Antonio Pio D‚ÄôAloia</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{--bg:#0e141b;--panel:#16202a;--txt:#eaf3fa;--mut:#9eb3c1;--acc:#2ecc71;--warn:#f1c40f;--bad:#e74c3c}
html,body{margin:0;height:100%;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
.wrap{max-width:1220px;margin:0 auto;padding:16px}
.hdr{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.logo{font-size:28px} .badge{background:#203243;color:#9ef;border-radius:6px;padding:3px 8px;margin-left:8px}
.by{margin-left:auto;color:var(--mut)}
.card{background:var(--panel);border-radius:10px;padding:14px;margin:10px 0}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.lab{font-size:13px;color:var(--mut);margin-bottom:6px}
input{width:100%;padding:10px;border-radius:8px;border:1px solid #2a3a48;background:#0b1218;color:var(--txt)}
.btn{background:var(--acc);color:#012; border:0;border-radius:8px;padding:10px 14px;cursor:pointer;font-weight:600}
.btn.muted{background:#263748;color:#dfe}
.grid2{display:grid;grid-template-columns:1.05fr 1fr; gap:14px}
.score{font-size:44px;font-weight:800;margin:6px 0}
.small{color:var(--mut);font-size:13px}
.dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:8px}
.good{background:var(--acc)} .mid{background:var(--warn)} .bad{background:var(--bad)}
#map{height:680px;border-radius:10px;overflow:hidden}
.pill{display:inline-block;background:#0b1218;border:1px solid #2b3e4c;border-radius:999px;padding:6px 10px;margin:4px 4px 0 0;color:#bfe}
.slider{width:100%}
canvas{background:#0b1218;border:1px solid #2a3b4a;border-radius:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <div class="logo">üçÑ TrovaPorcini <span class="badge">v1.0</span></div>
    <div class="by">by <strong>Antonio Pio D‚ÄôAloia</strong></div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <div class="lab">Localit√†</div>
        <input id="place" placeholder="es. Bocca della Selva">
      </div>
      <div>
        <div class="lab">Coordinate (lat,lon ‚Äì accetta anche stile Google con virgole)</div>
        <input id="coords" placeholder="es. 41,4170010, 14,4707168">
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:10px;align-items:center;flex-wrap:wrap">
      <button class="btn" id="go">Calcola idoneit√†</button>
      <button class="btn muted" id="clr">Pulisci</button>
      <span class="small">Se inserisci le coordinate, hanno priorit√† sulla localit√†.</span>
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <div class="small" id="loclabel">‚Äî</div>
      <div style="display:flex;gap:10px;align-items:center"><div id="dot" class="dot mid"></div><div class="small">Indice <span id="daylab">oggi</span></div></div>
      <div class="score" id="score">‚Äì</div>
      <div class="pill" id="caps">Stima raccolto (3h): ‚Äì cappelli</div>
      <div class="small" id="verdict">‚Äì</div>

      <div style="margin-top:8px" class="small">Previsione (10 giorni)</div>
      <input type="range" class="slider" min="0" max="9" value="0" id="day">
      <div class="small">Finestra migliore (3 gg): <span id="bestwin">‚Äì</span></div>

      <details open style="margin-top:8px">
        <summary><strong>Consigli pratici</strong> (dipendono dal giorno)</summary>
        <div class="small" id="tips">‚Äì</div>
      </details>

      <details style="margin-top:8px">
        <summary><strong>Perch√© questa stima</strong></summary>
        <div class="small" id="why">‚Äì</div>
      </details>

      <details style="margin-top:8px">
        <summary><strong>Specie di porcini probabili</strong></summary>
        <div class="small" id="species">‚Äì</div>
      </details>

      <details style="margin-top:8px">
        <summary><strong>Dati tecnici</strong></summary>
        <div class="small" id="tech">‚Äì</div>
      </details>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
        <div>
          <div class="small">Score prossimi 10 gg</div>
          <canvas id="chartScore" width="520" height="120"></canvas>
        </div>
        <div>
          <div class="small">Pioggia (mm) prossimi 10 gg</div>
          <canvas id="chartRain" width="520" height="120"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <div id="map"></div>
      <div class="small" style="margin-top:6px">Mappa centrata Italia; il cerchio cambia colore con il giorno selezionato.</div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const api = (p)=>fetch(p).then(async r=>{
  if(!r.ok){ const t=await r.text().catch(()=> ""); throw new Error("API "+r.status+(t?": "+t:"")); }
  return r.json();
});

function parseCoords(txt){
  if(!txt) return null;
  const nums=(txt.replace(/;/g,',').match(/-?\d+[.,]?\d*/g)||[]);
  if(nums.length<2) return null;
  const lat=parseFloat(nums[0].replace(',','.'));
  const lon=parseFloat(nums[1].replace(',','.'));
  if(Number.isNaN(lat)||Number.isNaN(lon)) return null;
  return {lat,lon};
}
async function resolvePlaceOrCoords(str){
  const c=parseCoords(str);
  if(c) return {...c, display:null};
  const g=await api(`/api/geocode?q=${encodeURIComponent(str)}`);
  if(!g||g.lat===undefined) throw new Error("Localit√† non trovata");
  return {lat:g.lat, lon:g.lon, display:g.display};
}

let map, marker, ring, last;
function initMap(){
  map=L.map('map').setView([42,13.5],6);
  const bounds=L.latLngBounds([35.2,6.5],[47.3,18.8]);
  map.setMaxBounds(bounds); map.on('drag',()=>map.panInsideBounds(bounds,{animate:false}));
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:16}).addTo(map);
}
function setPoint(lat,lon,color){
  if(!marker) marker=L.marker([lat,lon]).addTo(map); else marker.setLatLng([lat,lon]);
  if(!ring) ring=L.circle([lat,lon],{radius:1300,color,fillColor:color,fillOpacity:0.18}).addTo(map);
  else { ring.setLatLng([lat,lon]); ring.setStyle({color,fillColor:color}); }
  map.setView([lat,lon],12,{animate:true});
}
function verdict(score){
  if(score>=70) return {txt:"Consigliato", cls:"good", col:"#2ecc71"};
  if(score>=45) return {txt:"Possibile", cls:"mid", col:"#f1c40f"};
  return {txt:"Sconsigliato", cls:"bad", col:"#e74c3c"};
}
function drawLine(canvasId, arr, color){
  const c=document.getElementById(canvasId); const ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  if(!arr || !arr.length) return;
  const w=c.width, h=c.height, n=arr.length;
  const min=Math.min(...arr), max=Math.max(...arr);
  const sx=w/(n-1||1), range=(max-min)||1;
  ctx.beginPath(); ctx.strokeStyle=color; ctx.lineWidth=2;
  arr.forEach((v,i)=>{const x=i*sx, y=h-8-(h-16)*(v-min)/range; if(i==0)ctx.moveTo(x,y); else ctx.lineTo(x,y);});
  ctx.stroke();
  ctx.fillStyle="#89a"; ctx.font="11px system-ui"; ctx.fillText(min+"",4,h-4); ctx.fillText(max+"",4,12);
}
function updateUI(res, day){
  last={res, day};
  const sc = res.scores_next10[day];
  const v  = verdict(sc);
  document.getElementById('dot').className="dot "+v.cls;
  document.getElementById('score').textContent=sc;
  document.getElementById('verdict').textContent=v.txt;
  document.getElementById('daylab').textContent = day===0? "oggi" : `D+${day}`;
  const mean = res.caps3_10[day], rng=res.caps3_range10[day];
  document.getElementById('caps').textContent = `Stima raccolto (3h): ~${mean} cappelli (range ${rng[0]}‚Äì${rng[1]})`;
  document.getElementById('bestwin').textContent = `D+${res.best_window.start} ‚Üí D+${res.best_window.end} (media ${res.best_window.mean})`;
  document.getElementById('tips').textContent = res.tips10[day];
  document.getElementById('why').textContent  = res.why10[day] + `; ultima pioggia ~${res.last_rain_days} gg; prossimi 5 gg: ${res.next_rain_mm_5d} mm`;
  document.getElementById('species').textContent = (res.species_probable||[]).join(", ") || "‚Äì";
  const tech = `quota ${Math.round(res.elevation_m)} m ¬∑ pend. ${res.slope_deg}¬∞ ¬∑ espos. ${res.aspect_octant} ¬∑ incertezza ${res.uncertainty}`;
  document.getElementById('tech').textContent = tech;
  drawLine('chartScore', res.scores_next10, v.col);
  drawLine('chartRain',  res.series.precip_next10, '#4aa3ff');
  const col = v.col; if(ring) ring.setStyle({color:col,fillColor:col});
}

async function fetchAll(mainStr){
  const A = await resolvePlaceOrCoords(mainStr);
  document.getElementById('loclabel').textContent=A.display? A.display : `(${A.lat.toFixed(4)}, ${A.lon.toFixed(4)})`;
  const res = await api(`/api/score?lat=${A.lat}&lon=${A.lon}&day=0`);
  updateUI(res, parseInt(document.getElementById('day').value,10)||0);
  const col = verdict(res.scores_next10[0]).col;
  setPoint(A.lat, A.lon, col);
  return res;
}

// events
document.getElementById('go').addEventListener('click', async ()=>{
  try{
    document.getElementById('go').disabled=true;
    const mainStr = (document.getElementById('coords').value.trim() || document.getElementById('place').value.trim());
    if(!mainStr){ alert("Inserisci localit√† o coordinate"); return; }
    await fetchAll(mainStr);
  }catch(e){ alert(e.message); console.error(e); }
  finally{ document.getElementById('go').disabled=false; }
});
document.getElementById('clr').addEventListener('click', ()=>{["place","coords"].forEach(id=>document.getElementById(id).value="");});
document.getElementById('day').addEventListener('input', ()=>{
  if(!last?.res) return;
  const d=parseInt(document.getElementById('day').value,10)||0;
  updateUI(last.res, d);
});

(function(){ // init
  initMap();
})();
</script>
</body>
</html>


