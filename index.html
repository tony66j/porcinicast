<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Trova Porcini — by Antonio Pio D’Aloia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* Tema scuro e layout a due colonne */
    :root {
      --bg: #0f1b26;
      --panel: #15212e;
      --text: #eef5fb;
      --muted: #8fa7b8;
      --accent: #4caf50;
      --danger: #e53935;
      --warn: #f9a825;
    }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu; background: var(--bg); color: var(--text); }
    h1 { margin:0; font-size:1.4rem; }
    header { padding: 14px 20px; border-bottom: 1px solid #253548; }
    .wrap { display: grid; grid-template-columns: 1.2fr 1fr; gap: 16px; max-width: 1280px; margin: 0 auto; padding: 20px; }
    @media(max-width: 960px){ .wrap { grid-template-columns: 1fr; } }
    .card { background: var(--panel); padding: 16px; border-radius: 14px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom:10px; }
    input[type=text] { padding: 10px; border-radius: 10px; border: 1px solid #2c3e50; background: #102335; color: var(--text); flex:1; }
    button { padding: 10px 14px; border-radius: 10px; border:none; cursor:pointer; color: #0f1b26; font-weight: bold; }
    button.primary { background: var(--accent); }
    button.secondary { background: var(--warn); }
    button.danger { background: var(--danger); }
    .metrics { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:6px; }
    .metric { background: #102335; padding:10px; border-radius:10px; text-align:center; }
    .metric .val { font-size: 1.6rem; font-weight: bold; }
    #map { height: 450px; border-radius: 10px; }
    .badge { display:inline-block; padding:4px 8px; border-radius:8px; font-size: .8rem; }
    .badge.warn { background: #f9a82522; border: 1px solid var(--warn); color: var(--warn); }
    .badge.good { background: #4caf5022; border: 1px solid var(--accent); color: var(--accent); }
    .badge.bad { background: #e5393522; border: 1px solid var(--danger); color: var(--danger); }
    details summary { cursor:pointer; font-weight:bold; margin-top:10px; }
    details p { margin:6px 0; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <header>
    <h1>Trova Porcini — by Antonio Pio D’Aloia</h1>
    <div class="muted" style="font-size:0.85rem;">Stime basate su dati meteorologici, orografici e ambientali</div>
  </header>

  <div class="wrap">

    <!-- Colonna sinistra: input e risultati -->
    <div class="card">
      <!-- Barra ricerche (luogo e coordinate) -->
      <div class="row">
        <input id="place" type="text" placeholder="Inserisci una località (es. Abbadia San Salvatore)">
        <button id="btnSearch" class="primary">Cerca</button>
        <input id="coords" type="text" placeholder="oppure lat, lon (Google)">
        <button id="btnCoords" class="secondary">Usa coordinate</button>
      </div>
      <div class="muted" style="font-size:0.8rem;">Puoi incollare direttamente le coordinate da Google Maps (es. 44.12345, 11.23456)</div>

      <!-- Risultati metrici -->
      <div class="metrics">
        <div class="metric">
          <div class="muted">Indice</div>
          <div id="metricIndex" class="val">—</div>
        </div>
        <div class="metric">
          <div class="muted">Stima raccolto</div>
          <div id="metricHarvest" class="val">—</div>
        </div>
        <div class="metric">
          <div class="muted">Affidabilità</div>
          <div id="metricReliability" class="val">—</div>
        </div>
      </div>

      <!-- Previsione 10 giorni -->
      <div style="margin-top:16px;">
        <div class="muted" style="margin-bottom:6px;">Previsione indice 10 giorni</div>
        <div id="forecast" style="display:flex; gap:4px; align-items:flex-end; height:120px;">
          <!-- generato via JS -->
        </div>
      </div>

      <!-- Sezione Specifiche -->
      <details id="specs" open>
        <summary>Specifiche (fattori considerati)</summary>
        <ul id="specList">
          <li>Latitudine e longitudine del punto</li>
          <li>Altitudine (m s.l.m.)</li>
          <li>Pendenza e esposizione del versante</li>
          <li>Piogge accumulate (P7 / P14)</li>
          <li>Bilancio idrico (API*, ET0)</li>
          <li>Temperatura media (e min/max)</li>
          <li>Umidità relativa media</li>
          <li>Irraggiamento solare</li>
          <li>Tipo di vegetazione (se disponibile)</li>
          <li>Periodo migliore (3 giorni consecutivi)</li>
        </ul>
      </details>

      <!-- Sezione Consigli -->
      <details id="tips" open>
        <summary>Consigli utili alla raccolta</summary>
        <ul id="tipsList">
          <!-- generato via JS -->
        </ul>
      </details>

      <!-- Perché questa stima -->
      <details id="why" open>
        <summary>Perché questa stima?</summary>
        <ul id="whyList">
          <!-- generato via JS -->
        </ul>
      </details>

    </div>

    <!-- Colonna destra: mappa -->
    <div class="card">
      <div id="map"></div>
    </div>

  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- Config ---
    const API_BASE = "/api"; // il backend offre /api/geocode e /api/score

    // Mappa
    let map, marker;
    function initMap() {
      map = L.map('map').setView([42.5, 12.5], 6);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
      marker = L.marker([42.5, 12.5]).addTo(map);
      setTimeout(() => map.invalidateSize(), 300);
    }

    // Parsing coordinate in "lat, lon"
    function parseCoords(txt) {
      const m = /^\s*([+-]?\d+(?:[.,]\d+)?)\s*[,;\s]\s*([+-]?\d+(?:[.,]\d+)?)\s*$/.exec((txt||"").trim());
      if(!m) return null;
      let lat = parseFloat(m[1].replace(",", "."));
      let lon = parseFloat(m[2].replace(",", "."));
      if(!isFinite(lat) || !isFinite(lon)) return null;
      if(lat < -90 || lat > 90 || lon < -180 || lon > 180) return null;
      return { lat, lon };
    }

    // Aggiorna grafico previsione
    function updateForecast(scores) {
      const fc = document.getElementById('forecast');
      fc.innerHTML = "";
      const maxH = 100;
      scores.forEach((s,i) => {
        const bar = document.createElement('div');
        bar.style.width = "10%";
        bar.style.background = s >= 70 ? "#4caf50" : s >= 55 ? "#f9a825" : "#e53935";
        bar.style.height = Math.max(4, (s/100)*maxH) + "px";
        bar.style.position = "relative";
        const label = document.createElement('div');
        label.style.position = "absolute";
        label.style.top = "-18px";
        label.style.left = "-6px";
        label.style.fontSize = ".7rem";
        label.textContent = s;
        bar.appendChild(label);
        fc.appendChild(bar);
      });
    }

    // Visualizza consigli e spiegazioni
    function updateLists(why, tips) {
      const whyUl = document.getElementById('whyList');
      whyUl.innerHTML = "";
      why.forEach(msg => {
        const li = document.createElement('li');
        li.textContent = msg;
        whyUl.appendChild(li);
      });
      const tipsUl = document.getElementById('tipsList');
      tipsUl.innerHTML = "";
      tips.forEach(msg => {
        const li = document.createElement('li');
        li.textContent = msg;
        tipsUl.appendChild(li);
      });
    }

    // Aggiorna metriche
    function setMetrics(idx, harvest, rel) {
      document.getElementById('metricIndex').textContent = idx != null ? idx : "—";
      document.getElementById('metricHarvest').textContent = harvest || "—";
      document.getElementById('metricReliability').textContent = rel != null ? Math.round(rel*100) + "%" : "—";
    }

    // Chiamata API geocode
    async function geocode(q) {
      const r = await fetch(`${API_BASE}/geocode?q=` + encodeURIComponent(q));
      if(!r.ok) throw new Error("Geocoding non riuscito");
      return r.json();
    }

    // Chiamata API score
    async function score(lat, lon) {
      const r = await fetch(`${API_BASE}/score?lat=${lat}&lon=${lon}`);
      if(!r.ok) throw new Error("Elaborazione non riuscita");
      return r.json();
    }

    // Avvia ricerca da nome luogo
    async function searchPlace() {
      const q = document.getElementById('place').value.trim();
      if(!q) { alert("Inserisci una località valida"); return; }
      try {
        const g = await geocode(q);
        marker.setLatLng([g.lat, g.lon]);
        map.setView([g.lat, g.lon], 11);
        await loadAndRender(g.lat, g.lon);
      } catch(err) {
        console.error(err);
        alert("Errore durante la ricerca: " + err.message);
      }
    }

    // Avvia ricerca da coordinate
    async function searchCoords() {
      const str = document.getElementById('coords').value.trim();
      const c = parseCoords(str);
      if(!c) { alert("Formato coordinate non valido"); return; }
      marker.setLatLng([c.lat, c.lon]);
      map.setView([c.lat, c.lon], 11);
      await loadAndRender(c.lat, c.lon);
    }

    // Elabora i risultati e aggiorna UI
    async function loadAndRender(lat, lon) {
      const data = await score(lat, lon);
      updateForecast(data.forecast);
      updateLists(data.explanation.reasons, data.tips);
      setMetrics(data.index, data.harvest_estimate, data.reliability);
    }

    // Eventi
    document.getElementById('btnSearch').addEventListener('click', searchPlace);
    document.getElementById('btnCoords').addEventListener('click', searchCoords);
    document.getElementById('btnSearch').addEventListener('keyup', (e)=>{ if(e.key==="Enter") searchPlace(); });
    document.getElementById('coords').addEventListener('keyup', (e)=>{ if(e.key==="Enter") searchCoords(); });

    // Carica mappa all'avvio
    initMap();
  </script>
</body>
</html>

