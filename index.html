<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Trova Porcini — by Antonio Pio D’Aloia</title>
  <style>
    :root{--bg:#0f1b26;--panel:#15212e;--text:#eef5fb;--muted:#8fa7b8;--accent:#4caf50;--warn:#f9a825;--danger:#e53935;--border:#253548;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    header{padding:16px 20px;border-bottom:1px solid var(--border)}
    .wrap{max-width:1280px;margin:0 auto;padding:20px;display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    @media(max-width:960px){.wrap{grid-template-columns:1fr}}
    .card{background:var(--panel);padding:16px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.3);margin-bottom:16px}
    input,button{padding:10px;border-radius:10px;border:1px solid #2c3e50;font-size:15px;color:var(--text);background:#102335}
    button{cursor:pointer;font-weight:bold}
    button.ok{background:var(--accent)}
    button.warn{background:var(--warn);color:#101f26}
    .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .metric{background:#102335;padding:10px;border-radius:10px;text-align:center}
    .metric .val{font-size:1.6rem;font-weight:bold}
    #map{height:460px;border-radius:10px;overflow:hidden}
    .calendar{display:grid;grid-template-columns:repeat(10,1fr);gap:4px;margin-top:8px}
    .bar{height:100px;position:relative;background:#1f2937;border-radius:6px}
    .bar>i{position:absolute;bottom:0;left:0;width:100%;border-radius:6px}
    .bar>span{position:absolute;top:-18px;left:0;width:100%;text-align:center;font-size:.7rem}
    .table{border:1px solid #2c3e50;border-radius:10px;overflow:hidden}
    .tr{display:grid;grid-template-columns:1fr 80px;padding:8px 10px;border-bottom:1px solid #2c3e50}
    .tr.head{background:#102335;font-weight:bold}
    .tr:last-child{border-bottom:none}
    details summary{cursor:pointer;font-weight:bold;margin-top:10px}
    details p{margin:6px 0}
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>
  <header>
    <h1 style="margin:0;font-size:1.4rem;">Trova Porcini — by Antonio Pio D’Aloia</h1>
    <div class="muted" style="font-size:.85rem;">Blending meteo (OpenWeather 60% + Open-Meteo 40%), storico reale 15 gg, previsione 10 gg</div>
  </header>

  <div class="wrap">
    <div class="card">
      <!-- Barra località + coordinate -->
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px">
        <input id="place" type="text" placeholder="Località (es. Abbadia San Salvatore)" style="flex:1"/>
        <button id="btnSearch" class="ok">Cerca</button>
        <input id="coords" type="text" placeholder="lat, lon (Google)" style="flex:1;min-width:220px"/>
        <button id="btnCoords" class="warn">Usa coordinate</button>
      </div>
      <div class="muted" style="font-size:0.8rem;margin-bottom:12px;">Suggerimento: incolla le coordinate da Google Maps, es. “44.12345, 11.23456”.</div>

      <!-- KPI -->
      <div class="metrics">
        <div class="metric"><div class="muted">Indice</div><div id="metricIndex" class="val">—</div></div>
        <div class="metric"><div class="muted">Stima raccolto</div><div id="metricHarvest" class="val">—</div></div>
        <div class="metric"><div class="muted">Affidabilità</div><div id="metricReliability" class="val">—</div></div>
      </div>

      <!-- Previsione indice -->
      <div style="margin-top:14px;">
        <div class="muted" style="margin-bottom:6px;">Previsione indice (10 giorni)</div>
        <div id="forecast" class="calendar"></div>
      </div>

      <!-- Piogge passate / future -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px">
        <div>
          <div class="muted" style="margin-bottom:6px;">Piogge passate (ultimi 15 giorni)</div>
          <div id="rainPast" class="table">
            <div class="tr head"><div>Data</div><div>mm</div></div>
          </div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Piogge future (prossimi 10 giorni)</div>
          <div id="rainFuture" class="table">
            <div class="tr head"><div>Data</div><div>mm</div></div>
          </div>
        </div>
      </div>

      <!-- Specifiche + Consigli + Perché -->
      <details open>
        <summary>Specifiche (fattori considerati)</summary>
        <ul style="margin-left:18px;font-size:.9rem;">
          <li>Latitudine/longitudine, altitudine, pendenza, esposizione</li>
          <li>Piogge P7/P15, API* (emivita ~8 gg), ET0 7 gg</li>
          <li>Temperature medie/min/max (ultimi 7–15 giorni)</li>
          <li>Umidità relativa media (quando disponibile)</li>
          <li>Previsioni multi-modello (OW 60% + OM 40%) con affidabilità</li>
          <li>Finestra migliore di 3 giorni e stima raccolto (2 h)</li>
        </ul>
      </details>
      <details open>
        <summary>Consigli utili del giorno</summary>
        <ul id="tipsList" style="margin-left:18px;font-size:.9rem;"></ul>
      </details>
      <details>
        <summary>Perché questa stima?</summary>
        <ul id="whyList" style="margin-left:18px;font-size:.9rem;"></ul>
      </details>
    </div>

    <!-- Mappa -->
    <div class="card"><div id="map"></div></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const API_BASE = "/api";
    const $ = s => document.querySelector(s);

    // Mappa
    let map, marker;
    function initMap(){
      map = L.map('map').setView([42.5,12.5], 6);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:18}).addTo(map);
      marker = L.marker([42.5,12.5]).addTo(map);
      setTimeout(()=>map.invalidateSize(), 200);
      map.on("click", e => handleCoords(e.latlng.lat, e.latlng.lng));
    }

    // Utils
    function parseCoords(str){
      const m = /^\s*([+-]?\d+(?:[.,]\d+)?)\s*[,;\s]\s*([+-]?\d+(?:[.,]\d+)?)\s*$/.exec((str||"").trim());
      if(!m) return null;
      const lat = parseFloat(m[1].replace(",", ".")), lon = parseFloat(m[2].replace(",", "."));
      if(!isFinite(lat)||!isFinite(lon)||lat<-90||lat>90||lon<-180||lon>180) return null;
      return {lat,lon};
    }
    async function apiGet(u){
      const r = await fetch(u);
      if(!r.ok){ const t = await r.text().catch(()=> ""); throw new Error(t || "errore rete"); }
      return r.json();
    }
    async function geocode(q){ return apiGet(`${API_BASE}/geocode?q=${encodeURIComponent(q)}`); }
    async function score(lat,lon){ return apiGet(`${API_BASE}/score?lat=${lat}&lon=${lon}`); }

    // UI render
    function renderForecast(arr){
      const cont = $("#forecast"); cont.innerHTML = "";
      (arr||[]).forEach(v=>{
        const box = document.createElement("div"); box.className="bar";
        const fill = document.createElement("i");
        fill.style.height = Math.max(4, v) + "%";
        fill.style.background = v>=70 ? "#4caf50" : (v>=55 ? "#f9a825" : "#e53935");
        const lab = document.createElement("span"); lab.textContent = v;
        box.appendChild(fill); box.appendChild(lab); cont.appendChild(box);
      });
    }
    function renderTables(pastDict, futDict){
      function fill(el, d){
        el.innerHTML = '<div class="tr head"><div>Data</div><div>mm</div></div>';
        Object.keys(d||{}).sort().forEach(k=>{
          const tr=document.createElement("div"); tr.className="tr";
          tr.innerHTML = `<div>${k}</div><div>${Number(d[k]).toFixed(1)}</div>`;
          el.appendChild(tr);
        });
      }
      fill($("#rainPast"), pastDict||{});
      fill($("#rainFuture"), futDict||{});
    }
    function renderLists(reasons, tips){
      const wl=$("#whyList"); wl.innerHTML=""; (reasons||[]).forEach(t=>{ const li=document.createElement("li"); li.textContent=t; wl.appendChild(li); });
      const tl=$("#tipsList"); tl.innerHTML=""; (tips||[]).forEach(t=>{ const li=document.createElement("li"); li.textContent=t; tl.appendChild(li); });
    }
    function renderMetrics(idx, harvest, rel){
      $("#metricIndex").textContent = idx ?? "—";
      $("#metricHarvest").textContent = harvest ?? "—";
      $("#metricReliability").textContent = rel!=null ? Math.round(rel*100)+"%" : "—";
    }

    // Handlers
    async function handlePlace(){
      const q = $("#place").value.trim();
      if(!q){ alert("Inserisci una località"); return; }
      try{
        const g = await geocode(q);
        await handleCoords(g.lat, g.lon);
      }catch(e){ console.error(e); alert("Errore geocoding. Prova con le coordinate lat, lon."); }
    }
    async function handleCoordsStr(){
      const c = parseCoords($("#coords").value.trim());
      if(!c){ alert("Coordinate non valide. Esempio: 41.127, 14.782"); return; }
      await handleCoords(c.lat, c.lon);
    }
    async function handleCoords(lat,lon){
      marker.setLatLng([lat,lon]); map.setView([lat,lon], 11);
      try{
        const s = await score(lat, lon);
        renderForecast(s.forecast);
        renderTables(s.rain_past, s.rain_future);
        renderLists(s.explanation?.reasons, s.tips);
        renderMetrics(s.index, s.harvest_estimate, s.reliability);
      }catch(e){ console.error(e); alert("Errore durante il calcolo. Riprova più tardi."); }
    }

    // Bind
    document.getElementById("btnSearch").addEventListener("click", handlePlace);
    document.getElementById("btnCoords").addEventListener("click", handleCoordsStr);
    document.getElementById("place").addEventListener("keydown", e=>{ if(e.key==="Enter") handlePlace(); });
    document.getElementById("coords").addEventListener("keydown", e=>{ if(e.key==="Enter") handleCoordsStr(); });

    // Start
    initMap();
  </script>
</body>
</html>

