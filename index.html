<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TrovaPorcini v3.0</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root{
    --bg:#0e1420;--card:#141c2b;--accent:#1f9d5a;--text:#e8eef6;--muted:#8fa6c3;
  }
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  h1{font-size:22px;margin:0}
  h1 small{background:#22314a;color:#cfe1ff;border-radius:6px;padding:2px 8px;margin-left:8px}
  .by{color:var(--muted);font-size:14px}
  .card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3956;background:#0f1726;color:var(--text)}
  .buttons{display:flex;gap:8px;margin-top:8px}
  button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  button.secondary{background:#2a3956}
  .grid{display:grid;grid-template-columns:1.1fr 1fr;gap:12px}
  .metric{display:flex;gap:10px;align-items:center}
  .pill{background:#1a2740;color:#cfe1ff;border-radius:20px;padding:4px 10px;font-size:13px}
  .section-title{font-weight:700;margin:8px 0}
  #map{width:100%;height:420px;border-radius:12px}
  .slider{width:100%}
  details{margin:8px 0}
  details>summary{cursor:pointer;color:#cfe1ff}
  @media (max-width:900px){
    .grid{grid-template-columns:1fr}
    #map{height:50vh}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üçÑ TrovaPorcini <small>v3.0</small></h1>
    <div class="by">by <b>Antonio Pio D'Aloia</b></div>
  </header>

  <div class="card">
    <label for="q">Localit√† o coordinate (lat,lon)</label>
    <input id="q" placeholder="es. Bocca della Selva oppure 41.4170010, 14.4707168" />
    <div class="buttons">
      <button id="go">Calcola</button>
      <button id="clear" class="secondary">Pulisci</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="metric">
        <div class="pill" id="indexPill">Indice: ‚Äì</div>
        <div class="pill" id="capsPill">Stima 3h: ‚Äì cappelli</div>
        <div class="pill" id="rainPill">Pioggia: ‚Äì</div>
      </div>

      <div class="section-title">Previsione (prossimi 10 giorni)</div>
      <input id="day" class="slider" type="range" min="0" max="9" step="1" value="0"/>
      <div style="font-size:13px;color:var(--muted)">Giorno selezionato: <span id="dayLbl">oggi</span></div>

      <details open>
        <summary>Consigli pratici (cambiano per il giorno selezionato)</summary>
        <ul id="advice" style="margin:8px 0 0 18px"></ul>
      </details>

      <details>
        <summary>Perch√© questa stima</summary>
        <div id="why" style="margin-top:6px;color:#d9e7ff"></div>
      </details>

      <details>
        <summary>Specie di porcini probabili</summary>
        <div id="species" style="margin-top:6px"></div>
      </details>

      <details>
        <summary>Dati tecnici</summary>
        <pre id="tech" style="white-space:pre-wrap;margin-top:6px;color:#9fc6ff"></pre>
      </details>
    </div>

    <div class="card">
      <div id="map"></div>
    </div>
  </div>
</div>

<script>
const apiBase = "/api"; // Netlify proxy / Render diretto

// --- Leaflet ---
let map = L.map('map', {scrollWheelZoom:true});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:'¬© OpenStreetMap'}).addTo(map);
let marker=null, circle=null;

// --- UI ---
const q   = document.getElementById('q');
const go  = document.getElementById('go');
const clr = document.getElementById('clear');
const day = document.getElementById('day');
const dayLbl = document.getElementById('dayLbl');

const indexPill = document.getElementById('indexPill');
const capsPill  = document.getElementById('capsPill');
const rainPill  = document.getElementById('rainPill');
const adviceEl  = document.getElementById('advice');
const whyEl     = document.getElementById('why');
const techEl    = document.getElementById('tech');
const speciesEl = document.getElementById('species');

function parseLatLon(s){
  if(!s) return null;
  const t = s.replace(/[¬∞\s]/g,'').replace(';',',').split(',');
  if(t.length!==2) return null;
  let la = t[0].replace(',','.'), lo = t[1].replace(',','.');
  const lat = parseFloat(la), lon = parseFloat(lo);
  if(Number.isFinite(lat) && Number.isFinite(lon)) return {lat, lon};
  return null;
}

async function geocode(name){
  const url = "https://nominatim.openstreetmap.org/search";
  const params = new URLSearchParams({format:"json",q:name,limit:"1",addressdetails:"0"});
  const r = await fetch(`${url}?${params.toString()}`, {headers:{"User-Agent":"TrovaPorcini/3.0"}});
  const j = await r.json();
  if(j && j[0]) return {lat: parseFloat(j[0].lat), lon: parseFloat(j[0].lon)};
  throw new Error("Localit√† non trovata");
}

async function fetchScore(lat, lon, d){
  const params = new URLSearchParams({lat,lon,day:d});
  const r = await fetch(`${apiBase}/score?`+params.toString());
  if(!r.ok){
    const t = await r.text();
    throw new Error(`API ${r.status}: ${t.substring(0,120)}`);
  }
  return await r.json();
}

function setMap(lat, lon, idx){
  if(!Number.isFinite(lat) || !Number.isFinite(lon)) return;
  map.setView([lat,lon], 11);
  if(marker) map.removeLayer(marker);
  if(circle) map.removeLayer(circle);
  marker = L.marker([lat,lon]).addTo(map);
  const radius = 1500 + (100-idx)*15; // cerchio pi√π grande se indice basso
  circle = L.circle([lat,lon], {radius, color:"#1f9d5a", fillColor:"#1f9d5a", fillOpacity:0.15}).addTo(map);
}

function showResult(j){
  indexPill.textContent = `Indice: ${j.index}`;
  capsPill.textContent  = `Stima 3h: ${j.caps3h} cappelli`;
  rainPill.textContent  = `Pioggia: ${j.tech.P14mm} mm (ult.14gg)`;
  whyEl.textContent     = j.why || "‚Äî";

  adviceEl.innerHTML = "";
  (j.advice || []).forEach(a => {
    const li = document.createElement('li'); li.textContent = a; adviceEl.appendChild(li);
  });

  speciesEl.textContent = (j.species||[]).join(", ") || "‚Äî";

  techEl.textContent = JSON.stringify(j.tech, null, 2);

  setMap(j.tech.lat, j.tech.lon, j.index);
}

async function run(){
  try{
    const txt = q.value.trim();
    let coords = parseLatLon(txt);
    if(!coords){
      if(!txt) throw new Error("Inserisci localit√† o coordinate");
      coords = await geocode(txt);
    }
    const d = parseInt(day.value,10) || 0;
    const j = await fetchScore(coords.lat, coords.lon, d);
    showResult(j);
  }catch(err){
    alert("Errore: " + err.message);
  }
}

go.addEventListener('click', run);
clr.addEventListener('click', ()=>{ q.value=""; adviceEl.innerHTML=""; whyEl.textContent=""; techEl.textContent=""; indexPill.textContent="Indice: ‚Äì"; capsPill.textContent="Stima 3h: ‚Äì cappelli"; rainPill.textContent="Pioggia: ‚Äì"; });
day.addEventListener('input', ()=>{
  const v = parseInt(day.value,10);
  dayLbl.textContent = v===0 ? "oggi" : `D+${v}`;
  if(q.value.trim()) run();
});

// Avvio: centro Italia di default
setMap(42.5, 12.5, 50);
</script>
</body>
</html>






