<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TrovaPorcini v4.1 ¬∑ by Antonio Pio D'Aloia</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    :root{color-scheme: dark;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:#0e1117;color:#e6edf3}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    h1{display:flex;align-items:center;gap:.6rem;font-size:1.25rem;margin:0 0 .5rem}
    .pill{background:#1f6feb;color:#fff;padding:.15rem .45rem;border-radius:.45rem;font-weight:600}
    .row{display:grid;grid-template-columns:1fr auto auto;gap:10px;margin:14px 0}
    input[type=text]{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #30363d;background:#0b1320;color:#e6edf3}
    button{border:0;background:#238636;color:#fff;padding:10px 14px;border-radius:8px;font-weight:600;cursor:pointer}
    button.secondary{background:#3b3b3b}
    .cols{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:10px}
    @media (max-width: 880px){.cols{grid-template-columns:1fr}}
    .card{background:#0b1320;border:1px solid #30363d;border-radius:10px;padding:14px}
    .label{opacity:.8;font-size:.9rem;margin-bottom:6px}
    .big{font-size:2.2rem;font-weight:800}
    .badge{background:#30363d;padding:.2rem .5rem;border-radius:.5rem;margin-left:.3rem}
    .accordion summary{cursor:pointer;font-weight:700;margin:10px 0}
    .accordion p{margin:.25rem 0}
    /* MAPPA: altezza fissa responsive */
    #map{width:100%;height:420px;border-radius:10px;border:1px solid #30363d;background:#0b1320}
    @media (max-width:880px){#map{height:340px}}
    .muted{opacity:.75}
    .hint{font-size:.9rem;opacity:.8}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üçÑ TrovaPorcini <span class="pill">v4.1</span> <span class="muted">by Antonio Pio D'Aloia</span></h1>

    <!-- Doppia barra -->
    <div class="row">
      <input id="placeInput" type="text" placeholder="Localit√† (es. Bocca della Selva)" />
      <input id="coordInput" type="text" placeholder="Coordinate lat,lon (es. 41,4170010, 14,4707168)" />
      <div style="display:flex;gap:8px">
        <button id="goBtn">Calcola</button>
        <button id="clearBtn" class="secondary">Pulisci</button>
      </div>
    </div>
    <div class="hint">Se compili le coordinate, hanno priorit√†. Accettiamo virgola decimale e formati Google.</div>

    <div class="cols">
      <!-- Pannello sinistra -->
      <div class="card" id="leftPane">
        <div class="label">Indice ‚Äî <span id="dateLabel" class="badge">oggi</span></div>
        <div class="big" id="idx">‚Äî</div>
        <div style="display:flex;gap:10px;margin-top:6px">
          <div class="badge">Stima 3h: <span id="stima">‚Äî</span> cappelli</div>
          <div class="badge">Pioggia: <span id="rainBadge">‚Äî</span></div>
        </div>

        <div style="margin:16px 0 6px" class="label">Previsione (prossimi 10 giorni)</div>
        <input id="daySlider" type="range" min="0" max="9" step="1" value="0" style="width:100%"/>

        <details class="accordion" open>
          <summary>Consigli pratici <span class="muted">(cambiano per il giorno selezionato)</span></summary>
          <div id="tips">‚Äî</div>
        </details>

        <details class="accordion" open>
          <summary>Perch√© questa stima</summary>
          <div id="why">‚Äî</div>
        </details>

        <details class="accordion">
          <summary>Specie di porcini probabili</summary>
          <div id="species">‚Äî</div>
        </details>

        <details class="accordion">
          <summary>Dati tecnici</summary>
          <pre id="tech" style="white-space:pre-wrap"></pre>
        </details>
      </div>

      <!-- Mappa destra -->
      <div class="card">
        <div id="map"></div>
        <div class="hint" style="margin-top:6px">Legenda cerchio: colore = indice del giorno selezionato.</div>
      </div>
    </div>
  </div>

<script>
const $ = (s)=>document.querySelector(s);

// -------- Parser coordinate robusto (accetta virgola italiana / spazi / punto) --------
function parseCoords(text){
  if(!text) return null;
  let t = text.trim()
    .replace(/[;|]/g, ',')
    .replace(/\s+/g, ',')
    .replace(/,/g, ',')
    .replace(/Ôºå/g, ','); // virgola asiatica
  // separa
  let parts = t.split(',').filter(x=>x.length>0);
  if(parts.length < 2) return null;
  // unifica virgola decimale
  function toNum(v){
    // se contiene sia punto che virgola, assume che l'ultima sia il separatore decimale
    if(v.includes(',') && !v.includes('.')) v = v.replace(',', '.');
    // togli eventuali caratteri
    v = v.replace(/[^\d\.\-]/g, '');
    return Number(v);
  }
  let lat = toNum(parts[0]);
  let lon = toNum(parts[1]);
  if(Number.isFinite(lat) && Number.isFinite(lon) && Math.abs(lat)<=90 && Math.abs(lon)<=180){
    return {lat, lon};
  }
  return null;
}

// --------- Leaflet map ----------
let map, marker, circle;
function ensureMap(){
  if(map) return;
  map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:18, attribution:'&copy; OpenStreetMap'
  }).addTo(map);
  // prevenire bug di dimensioni
  setTimeout(()=>map.invalidateSize(), 100);
}
function updateMap(lat, lon, score){
  ensureMap();
  map.setView([lat,lon], 12);
  if(marker){ map.removeLayer(marker); }
  if(circle){ map.removeLayer(circle); }
  marker = L.marker([lat,lon]).addTo(map);
  // colore dal punteggio
  const col = score>=70?'#1db954': score>=40?'#f39c12':'#e74c3c';
  circle = L.circle([lat,lon], {radius:1200,color:col,fillColor:col,fillOpacity:0.25}).addTo(map);
}

// ------------- API helpers -------------
async function apiGeocode(q){
  const r = await fetch(`/api/geocode?q=${encodeURIComponent(q)}`);
  if(!r.ok) throw new Error('GEOCODE');
  return r.json();
}
async function apiScore(lat, lon){
  const r = await fetch(`/api/score?lat=${lat}&lon=${lon}`);
  if(!r.ok) throw new Error('SCORE');
  return r.json();
}

// ---------- UI render ----------
let g = { scores_next10:[], dates:[], rain_mm:[], why_all:[], advice_all:[], species:[] , lat:null, lon:null };

function fmtDateOffset(dplus){
  const d = new Date();
  d.setDate(d.getDate()+dplus);
  return d.toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit'});
}
function paint(day){
  const s = g.scores_next10[day] ?? null;
  $('#dateLabel').textContent = day===0 ? 'oggi' : `D+${day} ‚Äî ${fmtDateOffset(day)}`;
  $('#idx').textContent = (s==null? '‚Äî' : s);
  $('#stima').textContent = (g.stima_next10?.[day] ?? '‚Äî');
  $('#rainBadge').textContent = (g.rain_next10?.[day] ?? (g.rain_mm?.slice(-10)?.[day] ?? '‚Äî')) + ' mm';
  $('#tips').textContent = (g.advice_all?.[day] ?? g.advice ?? '‚Äî');
  $('#why').textContent = (g.why_all?.[day] ?? g.why ?? '‚Äî');
  $('#species').textContent = (g.species?.join(', ') || g.forest || '‚Äî');
  // dati tecnici grezzi
  $('#tech').textContent = JSON.stringify({
    lat:g.lat, lon:g.lon,
    P14_mm:g.P14_mm, Tmean7_c:g.Tmean7_c, ET0_7:g.ET0_7,
    last_rain_days:g.last_rain_days, next_rain_10d_mm:g.sum_next10mm
  }, null, 2);

  if(g.lat!=null) updateMap(g.lat, g.lon, (s??0));
}

// ---------- flusso Calcola ----------
async function doCalc(){
  try{
    $('#idx').textContent = '‚Ä¶';
    $('#tips').textContent = '‚Ä¶';
    $('#why').textContent = '‚Ä¶';
    const coordTxt = $('#coordInput').value.trim();
    const placeTxt = $('#placeInput').value.trim();

    let lat, lon;

    // priorit√† coordinate
    const parsed = parseCoords(coordTxt);
    if(parsed){ lat = parsed.lat; lon = parsed.lon; }
    else{
      if(!placeTxt){ alert('Errore: inserisci localit√† o coordinate'); return; }
      // geocode
      const gj = await apiGeocode(placeTxt);
      lat = Number(gj.lat); lon = Number(gj.lon);
      if(!Number.isFinite(lat) || !Number.isFinite(lon)) throw new Error('GEOCODE_EMPTY');
    }

    const sj = await apiScore(lat, lon);

    // robust mapping dei campi (vecchie/nuove versioni)
    g = {
      lat, lon,
      scores_next10: sj.scores_next10 ?? [],
      stima_next10:  sj.caps_next10 ?? sj.caps ?? [],
      rain_next10:   sj.rain_next10 ?? null,
      dates:         sj.dates ?? [],
      rain_mm:       sj.rain_mm ?? [],
      P14_mm:        sj.P14_mm ?? sj.P14_mm_14 ?? null,
      Tmean7_c:      sj.Tmean7_c ?? null,
      ET0_7:         sj.ET0_7 ?? null,
      last_rain_days:sj.last_rain_days ?? sj.last_rain ?? null,
      sum_next10mm:  sj.sum_next10mm ?? sj.rain_sum_10d ?? null,
      advice_all:    sj.advice_all ?? [],
      why_all:       sj.why_all ?? [],
      advice:        sj.advice ?? '',
      why:           sj.why ?? '',
      species:       sj.species ?? [],
      forest:        sj.forest ?? sj.forest_label ?? ''
    };

    paint(Number($('#daySlider').value||0));
  }catch(e){
    if(String(e.message).startsWith('GEOCODE')) alert('Errore: Localit√† non trovata');
    else if(String(e.message).startsWith('SCORE')) alert('Errore: API 500');
    else alert('Errore: ' + e.message);
  }
}

// slider ‚Üí repaint
$('#daySlider').addEventListener('input', ()=> paint(Number($('#daySlider').value||0)));

// bottoni
$('#goBtn').addEventListener('click', doCalc);
$('#clearBtn').addEventListener('click', ()=>{
  $('#placeInput').value=''; $('#coordInput').value='';
  $('#idx').textContent='‚Äî'; $('#stima').textContent='‚Äî'; $('#rainBadge').textContent='‚Äî';
  $('#tips').textContent='‚Äî'; $('#why').textContent='‚Äî'; $('#species').textContent='‚Äî'; $('#tech').textContent='';
});

// init mappa vuota
ensureMap();
map.setView([41.9,12.5], 5); // Italia
</script>
</body>
</html>





