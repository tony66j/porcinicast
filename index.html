<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TrovaPorcini v0.96 ‚Äì by Antonio Pio D‚ÄôAloia</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root { --bg:#0f1720; --panel:#17212b; --txt:#e7f0f6; --muted:#9ab0bf; --acc:#2ecc71; --warn:#f1c40f; --bad:#e74c3c;}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
  .wrap{max-width:1180px;margin:0 auto;padding:16px;}
  .hdr{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .logo{font-size:28px}
  .badge{background:#203040;color:#9fd; border-radius:6px;padding:3px 8px;margin-left:8px}
  .by{margin-left:auto;color:var(--muted);font-size:14px}
  .card{background:var(--panel);border-radius:10px;padding:14px;margin:10px 0}
  .row{display:grid;grid-template-columns:1fr 1fr; gap:12px}
  .lab{font-size:14px;color:var(--muted);margin-bottom:6px}
  input{width:100%;padding:10px;border-radius:8px;border:1px solid #2a3b4a;background:#0c141b;color:var(--txt)}
  .btn{background:var(--acc);color:#003014;border:0;border-radius:8px;padding:10px 14px;cursor:pointer;font-weight:600}
  .btn.muted{background:#25374a;color:#cfe}
  .pill{display:inline-block;background:#0c141b;border:1px solid #2b3e4c;border-radius:999px;padding:6px 10px;margin:4px 4px 0 0;color:#bfe}
  .grid2{display:grid;grid-template-columns:1.1fr 1fr; gap:14px}
  .score{font-size:44px;font-weight:700;margin:6px 0}
  .dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:8px}
  .good{background:var(--acc)} .mid{background:var(--warn)} .bad{background:var(--bad)}
  #map{height:520px;border-radius:10px;overflow:hidden}
  .sec-h{font-weight:700;margin:12px 0 6px}
  .small{color:var(--muted);font-size:13px}
  .split{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .slider{width:100%}
</style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <div class="logo">üçÑ TrovaPorcini <span class="badge">v0.96</span></div>
    <div class="by">by <strong>Antonio Pio D‚ÄôAloia</strong></div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <div class="lab">Localit√†</div>
        <input id="place" placeholder="es. Bocca della Selva"/>
      </div>
      <div>
        <div class="lab">Coordinate (lat,lon ‚Äì accetta formato Google, virgole decimali)</div>
        <input id="coords" placeholder="es. 41,4170010, 14,4707168"/>
      </div>
    </div>
    <div class="split" style="margin-top:10px">
      <button class="btn" id="go">Calcola idoneit√†</button>
      <button class="btn muted" id="clr">Pulisci</button>
      <span class="small">La barra coordinate ha priorit√† se compilata.</span>
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <div class="split">
        <div id="dot" class="dot mid"></div>
        <div class="small">Indice oggi</div>
      </div>
      <div class="score" id="score">‚Äì</div>

      <div class="split small" style="margin:6px 0 10px">
        <div id="verdict">‚Äì</div>
        <span id="kg" class="pill" title="stima prudente kg in 3h">kg 3h: ‚Äì</span>
      </div>

      <div class="sec-h">Previsione (prossimi 10 giorni)</div>
      <input type="range" min="0" max="9" value="0" class="slider" id="day"/>
      <div class="small">Giorno selezionato: <span id="daylab">oggi</span> ¬∑ Finestra migliore (3 gg): <span id="bestwin">‚Äì</span></div>

      <details open style="margin-top:10px">
        <summary class="sec-h">Consigli pratici (dipendono dalle condizioni)</summary>
        <div id="tips" class="small">‚Äì</div>
      </details>

      <details style="margin-top:10px">
        <summary class="sec-h">Specie di porcini probabili</summary>
        <div id="species" class="small">‚Äì</div>
      </details>

      <details style="margin-top:10px">
        <summary class="sec-h">Perch√© questa stima</summary>
        <div id="why" class="small">‚Äì</div>
      </details>

      <details style="margin-top:10px">
        <summary class="sec-h">Dati tecnici</summary>
        <div id="tech" class="small">‚Äì</div>
      </details>
    </div>

    <div class="card">
      <div id="map"></div>
      <div class="small" style="margin-top:6px">Mappa solo Italia; il cerchio cambia colore in base al giorno selezionato. <span id="metanote"></span></div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const api = (p)=> fetch(p).then(r=>{ if(!r.ok) throw new Error("API "+r.status); return r.json(); });

function parseCoords(txt){
  if(!txt) return null;
  // accetta "41,4170010, 14,4707168" (Google) oppure "41.4170010,14.4707168"
  let s = txt.trim()
    .replace(/;/g,",")
    .replace(/\s+/g," ")
    .replace(/^lat\s*[:=]\s*/i,"").replace(/^lon\s*[:=]\s*/i,""); // pulizia
  // se ci sono due virgole e nessun punto, sostituisci la prima virgola decimale con punto
  // e lascia la virgola come separatore
  // pi√π robusto: prendi i primi due numeri (accetta , o . come decimali)
  let nums = s.match(/-?\d+[.,]?\d*/g);
  if(!nums || nums.length<2) return null;
  let lat = nums[0].replace(",",".");
  let lon = nums[1].replace(",",".");
  let la = parseFloat(lat), lo = parseFloat(lon);
  if(Number.isNaN(la)||Number.isNaN(lo)) return null;
  return {lat:la, lon:lo};
}

async function geocode(q){
  const j = await api(`/api/geocode?q=${encodeURIComponent(q)}`);
  if(!j || j.lat===undefined) throw new Error("Localit√† non trovata");
  return {lat:j.lat, lon:j.lon, display:j.display};
}

let map, marker, ring;
function initMap(){
  map = L.map('map',{scrollWheelZoom:true}).setView([42.0, 13.5], 6);
  // limiti Italia
  const b = L.latLngBounds([35.2,6.5],[47.3,18.8]);
  map.setMaxBounds(b); map.on('drag', ()=> map.panInsideBounds(b,{animate:false}));
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:16}).addTo(map);
}

function setPoint(lat,lon, color="#f1c40f"){
  if(!marker){ marker=L.marker([lat,lon]).addTo(map); }
  else marker.setLatLng([lat,lon]);
  if(!ring){ ring=L.circle([lat,lon],{radius:1200,color:color,fillColor:color,fillOpacity:0.15}).addTo(map); }
  else { ring.setLatLng([lat,lon]); ring.setStyle({color:color,fillColor:color}); }
  map.setView([lat,lon], 12, {animate:true});
}

function verdict(score){
  if(score>=70) return {txt:"Consigliato oggi", cls:"good"};
  if(score>=45) return {txt:"Possibile", cls:"mid"};
  return {txt:"Sconsigliato oggi", cls:"bad"};
}

function dayLabel(v){ return v==0 ? "oggi" : `D+${v}` }

async function run(){
  try{
    document.getElementById('go').disabled = true;
    let lat, lon, disp=null;
    const coords = parseCoords(document.getElementById('coords').value);
    if(coords){ lat=coords.lat; lon=coords.lon; }
    else{
      const q = document.getElementById('place').value.trim();
      if(!q) { alert("Inserisci localit√† o coordinate"); return; }
      const g = await geocode(q); lat=g.lat; lon=g.lon; disp=g.display;
    }
    let day = parseInt(document.getElementById('day').value,10) || 0;
    const j = await api(`/api/score?lat=${lat}&lon=${lon}&day=${day}`);

    const sc = j.score_selected ?? j.score_today ?? 0;
    const v = verdict(sc);
    document.getElementById('dot').className = "dot "+v.cls;
    document.getElementById('score').textContent = sc;
    document.getElementById('verdict').textContent = v.txt;
    document.getElementById('kg').textContent = `kg 3h: ${j.kg_estimate_3h} (${j.kg_note})`;

    const bw = j.best_window ? `D+${j.best_window.start} ‚Üí D+${j.best_window.end} (media ${j.best_window.mean})` : "‚Äì";
    document.getElementById('bestwin').textContent = bw;

    const dlab = dayLabel(day);
    document.getElementById('daylab').textContent = dlab;

    const tip = (j.tips||"‚Äì");
    document.getElementById('tips').textContent = tip + (j.window_note? " ¬∑ "+j.window_note : "");

    document.getElementById('species').textContent = (j.species_probable||[]).join(", ") || "‚Äì";
    document.getElementById('why').textContent = j.why || "‚Äì";

    const tech = `P14: ${j.tech?.P14_mm??"‚Äì"} mm ¬∑ Tmean7: ${j.tech?.Tmean7_C??"‚Äì"} ¬∞C ¬∑ pendenza: ${j.slope_deg??"‚Äì"}¬∞ ¬∑ esposizione: ${j.aspect_octant??"‚Äì"} ¬∑ quota: ${Math.round(j.elevation_m??0)} m ¬∑ ultima pioggia: ${j.last_rain_days??"‚Äì"} gg ¬∑ prossima pioggia (5 gg): ${j.next_rain_mm_5d??"‚Äì"} mm`;
    document.getElementById('tech').textContent = tech;

    const col = sc>=70 ? "#2ecc71" : (sc>=45 ? "#f1c40f" : "#e74c3c");
    setPoint(j.elevation_m? (disp? lat:lat) : lat, lon, col);
    document.getElementById('metanote').textContent = disp ? `Localit√†: ${disp}` : "";
  }catch(e){
    alert("Errore: "+e.message);
    console.error(e);
  }finally{
    document.getElementById('go').disabled = false;
  }
}

document.getElementById('go').addEventListener('click', run);
document.getElementById('clr').addEventListener('click', ()=>{
  document.getElementById('place').value="";
  document.getElementById('coords').value="";
});
document.getElementById('day').addEventListener('input', run);

initMap();
</script>
</body>
</html>


