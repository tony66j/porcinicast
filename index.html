<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PorciniCast</title>
  <style>
    :root{--bg:#0c1222;--panel:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--accent:#10b981;--accent2:#22d3ee;--danger:#ef4444;}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0f172a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{display:flex;align-items:center;gap:.7rem;padding:14px 16px;border-bottom:1px solid #1f2937;background:rgba(15,23,42,.6);backdrop-filter:blur(8px);position:sticky;top:0;z-index:10}
    .logo{display:flex;align-items:center;gap:.5rem}
    .logo svg{width:26px;height:26px}
    .brand{font-weight:800;letter-spacing:.3px}
    main{max-width:980px;margin:22px auto;padding:0 16px}
    .card{background:linear-gradient(180deg,#0b1220,#0f172a);border:1px solid #1f2937;border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-bottom:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    input,button{border-radius:10px;border:1px solid #334155;background:#0b1324;color:var(--text);padding:12px 14px;font-size:15px}
    button{background:linear-gradient(90deg,var(--accent2),var(--accent));border:none;cursor:pointer;color:#062f2a;font-weight:700}
    button:disabled{opacity:.5;cursor:default}
    .muted{color:var(--muted);font-size:13px}
    .score{font-size:38px;font-weight:800}
    .pill{display:inline-block;padding:2px 10px;border-radius:999px;font-size:12px;border:1px solid #1f2937;background:#0b1324}
    .ok{background:rgba(16,185,129,.15);color:#22c55e;border-color:#064e3b}
    .warn{background:rgba(245,158,11,.12);color:#f59e0b;border-color:#7c2d12}
    .bad{background:rgba(239,68,68,.12);color:#ef4444;border-color:#7f1d1d}
    .calendar{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;margin-top:8px}
    .day{height:12px;border-radius:4px;background:#1f2937}
    .day[data-v="low"]{background:#ef4444}
    .day[data-v="mid"]{background:#f59e0b}
    .day[data-v="hi"]{background:#10b981}
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px}
    details{background:#0b1324;border:1px solid #1f2937;border-radius:10px;padding:10px}
    summary{cursor:pointer;color:#a5b4fc}
    footer{margin:18px auto 36px;max-width:980px;padding:0 16px;color:#9ca3af}
    .attribution{font-size:12px}
    @media(max-width:860px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs><linearGradient id="g" x1="0" x2="1"><stop stop-color="#22d3ee"/><stop offset="1" stop-color="#10b981"/></linearGradient></defs>
        <path d="M12 26c0-9 10-16 20-16s20 7 20 16c0 3-6 6-16 7v7h6a2 2 0 110 4H22a2 2 0 110-4h6v-7c-10-1-16-4-16-7z" fill="url(#g)"/>
        <circle cx="32" cy="48" r="5" fill="#22d3ee"/>
      </svg>
      <div class="brand">PorciniCast</div>
    </div>
  </header>

  <main>
    <div class="card">
      <div style="display:flex;gap:8px">
        <input id="q" placeholder="Cerca una località (es. Bocca della Selva)">
        <button id="btn">Calcola idoneità</button>
      </div>
      <div class="muted" style="margin-top:6px">Consiglio automatico e finestra migliore D+10 basati su pioggia recente (emivita ~8 gg), bilancio idrico e finestra termica.</div>
    </div>

    <div class="grid">
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <div class="muted">Indice oggi</div>
            <div class="score" id="score">—</div>
          </div>
          <div id="advice" class="pill">—</div>
        </div>
        <div id="calendar" class="calendar" title="Prossimi 10 giorni"></div>
        <div id="best" class="muted" style="margin-top:8px">Finestra migliore: —</div>
      </div>
      <div class="card">
        <div class="kv" id="kv"></div>
      </div>
    </div>

    <div class="card">
      <details>
        <summary>Metodi & note (clicca per aprire)</summary>
        <div style="font-size:14px;line-height:1.6;margin-top:6px">
          Modello v0.5: <b>pioggia antecedente a decadimento</b> (emivita ~8 giorni) → indice API*;
          corretta con <b>ET0 FAO (7g)</b> per un proxy di umidità del suolo; <b>finestra termica</b> 10–18 °C (penalità Tmin&lt;6 °C / Tmax&gt;24 °C);
          modulatori deboli per <b>quota</b>, <b>esposizione</b> (N/NE) e <b>pendenza</b>. Bosco da OSM è informativo e non incide pesantemente sul punteggio.
          Dati: <b>Open-Meteo</b>, <b>OpenWeather</b> (umidità/nowcast), <b>Open-Elevation</b>, <b>Overpass/OSM</b>.
          Questo sito fornisce <i>probabilità</i>, non garanzie. Creato da <b>Antonio Pio d'Aloia</b>.
        </div>
      </details>
    </div>
  </main>

  <footer>
    <div class="attribution">
      PorciniCast © <span id="y"></span> · Dati di terze parti con licenze proprie.
    </div>
  </footer>

<script>
const API_BASE = window.location.origin + "/api"; // Netlify rewrite → backend Render
const $ = (s)=>document.querySelector(s);

function cls(score){ if(score>=70) return "ok"; if(score>=60) return "warn"; return "bad"; }
function dayClass(v){ if(v>=70) return "hi"; if(v>=55) return "mid"; return "low"; }

async function geocode(q){
  const r = await fetch(`${API_BASE}/geocode?q=${encodeURIComponent(q)}`);
  if(!r.ok) throw new Error("geocode"); return r.json();
}
async function score(lat,lon,half=8){
  const r = await fetch(`${API_BASE}/score?lat=${lat}&lon=${lon}&half=${half}`);
  if(!r.ok) throw new Error("score"); return r.json();
}
function fillKV(container, rows){
  container.innerHTML="";
  rows.forEach(([k,v])=>{
    const div=document.createElement("div");
    div.innerHTML=`<div class="muted">${k}</div><div>${v??"—"}</div>`;
    container.appendChild(div);
  });
}
async function run(){
  const q = $("#q").value.trim(); if(!q){$("#q").focus();return;}
  $("#btn").disabled=true;
  try{
    const g = await geocode(q);
    const s = await score(g.lat,g.lon,8);
    $("#score").textContent = s.score_today;
    const pill = $("#advice"); pill.textContent = s.advice || "—"; pill.className = `pill ${cls(s.score_today)}`;
    // calendar
    const cal=$("#calendar"); cal.innerHTML="";
    (s.scores_next10||[]).forEach(v=>{const d=document.createElement("div");d.className="day";d.dataset.v=dayClass(v);d.title=v;cal.appendChild(d);});
    $("#best").textContent = s.best_window? `Finestra migliore (3 giorni): D+${s.best_window.start} → D+${s.best_window.end} (media ${s.best_window.mean})` : "—";
    // kv
    fillKV($("#kv"), [
      ["Località", g.display],
      ["Quota", `${Math.round(s.elevation_m)} m`],
      ["Pendenza", `${s.slope_deg.toFixed(1)}°`],
      ["Esposizione", `${s.aspect_octant} (${s.aspect_deg.toFixed(0)}°)`],
      ["Bosco (indic.)", s.forest],
      ["API* (30g, half=8)", `${s.API_star_mm} mm`],
      ["ET0 7g", `${s.ET0_7d_mm} mm`],
      ["Tmed 7g", `${s.Tmean7_c.toFixed(1)} °C`],
      ["Umidità (ora, OWM)", s.humidity_now!=null? `${s.humidity_now}%` : "—"],
      ["Pioggia prossime 24h (OWM)", s.rain24h_forecast_mm!=null? `${s.rain24h_forecast_mm} mm` : "—"],
      ["Incertezza", s.uncertainty]
    ]);
  }catch(e){ alert("Errore durante il calcolo. Riprova tra poco."); console.error(e); }
  finally{ $("#btn").disabled=false; }
}
$("#btn").addEventListener("click", run);
document.addEventListener("keydown", e=>{ if(e.key==="Enter") run(); });
document.querySelector("#y").textContent = new Date().getFullYear();
</script>
</body>
</html>
