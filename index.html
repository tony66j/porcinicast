<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TrovaPorcini vPRO+ 5.1</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root{
    --bg:#0f1720; --panel:#17212b; --muted:#8aa0b3; --accent:#51d2a8; --danger:#ff6b6b; --text:#eaf2f9;
  }
  *{box-sizing:border-box}
  body{margin:0;font:15px/1.45 system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  header{display:flex;align-items:center;gap:.6rem;padding:14px 18px;border-bottom:1px solid #1e2a36}
  header .title{font-weight:700;font-size:20px}
  header .badge{background:#203040;padding:2px 8px;border-radius:8px;font-size:12px}
  header .by{margin-left:auto;color:var(--muted);font-size:14px}

  .container{max-width:1200px;margin:14px auto;padding:0 14px}
  .grid{display:grid;grid-template-columns: 1.15fr 1fr; gap:16px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }

  .panel{background:var(--panel);border:1px solid #233243;border-radius:12px}
  .panel.pad{padding:14px}
  .label{font-weight:600;color:var(--muted);font-size:13px;margin-bottom:6px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  input[type=text]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #253647;background:#0d141c;color:var(--text)}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #29485a;background:#103647;color:#eaf2f9;cursor:pointer}
  .btn.primary{background:#115e49;border-color:#2a7b67}
  .btn:hover{filter:brightness(1.05)}
  .stack{display:grid;gap:10px}
  .metrics{display:flex;gap:14px;align-items:stretch;flex-wrap:wrap;margin-top:12px}
  .metric{flex:0 0 auto;min-width:120px;background:#0e1922;border:1px solid #223244;border-radius:12px;padding:10px;text-align:center}
  .metric h2{margin:0;font-size:42px;line-height:1.0}
  .metric small{color:var(--muted)}
  .slider{margin:8px 0 2px}
  input[type=range]{width:100%}

  details{background:#0f1b24;border:1px solid #213243;border-radius:10px; padding:10px;margin:10px 0}
  details summary{cursor:pointer;font-weight:700}
  .muted{color:var(--muted)}

  /* destra */
  #map{height:420px;border-radius:12px;border:1px solid #223244}
  .weathbar{margin-top:12px;background:#0e1922;border:1px solid #223244;border-radius:12px;padding:10px;overflow:auto}
  .wrow{display:flex;gap:10px;align-items:center;white-space:nowrap}
  .witem{min-width:70px;text-align:center}
  .witem .d{font-size:12px;color:var(--muted)}
  .witem .mm{font-weight:700}
</style>
</head>
<body>
<header>
  <div class="title">üçÑ TrovaPorcini</div>
  <div class="badge">vPRO+ 5.1</div>
  <div class="by">by <b>Antonio Pio D‚ÄôAloia</b></div>
</header>

<main class="container grid">

  <!-- COLONNA SINISTRA -->
  <section class="panel pad">
    <div class="stack">
      <div class="label">Ricerca</div>
      <div class="row">
        <input id="q" type="text" placeholder="Localit√† (es. Bocca della Selva)" style="flex:1 1 360px">
        <input id="coords" type="text" placeholder="Coordinate lat,lon (es. 41,4170010, 14,4707168)" style="flex:1 1 360px">
        <button id="go" class="btn primary">Calcola</button>
        <button id="clear" class="btn">Pulisci</button>
      </div>
    </div>

    <div id="place" class="muted" style="margin-top:8px;"></div>

    <div class="metrics">
      <div class="metric" style="min-width:140px">
        <small>Indice</small>
        <h2 id="mIndex">‚Äî</h2>
      </div>
      <div class="metric">
        <small>Stima 3h</small>
        <div id="mCaps" style="font-size:22px;margin-top:6px;">‚Äî cappelli</div>
      </div>
      <div class="metric">
        <small>Pioggia prossima</small>
        <div id="mRain" style="font-size:16px;margin-top:6px;">‚Äî</div>
      </div>
    </div>

    <div class="panel pad" style="margin-top:12px">
      <div class="label">Previsione (prossimi 10 giorni) ‚Äî <span id="daylabel" class="muted">oggi</span></div>
      <div class="slider"><input id="day" type="range" min="0" max="9" step="1" value="0"></div>
    </div>

    <details open>
      <summary>Consigli pratici <span class="muted">(cambiano col giorno)</span></summary>
      <div id="tips" style="margin-top:6px;">‚Äî</div>
    </details>

    <details open>
      <summary>Perch√© questa stima</summary>
      <div id="why" style="margin-top:6px;">‚Äî</div>
    </details>

    <details>
      <summary>Specie di porcini probabili</summary>
      <div id="species" style="margin-top:6px;">Pinus/Abies/Picea (stima orientativa)</div>
    </details>

    <details>
      <summary>Dati tecnici</summary>
      <pre id="tech" style="font-size:12px;white-space:pre-wrap;"></pre>
    </details>
  </section>

  <!-- COLONNA DESTRA -->
  <section class="panel pad">
    <div id="map"></div>
    <div class="weathbar">
      <div class="label">Barra meteo (prossimi 10 giorni)</div>
      <div id="wstrip" class="wrow"></div>
    </div>
  </section>

</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let Lmap, Lmarker, Lcircle;
let DATA = null;   // risposta backend
let SEL = 0;       // giorno selezionato

function parseCoordsLocal(text){
  if(!text) return null;
  // prendi i primi 2 numeri (accetta virgola italiana)
  const re=/[-+]?\d{1,3}(?:[.,]\d+)?/g;
  const nums = text.match(re);
  if(!nums || nums.length<2) return null;
  const lat = parseFloat(nums[0].replace(",", "."));
  const lon = parseFloat(nums[1].replace(",", "."));
  if(isNaN(lat)||isNaN(lon)) return null;
  if(lat<-90||lat>90||lon<-180||lon>180) return null;
  return {lat,lon};
}

function initMap(){
  Lmap = L.map('map',{zoomControl:true}).setView([42.0,12.5], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:18, attribution:'&copy; OpenStreetMap'
  }).addTo(Lmap);
}

function setMap(lat, lon, color='#ffb648'){
  if(!Lmap) initMap();
  Lmap.setView([lat,lon], 12);
  if(Lmarker) Lmap.removeLayer(Lmarker);
  if(Lcircle) Lmap.removeLayer(Lcircle);
  Lmarker = L.marker([lat,lon]).addTo(Lmap);
  Lcircle = L.circle([lat,lon], {radius:1500,color:color,fillOpacity:0.1}).addTo(Lmap);
}

function dayName(iso){
  const d=new Date(iso+"T12:00:00");
  return d.toLocaleDateString('it-IT',{weekday:'short', day:'2-digit', month:'2-digit'});
}

function paintWeatherStrip(dates, rain){
  const host = document.getElementById('wstrip');
  host.innerHTML = "";
  dates.forEach((dt,i)=>{
    const el = document.createElement('div');
    el.className = "witem";
    el.innerHTML = `<div class="d">${dayName(dt)}</div>
                    <div class="mm">${(rain[i]||0).toFixed(1)} mm</div>`;
    host.appendChild(el);
  });
}

function adviceForDay(d){
  // discorsivo e pi√π ricco; usa slope/aspect/umidit√†/piogge future
  const asp = DATA.aspect_octant;
  const elev = Math.round(DATA.elevation_m);
  const next = DATA.next_rain;
  let s = `Preferisci zone ombreggiate (N‚ÄìNE‚ÄìNW) e suoli che trattengono umidit√†; ` +
          `evita versanti troppo secchi; esposizione locale ${asp}. ` +
          `Quota ${elev} m`;
  if(next && next.days_ahead!==null){
    s += `; attesa pioggia di ~${next.mm.toFixed(1)} mm tra D+${next.days_ahead} (${next.date}) ‚Äî finestra 7‚Äì10 gg dopo.`;
  }
  // piccola modulazione in base allo score del giorno
  const sc = DATA.scores_next10[SEL] || 0;
  if(sc>=70) s += " Giornata promettente: muoviti presto e cerca lettiere fresche.";
  else if(sc>=50) s += " Possibile raccolta: insisti su faggete o castagneti con micro-umidit√†.";
  else s += " Nascite limitate: esplora quote/versanti alternativi.";
  return s;
}

function whyForDay(){
  // spiega cosa pesa di pi√π usando tech + day arrays
  const sc = DATA.scores_next10[SEL] || 0;
  const r  = DATA.rain_next10_mm[SEL] || 0;
  const t  = DATA.tmean_next10_c[SEL] || 0;
  const tech = DATA.tech || {};
  const asp = DATA.aspect_octant;
  return `Indice ${sc} per D+${SEL}: ` +
         `P14_eff ~${(tech.P14_last14_mm||0).toFixed(1)} mm (decadimento 7 gg), ` +
         `T7 ~${(tech.Tmean7_c||t).toFixed(1)} ¬∞C, ` +
         `ET0_7d ~${(tech.ET0_7d_mm||3).toFixed(1)} mm; ` +
         `aspetto locale ${asp}; ` +
         `pioggia giorno selezionato ~${r.toFixed(1)} mm.`;
}

function setDay(n){
  SEL = n;
  const idx = DATA.scores_next10[n] || 0;
  document.getElementById('mIndex').textContent = idx;
  document.getElementById('mCaps').textContent  = (idx? `${DATA.caps_3h} (oggi)` : "‚Äî cappelli");
  document.getElementById('daylabel').textContent = (n===0? "oggi" : `D+${n} ‚Äî ${dayName(DATA.dates[n])}`);
  document.getElementById('tips').textContent = adviceForDay();
  document.getElementById('why').textContent  = whyForDay();
  // colore cerchio in base allo score
  let color = '#ffb648';
  if     (idx>=70) color = '#51d2a8';
  else if(idx<45)  color = '#ff6b6b';
  if(Lcircle) Lcircle.setStyle({color:color});
}

async function run(){
  const q = document.getElementById('q').value.trim();
  const txt = document.getElementById('coords').value.trim();
  const coords = parseCoordsLocal(txt);
  const params = new URLSearchParams();
  if(coords){ params.set("coords", `${coords.lat},${coords.lon}`); }
  else if(q){ params.set("q", q); }
  else { alert("Inserisci localit√† o coordinate"); return; }

  try{
    const r = await fetch(`/api/score?${params.toString()}`);
    if(!r.ok){
      const t = await r.text();
      throw new Error(`API ${r.status}: ${t || r.statusText}`);
    }
    DATA = await r.json();
  }catch(e){
    alert(e.message.replace(/\"/g,""));
    return;
  }

  // UI fill
  const p = document.getElementById('place');
  p.textContent = DATA.display ? DATA.display : `(${DATA.coords.lat.toFixed(5)}, ${DATA.coords.lon.toFixed(5)}) ‚Äî quota ${Math.round(DATA.elevation_m)} m ‚Äî esposizione ${DATA.aspect_octant}`;
  setMap(DATA.coords.lat, DATA.coords.lon);
  document.getElementById('mIndex').textContent = DATA.score_today ?? "‚Äî";
  document.getElementById('mCaps').textContent  = DATA.caps_3h ? `${DATA.caps_3h} (oggi)` : "‚Äî";
  const nr = DATA.next_rain;
  document.getElementById('mRain').textContent  = (nr && nr.date) ? `${nr.mm.toFixed(1)} mm (D+${nr.days_ahead} ‚Äì ${nr.date})` : "‚Äî";
  paintWeatherStrip(DATA.dates, DATA.rain_next10_mm);
  document.getElementById('tech').textContent = JSON.stringify(DATA.tech, null, 2);

  // reset slider e pannelli
  document.getElementById('day').value = 0;
  setDay(0);
}

document.getElementById('go').addEventListener('click', run);
document.getElementById('clear').addEventListener('click', ()=>{
  document.getElementById('q').value="";
  document.getElementById('coords').value="";
});

document.getElementById('day').addEventListener('input', (e)=> setDay(parseInt(e.target.value,10)));

window.addEventListener('load', initMap);
</script>
</body>
</html>
