<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Trova Porcini — by Antonio Pio D’Aloia</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{--bg:#0b1220;--panel:#111b2b;--text:#e9f1fa;--muted:#9fb0c2;--accent:#1ee59a;--warn:#ffd166;--danger:#ef476f;--border:#233144;}
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0a1020,#0f1930);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    header{padding:16px 20px;border-bottom:1px solid var(--border);backdrop-filter:blur(6px)}
    .wrap{max-width:1280px;margin:0 auto;padding:20px;display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    @media(max-width:960px){.wrap{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,#0e1728,#0f192c);padding:16px;border-radius:14px;border:1px solid var(--border);box-shadow:0 12px 28px rgba(0,0,0,.35);margin-bottom:16px}
    input,button{padding:10px;border-radius:10px;border:1px solid #2b3b52;font-size:15px;color:var(--text);background:#0b1526}
    button{cursor:pointer;font-weight:700}
    button.ok{background:linear-gradient(90deg,#22d3ee,#1ee59a);border:none;color:#062f2a}
    button.warn{background:linear-gradient(90deg,#ffd166,#22d3ee);border:none;color:#062f2a}
    .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .metric{background:#0b1526;padding:10px;border-radius:12px;text-align:center;border:1px solid #223249}
    .metric .val{font-size:1.6rem;font-weight:800}
    #map{height:460px;border-radius:12px;overflow:hidden}
    .calendar{display:grid;grid-template-columns:repeat(10,1fr);gap:4px;margin-top:8px}
    .bar{height:100px;position:relative;background:#1f2937;border-radius:8px}
    .bar>i{position:absolute;bottom:0;left:0;width:100%;border-radius:8px}
    .bar>span{position:absolute;top:-18px;left:0;width:100%;text-align:center;font-size:.7rem}
    .table{border:1px solid #223249;border-radius:12px;overflow:hidden}
    .tr{display:grid;grid-template-columns:1fr 80px;padding:8px 10px;border-bottom:1px solid #223249}
    .tr.head{background:#0b1526;font-weight:bold}
    .tr:last-child{border-bottom:none}
    details summary{cursor:pointer;font-weight:700;margin-top:10px;color:#b9c7ff}
    .muted{color:var(--muted);font-size:.9rem}
    /* Spinner */
    #loading{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);z-index:999}
    #loading .ball{width:12px;height:12px;border-radius:50%;margin:6px;background:#22d3ee;display:inline-block;animation:bounce 0.8s infinite alternate}
    #loading .ball:nth-child(2){animation-delay:.15s;background:#1ee59a}
    #loading .ball:nth-child(3){animation-delay:.3s;background:#ffd166}
    @keyframes bounce{to{transform:translateY(-10px)}}
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0;font-size:1.4rem;">Trova Porcini — by Antonio Pio D’Aloia</h1>
    <div class="muted" style="font-size:.85rem;">Modello avanzato: storico 15 gg + forecast 10 gg (OW 60% • OM 40%). Fallback automatici.</div>
  </header>

  <!-- spinner -->
  <div id="loading"><div><span class="ball"></span><span class="ball"></span><span class="ball"></span></div></div>

  <div class="wrap">
    <div class="card">
      <!-- Barre di ricerca -->
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px">
        <input id="place" type="text" placeholder="Località (es. Abbadia San Salvatore)" style="flex:1"/>
        <button id="btnSearch" class="ok">Cerca</button>
        <input id="coords" type="text" placeholder="lat, lon (Google)" style="flex:1;min-width:220px"/>
        <button id="btnCoords" class="warn">Usa coordinate</button>
      </div>
      <div class="muted" style="font-size:0.8rem;margin-bottom:12px;">Suggerimento: incolla le coordinate da Google Maps (es. “44.12345, 11.23456”).</div>

      <!-- KPI -->
      <div class="metrics">
        <div class="metric"><div class="muted">Indice</div><div id="metricIndex" class="val">—</div></div>
        <div class="metric"><div class="muted">Stima raccolto (2 h)</div><div id="metricHarvest" class="val">—</div></div>
        <div class="metric"><div class="muted">Affidabilità</div><div id="metricReliability" class="val">—</div></div>
      </div>

      <!-- Previsione indice -->
      <div style="margin-top:14px;">
        <div class="muted" style="margin-bottom:6px;">Previsione indice (10 giorni)</div>
        <div id="forecast" class="calendar"></div>
      </div>

      <!-- Piogge passate/future -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px">
        <div>
          <div class="muted" style="margin-bottom:6px;">Piogge passate (ultimi 15 giorni)</div>
          <div id="rainPast" class="table">
            <div class="tr head"><div>Data</div><div>mm</div></div>
          </div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px;">Piogge future (prossimi 10 giorni)</div>
          <div id="rainFuture" class="table">
            <div class="tr head"><div>Data</div><div>mm</div></div>
          </div>
        </div>
      </div>

      <!-- Specifiche + Consigli + Perché -->
      <details open>
        <summary>Specifiche tecniche (fattori usati)</summary>
        <ul class="muted" style="margin-left:18px">
          <li>Latitudine/longitudine, quota, pendenza, esposizione</li>
          <li>Piogge P7/P15, API* (emivita ~8 gg), ET0 7 gg</li>
          <li>Temperature medie/min/max (ultimi 7–15 giorni)</li>
          <li>Previsioni multi-modello (OW 60% + OM 40%) con affidabilità</li>
          <li>Finestra migliore di 3 giorni e stima raccolto (2 h)</li>
        </ul>
      </details>
      <details open>
        <summary>Consigli utili del giorno</summary>
        <ul id="tipsList" style="margin-left:18px"></ul>
      </details>
      <details>
        <summary>Perché questa stima?</summary>
        <ul id="whyList" style="margin-left:18px"></ul>
      </details>
    </div>

    <!-- Colonna destra -->
    <div>
      <div class="card"><div id="map"></div></div>
      <!-- NUOVO RIQUADRO: Informazioni -->
      <div class="card">
        <h3 style="margin:0 0 6px 0;">Informazioni</h3>
        <div id="infoText" class="muted">Cerca una località o clicca sulla mappa per visualizzare quota ed analisi dettagliata.</div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const API = "/api";
    const $ = s => document.querySelector(s);

    // Spinner
    const showLoad = (v)=>{ $("#loading").style.display = v ? "grid" : "none"; };

    // Mappa
    let map, marker;
    function initMap(){
      map = L.map('map').setView([42.5,12.5], 6);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);
      marker = L.marker([42.5,12.5]).addTo(map);
      setTimeout(()=>map.invalidateSize(), 250);
      map.on("click", e => handleCoords(e.latlng.lat, e.latlng.lng));
    }

    // Utils
    function parseCoords(str){
      const m = /^\s*([+-]?\d+(?:[.,]\d+)?)\s*[,;\s]\s*([+-]?\d+(?:[.,]\d+)?)\s*$/.exec((str||"").trim());
      if(!m) return null;
      const lat = parseFloat(m[1].replace(",", ".")), lon = parseFloat(m[2].replace(",", "."));
      if(!isFinite(lat)||!isFinite(lon)||lat<-90||lat>90||lon<-180||lon>180) return null;
      return {lat,lon};
    }
    async function apiGet(u){
      const r = await fetch(u);
      if(!r.ok){ const t = await r.text().catch(()=> ""); throw new Error(t || "errore rete"); }
      return r.json();
    }
    async function geocode(q){ return apiGet(`${API}/geocode?q=${encodeURIComponent(q)}`); }
    async function score(lat,lon){ return apiGet(`${API}/score?lat=${lat}&lon=${lon}`); }

    // Render
    function setMetrics(idx, harvest, rel){
      $("#metricIndex").textContent = idx ?? "—";
      $("#metricHarvest").textContent = harvest ?? "—";
      $("#metricReliability").textContent = rel!=null ? Math.round(rel*100)+"%" : "—";
    }
    function setForecast(arr){
      const cont=$("#forecast"); cont.innerHTML="";
      (arr||[]).forEach(v=>{
        const box=document.createElement("div"); box.className="bar";
        const fill=document.createElement("i");
        fill.style.height = Math.max(4, v) + "%";
        fill.style.background = v>=70 ? "#1ee59a" : v>=55 ? "#ffd166" : "#ef476f";
        const lab=document.createElement("span"); lab.textContent=v;
        box.appendChild(fill); box.appendChild(lab); cont.appendChild(box);
      });
    }
    function setTables(past, fut){
      function fill(el, d){
        el.innerHTML = '<div class="tr head"><div>Data</div><div>mm</div></div>';
        Object.keys(d||{}).sort().forEach(k=>{
          const tr=document.createElement("div"); tr.className="tr";
          tr.innerHTML = `<div>${k}</div><div>${Number(d[k]).toFixed(1)}</div>`;
          el.appendChild(tr);
        });
      }
      fill($("#rainPast"), past||{});
      fill($("#rainFuture"), fut||{});
    }
    function setLists(reasons, tips){
      const wl=$("#whyList"); wl.innerHTML=""; (reasons||[]).forEach(t=>{const li=document.createElement("li"); li.textContent=t; wl.appendChild(li);});
      const tl=$("#tipsList"); tl.innerHTML=""; (tips||[]).forEach(t=>{const li=document.createElement("li"); li.textContent=t; tl.appendChild(li);});
    }
    function setInfo(info){
      if(!info){ $("#infoText").textContent = "—"; return; }
      const q = info.elevation_m!=null ? `${info.elevation_m} m s.l.m.` : "—";
      const exp = info.aspect_octant ?? "—";
      const pnd = info.slope_deg!=null ? `${info.slope_deg}°` : "—";
      const text = `<b>Quota:</b> ${q} — <b>Pendenza:</b> ${pnd} — <b>Esposizione:</b> ${exp}.<br><br>${info.narrative || ""}`;
      $("#infoText").innerHTML = text;
    }

    // Handlers
    async function handlePlace(){
      const q=$("#place").value.trim();
      if(!q){ alert("Inserisci una località"); return; }
      showLoad(true);
      try{
        const g = await geocode(q);
        await handleCoords(g.lat, g.lon);
      }catch(e){
        console.error(e); alert("Errore geocoding. Prova con le coordinate (lat, lon).");
      }finally{ showLoad(false); }
    }
    async function handleCoordsStr(){
      const c=parseCoords($("#coords").value.trim());
      if(!c){ alert("Coordinate non valide. Esempio: 41.127, 14.782"); return; }
      showLoad(true);
      try{ await handleCoords(c.lat, c.lon); }
      catch(e){ console.error(e); alert("Errore durante il calcolo. Riprova più tardi."); }
      finally{ showLoad(false); }
    }
    async function handleCoords(lat,lon){
      marker.setLatLng([lat,lon]); map.setView([lat,lon], 11);
      const s = await score(lat,lon);
      setForecast(s.forecast);
      setTables(s.rain_past, s.rain_future);
      setLists(s.explanation?.reasons, s.tips);
      setMetrics(s.index, s.harvest_estimate, s.reliability);
      setInfo(s.info);   // <-- nuovo
    }

    // Bind
    document.getElementById("btnSearch").addEventListener("click", handlePlace);
    document.getElementById("btnCoords").addEventListener("click", handleCoordsStr);
    document.getElementById("place").addEventListener("keydown", (e)=>{ if(e.key==="Enter") handlePlace(); });
    document.getElementById("coords").addEventListener("keydown", (e)=>{ if(e.key==="Enter") handleCoordsStr(); });

    // Start
    initMap();
  </script>
</body>
</html>


